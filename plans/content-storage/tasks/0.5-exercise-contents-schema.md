# Task 0.5: Exercise Contents Schema

## Goal

Create exerciseContents and exerciseChoices tables for storing exercise MDX content with normalized answer choices.

## Context

Each exercise has multiple choice answers. Normalizing choices gives each choice an `_id` for tracking in the existing `exerciseAnswers` table, and allows future extensions (explanations, analytics).

## PRD

```json
{
  "category": "architecture",
  "description": "Create exerciseContents and exerciseChoices tables with proper indexes",
  "steps": [
    "Create packages/backend/convex/exerciseContents directory",
    "Create schema.ts with both tables",
    "Define indexes for hierarchical and locale queries",
    "Verify lint passes"
  ],
  "passes": false
}
```

## Success Criteria

- [ ] Directory created at `packages/backend/convex/exerciseContents/`
- [ ] Schema file created with both tables
- [ ] Indexes match query patterns
- [ ] No lint errors
- [ ] No TypeScript errors

## Commands

```bash
mkdir -p packages/backend/convex/exerciseContents
pnpm lint
pnpm typecheck
```

## Implementation

### File: `packages/backend/convex/exerciseContents/schema.ts`

```typescript
import { defineTable } from "convex/server";
import { v } from "convex/values";
import {
  exercisesCategoryValidator,
  exercisesMaterialValidator,
  exercisesTypeValidator,
  localeValidator,
} from "../lib/contentValidators";

const tables = {
  exerciseContents: defineTable({
    locale: localeValidator,
    slug: v.string(),
    category: exercisesCategoryValidator,
    type: exercisesTypeValidator,
    material: exercisesMaterialValidator,
    exerciseType: v.string(),
    setName: v.string(),
    number: v.number(),
    title: v.string(),
    description: v.optional(v.string()),
    date: v.number(),
    questionBody: v.string(),
    answerBody: v.string(),
    contentHash: v.string(),
    syncedAt: v.number(),
  })
    .index("locale_slug", ["locale", "slug"])
    .index("locale_category_type", ["locale", "category", "type"])
    .index("locale_category_type_material", [
      "locale",
      "category",
      "type",
      "material",
    ])
    .index("locale_category_type_material_exerciseType_setName", [
      "locale",
      "category",
      "type",
      "material",
      "exerciseType",
      "setName",
    ])
    .index("contentHash", ["contentHash"]),

  exerciseChoices: defineTable({
    exerciseId: v.id("exerciseContents"),
    locale: localeValidator,
    optionKey: v.string(),
    label: v.string(),
    isCorrect: v.boolean(),
    order: v.number(),
  }).index("exerciseId_locale", ["exerciseId", "locale"]),
};

export default tables;
```

## Schema Design

### exerciseContents Table

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `locale` | "en" \| "id" | Yes | Content language |
| `slug` | string | Yes | Full URL path |
| `category` | union | Yes | "high-school", "middle-school" |
| `type` | union | Yes | "grade-9", "tka", "snbt" |
| `material` | union | Yes | "mathematics", etc. (8 values) |
| `exerciseType` | string | Yes | "try-out", "practice", etc. |
| `setName` | string | Yes | "set-1", "set-2", etc. |
| `number` | number | Yes | Exercise number (1, 2, 3...) |
| `title` | string | Yes | Exercise title |
| `description` | string | No | Exercise description |
| `date` | number | Yes | Publication date (epoch millis) |
| `questionBody` | string | Yes | Question MDX content |
| `answerBody` | string | Yes | Answer/explanation MDX content |
| `contentHash` | string | Yes | SHA-256 for sync detection |
| `syncedAt` | number | Yes | Last sync timestamp |

### exerciseChoices Table

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `exerciseId` | Id<"exerciseContents"> | Yes | Parent exercise reference |
| `locale` | "en" \| "id" | Yes | Choice language |
| `optionKey` | string | Yes | "A", "B", "C", "D", "E" |
| `label` | string | Yes | Choice text/content |
| `isCorrect` | boolean | Yes | Whether this is the correct answer |
| `order` | number | Yes | Display order (0, 1, 2...) |

### Indexes

| Index | Fields | Use Case |
|-------|--------|----------|
| `locale_slug` | ["locale", "slug"] | Get exercise by URL |
| `locale_category_type` | ["locale", "category", "type"] | List by exam type |
| `locale_category_type_material` | [...] | List by material |
| `locale_category_type_material_exerciseType_setName` | [...] | List exercises in a set |
| `contentHash` | ["contentHash"] | Check if content changed |
| `exerciseId_locale` | ["exerciseId", "locale"] | Get choices for exercise |

## URL Mapping

```
URL: /id/exercises/high-school/tka/mathematics/try-out/set-1/12

Fields:
- locale: "id"
- slug: "exercises/high-school/tka/mathematics/try-out/set-1/12"
- category: "high-school"
- type: "tka"
- material: "mathematics"
- exerciseType: "try-out"
- setName: "set-1"
- number: 12
```

## Query Examples

### Get Exercise by URL

```typescript
const exercise = await ctx.db
  .query("exerciseContents")
  .withIndex("locale_slug", (q) =>
    q.eq("locale", "id").eq("slug", "exercises/high-school/tka/mathematics/try-out/set-1/12")
  )
  .unique();
```

### Get Choices for Exercise

```typescript
const choices = await ctx.db
  .query("exerciseChoices")
  .withIndex("exerciseId_locale", (q) =>
    q.eq("exerciseId", exercise._id).eq("locale", "id")
  )
  .collect();

const sorted = choices.sort((a, b) => a.order - b.order);
```

### List Exercises in Set

```typescript
const exercises = await ctx.db
  .query("exerciseContents")
  .withIndex("locale_category_type_material_exerciseType_setName", (q) =>
    q.eq("locale", "id")
      .eq("category", "high-school")
      .eq("type", "tka")
      .eq("material", "mathematics")
      .eq("exerciseType", "try-out")
      .eq("setName", "set-1")
  )
  .collect();
```

## Integration with Existing exerciseAnswers

The existing `exerciseAnswers` table stores user answers:

```typescript
// Current: stores selectedOptionId as string ("A", "B", etc.)
selectedOptionId: v.optional(v.string())

// Can now also store choice _id for better tracking
selectedChoiceId: v.optional(v.id("exerciseChoices"))
```

Having `exerciseChoices._id` enables:
- Direct lookup of what choice was selected
- Analytics: "Most commonly wrong answer"
- Future: Difficulty per choice based on selection rate

## Why Normalize Choices?

| Aspect | Embedded | Normalized |
|--------|----------|------------|
| Has `_id` | No | Yes |
| Add explanation field | Update all exercises | Add column |
| Analytics per choice | Complex | Simple join |
| Choice count tracking | Manual | Built-in |

## Next Steps

After this task:
- Next: Task 0.6 (update main schema.ts)
- Dependencies: Task 0.1 (contentValidators)

## Related Tasks

- Task 0.1: Uses validators
- Task 0.2: Authors linked via contentAuthors join table
- Existing `exercises/schema.ts`: exerciseAnswers table can reference choices

## Notes

### Two Body Fields

- `questionBody`: The question/problem MDX
- `answerBody`: The answer/explanation MDX

Both are stored because they're always needed together but are distinct content pieces.

### Convex Best Practices Applied

- Normalized choices to separate table
- Each choice has `_id` for tracking
- Compound indexes for hierarchical queries
- Locale-aware choice retrieval
