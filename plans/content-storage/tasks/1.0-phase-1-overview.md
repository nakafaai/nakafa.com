# Phase 1: Content Sync Overview

## Goal

Sync MDX content from the filesystem to Convex database tables created in Phase 0.

## Content Sources

| Type | Path Pattern | Est. Count |
|------|--------------|------------|
| Articles | `packages/contents/articles/{category}/{slug}/{locale}.mdx` | ~14 files |
| Subjects | `packages/contents/subject/{category}/{grade}/{material}/{topic}/{section}/{locale}.mdx` | ~2,000 files |
| Exercises | `packages/contents/exercises/{category}/{type}/{material}/{exerciseType}/{set}/{number}/` | ~400 exercises |

## MDX File Structure

### Articles
```typescript
// packages/contents/articles/politics/regional-elections-turmoil/en.mdx
export const metadata = {
  title: "...",
  description: "...",
  authors: [{ name: "..." }],
  date: "MM/DD/YYYY",
  category: "Politics",
};

// MDX body content follows...
```

### Subjects
```typescript
// packages/contents/subject/high-school/12/mathematics/integral/riemann-sum/en.mdx
export const metadata = {
  title: "...",
  description: "...",
  authors: [{ name: "..." }],
  date: "MM/DD/YYYY",
  subject: "Integrals", // optional chapter name
};

// MDX body content follows...
```

### Exercises
```
packages/contents/exercises/{category}/{type}/{material}/{exerciseType}/{set}/{number}/
├── _question/
│   ├── en.mdx
│   └── id.mdx
├── _answer/
│   ├── en.mdx
│   └── id.mdx
└── choices.ts
```

Each MDX file:
```typescript
export const metadata = {
  title: "Question 5",
  authors: [{ name: "..." }],
  date: "MM/DD/YYYY",
};
// MDX body content follows...
```

choices.ts:
```typescript
const choices: ExercisesChoices = {
  en: [
    { label: "$$5$$", value: false },
    { label: "$$4$$", value: true },
    // ...
  ],
  id: [...],
};
```

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Content Sync Flow                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. CLI Script (Node.js)                                            │
│     ├── Glob MDX files from filesystem                              │
│     ├── Parse each file (extract metadata + body)                   │
│     ├── Compute SHA-256 hash of body                                │
│     └── Call Convex mutation via HTTP API                           │
│                                                                      │
│  2. Sync Mutation (Convex)                                          │
│     ├── Check if content exists (by locale + slug)                  │
│     ├── If exists: compare hash → skip if unchanged                 │
│     ├── Upsert content record                                       │
│     ├── Sync authors via contentAuthors join table                  │
│     └── For articles: sync references                               │
│         For exercises: sync choices                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Tasks

### 1.1: MDX Parser Utilities
- `packages/backend/scripts/lib/mdxParser.ts`
- Extract metadata export from MDX
- Separate body content (after metadata)
- Compute SHA-256 hash
- Parse path to extract category/grade/material/etc.

### 1.2: Sync Mutations
- `packages/backend/convex/articleContents/mutations.ts`
- `packages/backend/convex/subjectContents/mutations.ts`
- `packages/backend/convex/exerciseContents/mutations.ts`
- `packages/backend/convex/authors/mutations.ts` (upsert authors)

### 1.3: Sync CLI Script
- `packages/backend/scripts/sync-content.ts`
- Parse command line args (--type article|subject|exercise, --locale en|id, --dry-run)
- Glob files, parse, batch sync

### 1.4: Testing
- Run sync for each content type
- Verify data in Convex dashboard
- Verify hash-based change detection works

## Key Design Decisions

### 1. CLI Script vs Convex Action
- **Choice**: CLI script (Node.js)
- **Why**: File system access, easy to run locally, no function timeout limits
- **Trade-off**: Must configure Convex HTTP client

### 2. Batch vs Single Document Sync
- **Choice**: Single document per mutation (for now)
- **Why**: Simpler error handling, easier debugging
- **Future**: Could batch up to 8KB limit if needed

### 3. Author Handling
- **Choice**: Upsert by name (authors may not have username yet)
- **Why**: MDX only contains `{ name: "..." }`
- **Future**: Can enrich authors table with username/social later

### 4. Hash Change Detection
- **Choice**: SHA-256 of body content only (not metadata)
- **Why**: Title/description changes are infrequent, body is the main content
- **Trade-off**: Metadata-only changes won't trigger re-sync (acceptable)

## Commands

```bash
# Run from packages/backend
pnpm exec tsx scripts/sync-content.ts --type=article --locale=en
pnpm exec tsx scripts/sync-content.ts --type=subject --dry-run
pnpm exec tsx scripts/sync-content.ts --type=exercise --locale=all
```

## Dependencies

- `glob` (already in workspace)
- `crypto` (Node.js built-in)
- Convex JS client (already configured)

## Success Criteria

- [ ] All articles synced (14 files)
- [ ] All subjects synced (~2,000 files)
- [ ] All exercises synced (~400 exercises with choices)
- [ ] Re-running sync skips unchanged content
- [ ] Authors correctly linked via contentAuthors

---

**Last Updated**: January 24, 2026
**Status**: Ready for implementation
