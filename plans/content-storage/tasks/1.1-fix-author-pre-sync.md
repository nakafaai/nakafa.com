# Fix Author Pre-Sync in Incremental and Individual Sync Commands

## üéØ Goal

Fix the bug where `sync:incremental` and individual sync commands (`sync:articles`, `sync:subjects`, `sync:exercises`) fail to pre-sync authors, causing silent data loss when new authors are added to existing content.

## üìç Context

### The Bug

The content sync system uses a **Phase 0 author pre-sync** pattern to prevent write conflicts:

1. **Phase 0**: Pre-sync all authors before content sync (`syncAuthors()`)
2. **Phase 1**: Sync content using read-only author cache (`buildAuthorCache()`)
3. **Phase 2**: Create content-author links using cached author IDs

**Problem**: 
- `syncAll()` correctly calls `syncAuthors()` at line 1541
- `syncIncremental()` does NOT call `syncAuthors()` before syncing changed content
- Individual sync commands (`articles`, `subjects`, `exercises`) do NOT call `syncAuthors()`

When new authors are added to content:
1. `buildAuthorCache()` only reads EXISTING authors from DB
2. New authors aren't in the cache
3. `syncContentAuthorsWithCache()` silently skips missing authors (line 132: `if (authorId)`)
4. Content syncs successfully but **without author attribution**

### Impact

- **Data loss**: New authors are silently dropped from content
- **Silent failure**: No error, warning, or indication that author links weren't created
- **Inconsistent state**: Content exists but lacks proper author attribution
- **Hard to detect**: Only discoverable through manual database inspection

## PRD

```json
{
  "category": "functional",
  "description": "Ensure author pre-sync runs before all content sync operations to prevent silent author link data loss",
  "steps": [
    "Verify syncAuthors() is called in syncAll() before content sync",
    "Add syncAuthors() call to syncIncremental() before content sync",
    "Add syncAuthors() call to individual sync command handlers (articles, subjects, exercises)",
    "Verify all sync paths now pre-sync authors",
    "Test with new author in content to confirm fix"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] `sync:incremental` pre-syncs authors before syncing changed content
- [ ] `sync:articles` pre-syncs authors before syncing articles
- [ ] `sync:subjects` pre-syncs authors before syncing subjects
- [ ] `sync:exercises` pre-syncs authors before syncing exercises
- [ ] All existing sync commands (`sync`, `sync:full`, `sync:all`) continue to work
- [ ] No duplicate author syncs (syncAll already calls syncAuthors)
- [ ] Clean logs with clear phase indicators
- [ ] TypeScript compiles without errors
- [ ] Lint passes

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck
pnpm test

# Test sync commands
pnpm --filter backend sync:validate
pnpm --filter backend sync:incremental --dry-run
```

## üìù Subtasks

### Subtask 1.1: Add Author Collection from Changed Files

**File to modify**: `packages/backend/scripts/sync-content.ts`

**Implementation**:

Create a new function to collect author names only from changed files (for incremental sync efficiency):

```typescript
/**
 * Collects author names from specific files (for incremental sync).
 * Only reads metadata from the provided file paths.
 */
async function collectAuthorNamesFromFiles(
  filePaths: string[]
): Promise<string[]> {
  const authorNames: string[] = [];

  for (const file of filePaths) {
    try {
      const { metadata } = await readMdxFile(file);
      authorNames.push(...metadata.authors.map((a) => a.name));
    } catch {
      // Skip files that fail to parse
    }
  }

  return [...new Set(authorNames)];
}
```

**Output**: New utility function for incremental author collection

---

### Subtask 1.2: Add Author Pre-Sync to syncIncremental

**File to modify**: `packages/backend/scripts/sync-content.ts`

**Implementation**:

Add author pre-sync phase to `syncIncremental()` function (around line 2465, after determining changed files):

```typescript
// Phase 0: Pre-sync authors from changed files
const changedFilesArray = [...changedFiles];
const changedAuthorNames = await collectAuthorNamesFromFiles(changedFilesArray);

if (changedAuthorNames.length > 0) {
  log("Phase 0: Pre-syncing authors from changed files...");
  const authorResult = await runConvexMutationGeneric(
    config,
    "contentSync/mutations:bulkSyncAuthors",
    { authorNames: changedAuthorNames },
    AuthorSyncResultSchema
  );
  log(
    `  Authors: ${authorResult.created} new, ${authorResult.existing} existing\n`
  );
}
```

**Output**: Incremental sync now pre-syncs authors from changed files only

---

### Subtask 1.3: Add Author Pre-Sync to Individual Commands

**File to modify**: `packages/backend/scripts/sync-content.ts`

**Implementation**:

Update the individual sync command handlers (around line 2828) to call `syncAuthors()` first:

```typescript
case "articles":
  await syncAuthors(config, options);
  await syncArticles(config, options);
  break;
case "subjects":
  await syncAuthors(config, options);
  await syncSubjectTopics(config, options);
  await syncSubjectSections(config, options);
  break;
case "subject-topics":
  await syncAuthors(config, options);
  await syncSubjectTopics(config, options);
  break;
case "subject-sections":
  await syncAuthors(config, options);
  await syncSubjectSections(config, options);
  break;
case "exercise-sets":
  await syncAuthors(config, options);
  await syncExerciseSets(config, options);
  break;
case "exercise-questions":
  await syncAuthors(config, options);
  await syncExerciseQuestions(config, options);
  break;
case "exercises":
  await syncAuthors(config, options);
  await syncExerciseSets(config, options);
  await syncExerciseQuestions(config, options);
  break;
```

**Output**: All individual sync commands now pre-sync authors

---

### Subtask 1.4: Verify and Test

**Verification Steps**:

1. **TypeScript Check**:
   ```bash
   pnpm typecheck
   ```

2. **Lint Check**:
   ```bash
   pnpm lint
   ```

3. **Test Validation**:
   ```bash
   pnpm --filter backend sync:validate
   ```

4. **Test Incremental Sync** (dry run - check logs show author phase):
   ```bash
   # Make a small change to a content file first
   pnpm --filter backend sync:incremental
   ```

5. **Test Individual Commands** (check logs show author sync):
   ```bash
   pnpm --filter backend sync:articles
   ```

**Output**: All tests pass, logs show clear author pre-sync phase

---

## üöÄ Next Steps

After this task:
- Update `plans/content-storage/SYNC.md` to document the fix
- Consider adding validation to detect missing author links (future enhancement)

## üîó Related Tasks

- Related to content-storage sync system
- Fixes bug identified in PR #43 by Devin AI review

## ‚ö†Ô∏è Important Notes

### Implementation Details

1. **Incremental Sync Optimization**: 
   - Only collect authors from CHANGED files, not all files
   - This keeps incremental sync fast
   - Uses new `collectAuthorNamesFromFiles()` function

2. **Individual Commands**:
   - Use existing `syncAuthors()` which collects from ALL files of relevant types
   - This ensures all potential authors exist before content sync
   - Slightly slower but guarantees correctness

3. **No Changes Needed For**:
   - `syncAll()` - already calls `syncAuthors()` at line 1541
   - `syncFull()` - calls `syncAll()` which handles author sync
   - Mutation functions - they correctly use read-only cache

### Convex Best Practices

- Mutations are transactional - author pre-sync and content sync are separate transactions
- OCC (Optimistic Concurrency Control) handles any edge cases automatically
- No need for explicit locking or conflict resolution

### Testing Strategy

1. **Unit Test**: Verify `collectAuthorNamesFromFiles()` extracts authors correctly
2. **Integration Test**: Run sync commands and verify author links exist in DB
3. **Regression Test**: Ensure existing sync flows still work

---

**Last Updated**: January 27, 2026
