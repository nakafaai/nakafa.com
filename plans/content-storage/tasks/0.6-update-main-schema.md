# Task 0.6: Update Main Schema

## Goal

Update the main Convex schema file to include all new content storage tables.

## Context

Convex requires all tables to be registered in the main `schema.ts` file. This task imports and spreads all new schemas.

## PRD

```json
{
  "category": "integration",
  "description": "Update packages/backend/convex/schema.ts with new content table imports",
  "steps": [
    "Add import for authorsSchema",
    "Add import for articleContentsSchema",
    "Add import for subjectContentsSchema",
    "Add import for exerciseContentsSchema",
    "Spread all new schemas in defineSchema",
    "Verify lint and typecheck pass"
  ],
  "passes": false
}
```

## Success Criteria

- [ ] All 4 new schema imports added
- [ ] Schemas spread in correct order
- [ ] No lint errors
- [ ] No TypeScript errors
- [ ] Convex schema compiles

## Commands

```bash
pnpm lint
pnpm typecheck
```

## Implementation

### File: `packages/backend/convex/schema.ts`

**Before:**
```typescript
import bookmarksSchema from "@repo/backend/convex/bookmarks/schema";
import chatsSchema from "@repo/backend/convex/chats/schema";
import classesSchema from "@repo/backend/convex/classes/schema";
import commentsSchema from "@repo/backend/convex/comments/schema";
import contentsSchema from "@repo/backend/convex/contents/schema";
import customersSchema from "@repo/backend/convex/customers/schema";
import exercisesSchema from "@repo/backend/convex/exercises/schema";
import notificationsSchema from "@repo/backend/convex/notifications/schema";
import schoolsSchema from "@repo/backend/convex/schools/schema";
import subscriptionsSchema from "@repo/backend/convex/subscriptions/schema";
import usersSchema from "@repo/backend/convex/users/schema";
import { defineSchema } from "convex/server";

export default defineSchema(
  {
    ...usersSchema,
    ...chatsSchema,
    ...commentsSchema,
    ...customersSchema,
    ...subscriptionsSchema,
    ...schoolsSchema,
    ...classesSchema,
    ...notificationsSchema,
    ...bookmarksSchema,
    ...contentsSchema,
    ...exercisesSchema,
  },
  {
    schemaValidation: true,
  }
);
```

**After:**
```typescript
import articleContentsSchema from "@repo/backend/convex/articleContents/schema";
import authorsSchema from "@repo/backend/convex/authors/schema";
import bookmarksSchema from "@repo/backend/convex/bookmarks/schema";
import chatsSchema from "@repo/backend/convex/chats/schema";
import classesSchema from "@repo/backend/convex/classes/schema";
import commentsSchema from "@repo/backend/convex/comments/schema";
import contentsSchema from "@repo/backend/convex/contents/schema";
import customersSchema from "@repo/backend/convex/customers/schema";
import exerciseContentsSchema from "@repo/backend/convex/exerciseContents/schema";
import exercisesSchema from "@repo/backend/convex/exercises/schema";
import notificationsSchema from "@repo/backend/convex/notifications/schema";
import schoolsSchema from "@repo/backend/convex/schools/schema";
import subjectContentsSchema from "@repo/backend/convex/subjectContents/schema";
import subscriptionsSchema from "@repo/backend/convex/subscriptions/schema";
import usersSchema from "@repo/backend/convex/users/schema";
import { defineSchema } from "convex/server";

export default defineSchema(
  {
    ...usersSchema,
    ...chatsSchema,
    ...commentsSchema,
    ...customersSchema,
    ...subscriptionsSchema,
    ...schoolsSchema,
    ...classesSchema,
    ...notificationsSchema,
    ...bookmarksSchema,
    ...contentsSchema,
    ...exercisesSchema,
    ...authorsSchema,
    ...articleContentsSchema,
    ...subjectContentsSchema,
    ...exerciseContentsSchema,
  },
  {
    schemaValidation: true,
  }
);
```

## Changes Summary

### New Imports (4)

| Import | Schema File | Tables |
|--------|-------------|--------|
| `authorsSchema` | `convex/authors/schema.ts` | authors, contentAuthors |
| `articleContentsSchema` | `convex/articleContents/schema.ts` | articleContents, articleReferences |
| `subjectContentsSchema` | `convex/subjectContents/schema.ts` | subjectContents |
| `exerciseContentsSchema` | `convex/exerciseContents/schema.ts` | exerciseContents, exerciseChoices |

### Total New Tables (7)

1. `authors` - Shared author profiles
2. `contentAuthors` - N:M join table
3. `articleContents` - Article body storage
4. `articleReferences` - Article citations
5. `subjectContents` - Subject lesson content
6. `exerciseContents` - Exercise questions
7. `exerciseChoices` - Answer options

## Import Order

Imports are alphabetically ordered (Biome/ESLint convention):
1. `articleContentsSchema`
2. `authorsSchema`
3. `bookmarksSchema`
4. ... (existing)
5. `exerciseContentsSchema`
6. `exercisesSchema`
7. ... (existing)
8. `subjectContentsSchema`
9. `subscriptionsSchema`
10. ... (existing)

## Verification

After implementation, verify:

```bash
# Check schema compiles
pnpm --filter backend exec npx convex dev --once

# Or just typecheck
pnpm typecheck
```

## Next Steps

After this task:
- Phase 0 complete
- Next: Phase 1 (Content Sync) - create sync actions
- Can also proceed with API Monetization implementation

## Related Tasks

- Task 0.1-0.5: All schema files this task imports
- API Monetization: Can use these tables for content API

## Notes

### Why Separate from Existing Schemas?

| Existing | New | Purpose |
|----------|-----|---------|
| `contentsSchema` | `articleContentsSchema` | Views/stats vs actual content |
| `exercisesSchema` | `exerciseContentsSchema` | Attempts/answers vs actual content |

The existing schemas track user interactions, the new schemas store the actual MDX content.

### Schema Validation

`schemaValidation: true` ensures:
- All documents match their schema
- Invalid data is rejected at write time
- Type safety is enforced
