# Task 4.5.3: Unban Mutation

## Goal

Create mutation to restore falsely revoked API keys.

## Context

Unban needs to:
- Re-enable API key
- Clear revoke reason
- Log to security events
- Admin notes required

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD

```json
{
  "category": "functional",
  "description": "Mutation to restore falsely revoked API keys",
  "steps": [
    "Create unbanKey mutation with v.object() validators",
    "Re-enable key and clear reason",
    "Log to security events",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Mutation created
- [ ] Key re-enabled
- [ ] Reason cleared
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.5.3.1: Create Mutation

**File**: `packages/backend/convex/apikeys/mutations/unban.ts`


**Output**: Mutation created

---

### Subtask 4.5.3.2: Add Tests

**File**: `packages/backend/convex/apikeys/__tests__/unban.test.ts`

```typescript
import { describe, it, expect, beforeAll } from "vitest";
import { api } from "../../../_generated/api";

describe("unbanKey", () => {
  let testApiKeyId;

  beforeAll(async () => {
    testApiKeyId = await api.betterAuth.mutations.createApiKey({
      userId: testUserId,
      subscriptionTier: "free",
    });
  });

  it("should unban revoked key", async () => {
    await revokeKey({ apiKeyId: testApiKeyId, reason: "automated_scraping" });

    const result = await unbanKey({
      apiKeyId: testApiKeyId,
      adminNotes: "Investigated, false positive",
    });

    expect(result.success).toBe(true);

    const apiKey = await ctx.db.get("apikey", testApiKeyId);
    expect(apiKey?.enabled).toBe(true);
    expect(apiKey?.revokedAt).toBeNull();
  });

  it("should not unban active key", async () => {
    const result = await unbanKey({
      apiKeyId: testApiKeyId,
      adminNotes: "Key is already active",
    });

    expect(result.success).toBe(false);
  });
});
```

**Output**: Tests

---

## Next Steps

Phase 4 Complete.

## Related

- Task 4.5.1: Revocation Helpers (used by this mutation)
- Task 4.5.2: Revoke (completes the revocation flow)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.5.3 completed

Key decisions:
- Clear revoke reason on unban
- Log unban events to securityEvents
- Verify key is actually revoked before unban

Files changed:
- packages/backend/convex/apikeys/mutations/unban.ts
- packages/backend/convex/apikeys/__tests__/unban.test.ts

Blockers: None

Phase 4 Complete
```
