# Task 4.2: IP-Based Rate Limiting (Minor Fix)

## Critical Fix Required

**Change all `v.id("apikey")` to `v.string()`** in this task.

Better Auth uses string IDs for API keys, not Convex IDs.

## Files to Fix

### Subtask 4.2.1: Extend Schema for IP Tracking

**BEFORE (Wrong)**:
```typescript
apiKeyIPs: defineTable({
  apiKeyId: v.id("apikey"), // WRONG
  // ...
})
```

**AFTER (Correct)**:
```typescript
apiKeyIPs: defineTable({
  apiKeyId: v.string(), // CORRECT - Better Auth uses string IDs
  // ...
})
```

### Subtask 4.2.2: Create IP Tracking Middleware

**BEFORE (Wrong)**:
```typescript
export const createAPIKeyIP = internalMutation({
  args: {
    apiKeyId: v.id("apikey"), // WRONG
    // ...
  }
});
```

**AFTER (Correct)**:
```typescript
export const createAPIKeyIP = internalMutation({
  args: {
    apiKeyId: v.string(), // CORRECT
    // ...
  }
});
```

### Subtask 4.2.3: Add API Key IP Mutations

**BEFORE (Wrong)**:
```typescript
export const updateAPIKeyIP = internalMutation({
  args: {
    apiKeyIPId: v.id("apiKeyIPs"), // CORRECT (this is our table)
    // ...
  }
});

export const getApiKeyIP = internalMutation({
  args: {
    apiKeyId: v.id("apikey"), // WRONG
    ipAddress: v.string(),
  }
});
```

**AFTER (Correct)**:
```typescript
export const updateAPIKeyIP = internalMutation({
  args: {
    apiKeyIPId: v.id("apiKeyIPs"), // CORRECT (our table)
    // ...
  }
});

export const getApiKeyIP = internalMutation({
  args: {
    apiKeyId: v.string(), // CORRECT (Better Auth uses string IDs)
    ipAddress: v.string(),
  }
});
```

## Summary

| Field | Type | Reason |
|-------|------|--------|
| `apiKeyId` in Better Auth's `apikey` table | `v.string()` | Better Auth manages its own ID system |
| `apiKeyId` in our `apiKeyIPs` table | `v.string()` | References Better Auth's string ID |
| `_id` in our tables (`contentAccessLog`, etc.) | `v.id("contentAccessLog")` | Convex-managed ID (correct) |

## Why This Matters

Using `v.id("apikey")` will cause TypeScript and runtime errors because:
1. Better Auth's apikey table is not in our Convex schema
2. Better Auth uses string IDs, not Convex IDs
3. We can't type-check Better Auth's IDs with `v.id()`

## Implementation Checklist

- [ ] Subtask 4.2.1: Change `v.id("apikey")` to `v.string()` in `apiKeyIPs` table
- [ ] Subtask 4.2.3: Change all `apiKeyId: v.id("apikey")` to `v.string()`
- [ ] Verify all type-checking passes
- [ ] Run tests to ensure no runtime errors

## Status

⚠️ **Minor fix required** - Only type changes, no logic changes

## Note

The rest of Task 4.2 is correct and well-planned. Only the ID types need fixing.
