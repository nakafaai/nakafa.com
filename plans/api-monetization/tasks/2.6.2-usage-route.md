# Task 2.6.2: Usage Route

## Goal

Create route to fetch and return usage statistics.

## Context

Users need endpoint to:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Get usage for specific key
- Get usage for all keys
- Format for dashboard display

## PRD

```json
{
  "category": "functional",
  "description": "Route to fetch API usage statistics",
  "steps": [
    "Create GET /v1/me/usage route",
    "Create GET /v1/me/usage/all route",
    "Apply auth and rate limiting",
    "Format response for dashboard",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] GET /v1/me/usage route created
- [ ] GET /v1/me/usage/all route created
- [ ] Auth integrated
- [ ] Rate limiting applied
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.6.2.1: Create Usage Routes

**File**: `packages/backend/convex/routes/v1/usage/route.ts`

**Implementation**:

```typescript
import { requireApiKey } from "../../../middleware/auth";
import { requireRateLimit } from "../../../middleware/rateLimit";

export const getUsage = v1.get("/me/usage", requireApiKey(), requireRateLimit("usage", "get"), async (c) => {
  const userId = c.get("userId");
  const apiKeyId = c.get("apiKeyId");

  const usage = await c.env.runQuery(
    api.betterAuth.queries.getUsage,
    { apiKeyId }
  );

  if (!usage) {
    return c.json({ error: "Usage not found" }, { status: 404 });
  }

  const now = Date.now();
  const tierLimits = TIER_LIMITS[usage.subscriptionTier];

  return c.json({
    apiKeyId,
    subscriptionTier: usage.subscriptionTier,
    requestsToday: usage.requestsToday,
    requestsThisMinute: usage.requestsThisMinute,
    dailyLimit: tierLimits.rateLimitDaily,
    minuteLimit: tierLimits.rateLimitMinute,
    dailyResetTime: usage.dailyResetTime,
    minuteResetTime: usage.minuteResetTime,
    lastRequestTime: usage.lastRequestTime,
    remainingToday: tierLimits.rateLimitDaily 
      ? tierLimits.rateLimitDaily - usage.requestsToday 
      : null,
    remainingMinute: tierLimits.rateLimitMinute
      ? tierLimits.rateLimitMinute - usage.requestsThisMinute
      : null,
  }, { status: 200 });
});

export const getAllUsage = v1.get("/me/usage/all", requireApiKey(), requireRateLimit("usage", "get"), async (c) => {
  const userId = c.get("userId");

  const result = await c.env.runQuery(
    api.betterAuth.queries.listApiKeys,
    { userId, limit: 100 }
  );

  const apiKeyIds = result.apiKeys.map((k) => k._id);
  const usageRecords = await Promise.all(
    apiKeyIds.map((id) => 
      c.env.runQuery(api.betterAuth.queries.getUsage, { apiKeyId: id })
    )
  );

  const enriched = result.apiKeys.map((key) => {
    const usage = usageRecords.find((u) => u.apiKeyId === key._id);
    return {
      ...key,
      usage: usage ?? null,
    };
  });

  return c.json({
    apiKeys: enriched,
    total: enriched.length,
  }, { status: 200 });
});
```

**Output**: Routes created

---

### Subtask 2.6.2.2: Add Tests

**File**: `packages/backend/convex/routes/__tests__/usage.test.ts`

**Tests**:

```typescript
describe("Usage Routes", () => {
  describe("GET /v1/me/usage", () => {
    it("should return usage data", async () => {
      const response = await api.v1.getUsage({});

      expect(response.subscriptionTier).toBeDefined();
      expect(response.requestsToday).toBeGreaterThanOrEqual(0);
    });
  });

  describe("GET /v1/me/usage/all", () => {
    it("should return usage for all keys", async () => {
      const response = await api.v1.getAllUsage({});

      expect(response.apiKeys).toBeInstanceOf(Array);
      expect(response.total).toBeGreaterThan(0);
    });
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.6.3 - Usage Docs

## Related

- Task 2.6.1: Usage Query (used by these routes)
- Task 2.4: Rate Limit Model (usage data structure)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.6.2 completed

Key decisions:
- Single key usage endpoint
- All keys usage endpoint
- Include remaining counts in response

Files changed:
- packages/backend/convex/routes/v1/usage/route.ts
- packages/backend/convex/routes/__tests__/usage.test.ts

Blockers: None
```
