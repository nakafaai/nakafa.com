# Task 6.2: Load Tests

## Goal

Create load testing suite for performance verification.

## Context

Load testing needs to:
- Simulate realistic user behavior
- Test rate limits under load
- Test caching effectiveness
- Test database performance

## PRD

```json
{
  "category": "testing",
  "description": "Load testing suite for performance verification",
  "steps": [
    "Create load test scripts",
    "Test rate limits under load",
    "Test performance under load",
    "Add documentation"
  ],
  "passes": false
}
```

## Success

- [ ] Load test scripts created
- [ ] Performance benchmarks established
- [ ] Rate limits tested under load
- [ ] Documentation created

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 6.2.1: Create Load Test Scripts

**File**: `tests/load/performance.ts`

```typescript
import { Worker } from "worker_threads";

export interface LoadTestConfig {
  concurrentUsers: number;
  requestsPerUser: number;
  durationSeconds: number;
  endpoint: string;
}

export interface LoadTestResult {
  totalRequests: number;
  successfulRequests: number;
  failedRequests: number;
  averageLatency: number;
  requestsPerSecond: number;
}

export async function runLoadTest(config: LoadTestConfig): Promise<LoadTestResult> {
  const results: await Promise.all(
    Array.from({ length: config.concurrentUsers }, (_, userIdx) =>
      runUserLoadTest(config, userIdx)
    )
  );

  return {
    totalRequests: results.reduce((sum, r) => sum + r.totalRequests, 0),
    successfulRequests: results.reduce((sum, r) => sum + r.successfulRequests, 0),
    failedRequests: results.reduce((sum, r) => sum + r.failedRequests, 0),
    averageLatency: Math.round(results.reduce((sum, r) => sum + r.averageLatency, 0) / results.length),
    requestsPerSecond: Math.round(results.reduce((sum, r) => sum + r.requestsPerSecond, 0) / config.durationSeconds),
  };
}

async function runUserLoadTest(
  config: LoadTestConfig,
  userIdx: number
): Promise<{ totalRequests: number; successfulRequests: number; failedRequests: number; averageLatency: number; requestsPerSecond: number }> {
  const apiKey = await getOrCreateApiKey(userIdx);
  const results = {
    totalRequests: 0,
    successfulRequests: 0,
    failedRequests: 0,
    latencies: [],
  };

  const startTime = Date.now();

  for (let i = 0; i < config.requestsPerUser; i++) {
    const requestStart = Date.now();
    const response = await fetch(`${API_BASE}${config.endpoint}`, {
      headers: { Authorization: `Bearer ${apiKey}` },
    });

    const requestEnd = Date.now();
    const latency = requestEnd - requestStart;

    results.totalRequests++;
    results.latencies.push(latency);

    if (response.status === 200) {
      results.successfulRequests++;
    } else if (response.status === 429) {
      results.failedRequests++;
      await sleep(1000);
    }
  }

  const averageLatency = Math.round(results.latencies.reduce((sum, l) => sum + l, 0) / results.latencies.length);

  return results;
}
```

**Output**: Load test scripts

---

### Subtask 6.2.2: Add Tests

**File**: `tests/load/__tests__/load-test.test.ts`

```typescript
import { describe, it, expect, beforeAll } from "vitest";
import { runLoadTest } from "../performance";

describe("Load Tests", () => {
  it("should run load test", async () => {
    const result = await runLoadTest({
      concurrentUsers: 10,
      requestsPerUser: 50,
      durationSeconds: 30,
      endpoint: "/v1/contents",
    });

    expect(result.totalRequests).toBe(500);
  });

  it("should measure latency correctly", () => {
    const result = await runLoadTest({
      concurrentUsers: 5,
      requestsPerUser: 10,
      durationSeconds: 10,
      endpoint: "/v1/contents",
    });

    expect(result.averageLatency).toBeGreaterThan(0);
  });
});
```

**Output**: Tests

---

### Subtask 6.2.3: Documentation

**File**: `docs/testing/load-testing.md`

```markdown
# Load Testing

## Purpose

Performance verification under realistic load conditions.

## Running Load Tests

### Setup

1. Ensure API keys are configured
2. Set desired concurrent users
3. Configure requests per user
4. Run for specified duration

### Example

```bash
node tests/load/performance.js \
  --concurrentUsers=10 \
  --requestsPerUser=50 \
  --durationSeconds=30 \
  --endpoint=/v1/contents
```

## Interpreting Results

- **Total Requests**: Total requests made
- **Successful Requests**: Requests with 200 status
- **Failed Requests**: Requests with 429 status
- **Average Latency**: Mean response time (ms)
- **Requests Per Second**: RPS under load

## Performance Targets

- Free tier: 25 requests/day
- Pro tier: 100/minute + 1000/day
- Enterprise: Unlimited

## Best Practices

1. **Warm-up**: Send initial requests to prime cache
2. **Stagger starts**: Don't start all users simultaneously
3. **Monitor**: Watch for failures and latency increases
4. **Clean up**: Delete test keys after testing
```

**Output**: Documentation

---

## Next Steps

All phases complete.

## Related

- Task 6.1: Security Tests (tests for all layers)
- All previous tasks (tested by this phase)

## Progress

```
[YYYY-MM-DD HH:mm] Task 6.2 completed

All phases complete
```
