# Task 2.5.1: Create API Key Mutation

## Goal

Create mutation to generate and store API keys.

## Context

Users need to create API keys via:
- Dashboard (future)
- API endpoints (this task)
- Keys must be secure, unique, and tier-based

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD
```json
{
  "category": "functional",
  "description": "API key generation mutation with security",
  "steps": [
    "Create createApiKey mutation with v.object() validators",
    "Generate secure random key",
    "Store in apikey table",
    "Return key with metadata",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Mutation created
- [ ] Key is unique and secure
- [ ] Tier limits set correctly
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.5.1.1: Create Mutation

**File**: `packages/backend/convex/betterAuth/mutations/createApiKey.ts`


**Implementation**:

```typescript
import { v } from "convex/values";
import { internalMutation } from "../../_generated/server";
import crypto from "node:crypto";

export const createApiKey = internalMutation({
  args: v.object({
    userId: v.id("users"),
    name: v.string(),
    subscriptionTier: v.union(
      v.literal("free"),
      v.literal("pro"),
      v.literal("enterprise")
    ),
    permissions: v.optional(v.array(v.string())),
  }),
  returns: v.object({
    success: v.boolean(),
    apiKey: v.optional(v.string()),
    error: v.optional(v.string()),
  }),
  handler: async (ctx, args) => {
    const { userId, name, subscriptionTier, permissions } = args;

    const user = await ctx.db.get("users", userId);
    if (!user) {
      return { success: false, error: "User not found" };
    }

    const existingKeys = await ctx.db
      .query("apikey")
      .withIndex("userId")
      .eq("userId", userId)
      .collect();

    const keyCount = existingKeys.length;
    if (keyCount >= 5) {
      return { success: false, error: "Maximum 5 API keys per user" };
    }

    const keyPrefix = "nak_pk_";
    const randomBytes = crypto.randomBytes(32);
    const apiKey = `${keyPrefix}${randomBytes.toString("base64url")}`;

    const now = Date.now();
    const tierLimits = TIER_LIMITS[subscriptionTier];

    const apiKeyId = await ctx.db.insert("apikey", {
      userId,
      name,
      key,
      signingSecret: crypto.randomBytes(32).toString("base64url"),
      subscriptionTier,
      rateLimitDaily: tierLimits.rateLimitDaily,
      rateLimitMinute: tierLimits.rateLimitMinute,
      permissions: permissions ?? ["contents"],
      enabled: true,
      createdAt: now,
      lastUsedAt: now,
    });

    await ctx.db.insert("apiKeyUsage", {
      apiKeyId,
      userId,
      subscriptionTier,
      requestsToday: 0,
      requestsThisMinute: 0,
      lastRequestTime: now,
      dailyResetTime: getMidnight(now),
      minuteResetTime: getStartOfNextMinute(now),
    });

    return {
      success: true,
      apiKey,
    };
  },
});

const TIER_LIMITS = {
  free: { rateLimitDaily: 25, rateLimitMinute: null },
  pro: { rateLimitDaily: 1000, rateLimitMinute: 100 },
  enterprise: { rateLimitDaily: null, rateLimitMinute: null },
} as const;

function getMidnight(now: number): number {
  const date = new Date(now);
  date.setHours(23, 59, 59, 999);
  return date.getTime();
}

function getStartOfNextMinute(now: number): number {
  const date = new Date(now);
  date.setSeconds(0, 0);
  date.setMinutes(date.getMinutes() + 1);
  return date.getTime();
}
```

**Output**: Mutation created

---

### Subtask 2.5.1.2: Add Tests

**File**: `packages/backend/convex/betterAuth/__tests__/createApiKey.test.ts`

**Tests**:

```typescript
describe("createApiKey", () => {
  it("should create free tier key", async () => {
    const result = await createApiKey({
      userId: testUserId,
      name: "Test Key",
      subscriptionTier: "free",
    });

    expect(result.success).toBe(true);
    expect(result.apiKey).toBeDefined();
    expect(result.apiKey?.startsWith("nak_pk_")).toBe(true);
  });

  it("should limit to 5 keys per user", async () => {
    for (let i = 0; i < 5; i++) {
      await createApiKey({
        userId: testUserId,
        name: `Key ${i}`,
        subscriptionTier: "free",
      });
    }

    const result = await createApiKey({
      userId: testUserId,
      name: "Key 6",
      subscriptionTier: "free",
    });

    expect(result.success).toBe(false);
    expect(result.error).toBe("Maximum 5 API keys per user");
  });

  it("should set tier limits correctly", async () => {
    const proResult = await createApiKey({
      userId: testUserId,
      name: "Pro Key",
      subscriptionTier: "pro",
    });

    const apiKey = await ctx.db.get("apikey", proResult.apiKeyId!);
    expect(apiKey?.rateLimitDaily).toBe(1000);
    expect(apiKey?.rateLimitMinute).toBe(100);
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.5.2 - List Keys

## Related

- Task 2.5.2: List Keys (uses this mutation)
- Task 2.5.3: Delete Key (uses this mutation)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.5.1 completed

Key decisions:
- Use crypto.randomBytes() for security
- nak_pk_ prefix for easy identification
- Maximum 5 keys per user
- Initialize usage counter to 0

Files changed:
- packages/backend/convex/betterAuth/mutations/createApiKey.ts
- packages/backend/convex/betterAuth/__tests__/createApiKey.test.ts

Blockers: None
```
