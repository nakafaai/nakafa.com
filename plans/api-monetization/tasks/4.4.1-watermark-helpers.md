# Task 4.4.1: Watermark Helpers

## Goal

Create helper functions for content watermarking.

## Context

Watermarking needs:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Generate watermarks with HMAC-SHA256
- Parse watermarks from content
- Remove watermarks for display
- Testable pure functions

## PRD

```json
{
  "category": "functional",
  "description": "Helper functions for content watermarking",
  "steps": [
    "Create watermark generation helpers",
    "Create watermark parsing helpers",
    "Add unit tests"
  ],
  "passes": false
}
```

## Success

- [ ] Generation helpers created
- [ ] Parsing helpers created
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.4.1.1: Create Watermark Generation

**File**: `packages/backend/convex/model/watermarking.ts`

**Implementation**:

```typescript
import crypto from "crypto";

export const WATERMARK_PREFIX = "<!-- NAK:API:";
export const WATERMARK_SUFFIX = " -->";

export interface Watermark {
  apiKeyId: string;
  hash: string;
  timestamp: number;
}

export function generateWatermarkHash(
  apiKeyId: string,
  contentSlug: string,
  timestamp: number
): string {
  const data = `${apiKeyId}:${contentSlug}:${timestamp}`;
  return crypto
    .createHmac("sha256", "nakafa-watermark-key")
    .update(data)
    .digest("base64url");
}

export function createWatermark(
  apiKeyId: string,
  contentSlug: string
): string {
  const timestamp = Date.now();
  const hash = generateWatermarkHash(apiKeyId, contentSlug, timestamp);

  return `${WATERMARK_PREFIX}${apiKeyId}:${hash}:${timestamp}${WATERMARK_SUFFIX}`;
}

export function addWatermark(
  content: string,
  watermark: Watermark
): string {
  return `${watermark.raw}\n${content}`;
}
```

**Output**: Watermark helpers

---

### Subtask 4.4.1.2: Create Watermark Parsing

**File**: `packages/backend/convex/model/watermarking.ts` (update)

```typescript
export function parseWatermark(content: string): Watermark | null {
  const prefix = `${WATERMARK_PREFIX}NAK:API:`;
  const startIndex = content.indexOf(prefix);

  if (startIndex === -1) {
    return null;
  }

  const endIndex = content.indexOf(WATERMARK_SUFFIX);

  if (endIndex === -1 || endIndex < startIndex) {
    return null;
  }

  const watermarkRaw = content.substring(startIndex, endIndex + WATERMARK_SUFFIX.length);

  const parts = watermarkRaw.slice(prefix.length).split(":");

  if (parts.length !== 3) {
    return null;
  }

  const [apiKeyIdPart, hashPart, timestampPart] = parts;

  return {
    apiKeyId: apiKeyIdPart,
    hash: hashPart,
    timestamp: Number.parseInt(timestampPart),
    raw: watermarkRaw,
  };
}

export function removeWatermark(content: string): string {
  const startIndex = content.indexOf(WATERMARK_PREFIX);

  if (startIndex === -1) {
    return content;
  }

  const endIndex = content.indexOf(WATERMARK_SUFFIX);

  if (endIndex === -1 || endIndex < startIndex) {
    return content;
  }

  return content.substring(0, startIndex) + content.substring(endIndex + WATERMARK_SUFFIX.length);
}
```

**Output**: Watermark parsing

---

### Subtask 4.4.1.3: Add Tests

**File**: `packages/backend/convex/model/__tests__/watermarking.test.ts`

```typescript
import { describe, it, expect } from "vitest";
import { createWatermark, parseWatermark, removeWatermark, generateWatermarkHash } from "../watermarking";

describe("watermarking", () => {
  it("should create watermark", () => {
    const watermark = createWatermark("key-123", "en/test");

    expect(watermark).toContain(WATERMARK_PREFIX);
    expect(watermark).toContain(WATERMARK_SUFFIX);
  });

  it("should parse valid watermark", () => {
    const watermarked = "<!-- NAK:API:key-123:abc:def:1705228800 -->\n# Content";
    const result = parseWatermark(watermarked);

    expect(result).not.toBeNull();
    expect(result?.apiKeyId).toBe("key-123");
    expect(result?.timestamp).toBe(1705228800);
  });

  it("should return null for no watermark", () => {
    const result = parseWatermark("# Content without watermark");

    expect(result).toBeNull();
  });

  it("should remove watermark", () => {
    const watermarked = "<!-- NAK:API:test:hash:123 -->\nContent";
    const clean = removeWatermark(watermarked);

    expect(clean).not.toContain("NAK:API:");
    expect(clean).not.toContain(" -->");
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.4.2 - Watermark Middleware

## Related

- Task 4.3: Request Signatures (watermarks can use same key)
- Task 4.5: Auto-Revocation (watermark evidence for leaks)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.4.1 completed

Key decisions:
- HMAC-SHA256 for cryptographic security
- Watermarks embedded as HTML comments
- Separation of generation and parsing concerns

Files changed:
- packages/backend/convex/model/watermarking.ts
- packages/backend/convex/model/__tests__/watermarking.test.ts

Blockers: None
```
