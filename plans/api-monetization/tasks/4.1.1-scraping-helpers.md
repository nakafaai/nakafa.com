# Task 4.1.1: Scraping Helpers

## Goal

Create helper functions for scraping detection following Convex best practices.

## Context

Scraping detection needs:
- Pattern analysis utilities
- Helper functions in model directory
- Testable pure functions

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD

```json
{
  "category": "architecture",
  "description": "Helper functions for scraping detection",
  "steps": [
    "Create pattern analysis helpers",
    "Create alert generation helpers",
    "Add unit tests"
  ],
  "passes": false
}
```

## Success

- [ ] Pattern helpers created
- [ ] Alert helpers created
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.1.1.1: Pattern Analysis Helpers

**File**: `packages/backend/convex/model/scrapingDetection.ts`


**Output**: Helpers created

---

### Subtask 4.1.1.2: Add Tests

**File**: `packages/backend/convex/model/__tests__/scrapingDetection.test.ts`

```typescript
import { describe, it, expect } from "vitest";
import { calculateMetrics, detectVelocityPattern } from "../scrapingDetection";

describe("scrapingDetection", () => {
  it("should calculate metrics correctly", () => {
    const logs = [
      { accessedAt: Date.now() },
      { accessedAt: Date.now() - 30000 },
      { accessedAt: Date.now() - 60000 },
    ];

    const metrics = calculateMetrics(logs);

    expect(metrics.requestsLastMinute).toBe(3);
    expect(metrics.uniquePathsLastMinute).toBe(3);
  });

  it("should detect sequential pattern", () => {
    const logs = Array.from({ length: 100 }, (_, i) => ({
      accessedAt: Date.now() - (i * 500),
      contentSlug: "test",
    }));

    const metrics = calculateMetrics(logs);

    expect(detectVelocityPattern(metrics)).toBe("sequential");
  });

  it("should detect bulk pattern", () => {
    const logs = Array.from({ length: 150 }, (_, i) => ({
      accessedAt: Date.now() - (i * 400),
      contentSlug: `test-${i}`,
    }));

    const metrics = calculateMetrics(logs);

    expect(detectVelocityPattern(metrics)).toBe("bulk");
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.1.2 - Velocity Mutation

## Related

- Task 4.1.1: Helpers (used by mutation)
- Task 4.2.2: IP Tracking (complementary)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.1.1 completed

Key decisions:
- Pure functions for pattern analysis
- Reusable across detection methods
- Separate metrics calculation from detection

Files changed:
- packages/backend/convex/model/scrapingDetection.ts
- packages/backend/convex/model/__tests__/scrapingDetection.test.ts

Blockers: None
```
