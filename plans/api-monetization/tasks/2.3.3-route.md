# Task 2.3.3: Search Route Handler

## Goal

Create `/v1/contents/search` route with auth, rate limiting, pagination.

## Context

POST endpoint that:
- Validates API key
- Checks rate limits
- Searches content
- Logs access

## PRD
```json
{
  "category": "functional",
  "description": "Search route with auth and rate limiting",
  "steps": [
    "Apply requireApiKey middleware",
    "Apply requireRateLimit middleware",
    "Parse query from request body",
    "Call searchContents algorithm",
    "Log access to contentAccessLog",
    "Return ranked results"
  ],
  "passes": false
}
```

## Success

- [ ] Route handler created
- [ ] API key auth integrated
- [ ] Rate limiting enforced
- [ ] Search returns ranked results
- [ ] Access logged
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.3.3.1: Create Route

**File**: `packages/backend/convex/routes/v1/index.ts`

**Implementation**:

```typescript
import { requireApiKey } from "../middleware/auth";
import { requireRateLimit } from "../middleware/rate-limit";
import { searchContents } from "./contents/search/algorithm";
import { HTTP_OK, HTTP_BAD_REQUEST } from "../constants";

v1.post("/contents/search", requireApiKey(), requireRateLimit("contents", "search"), async (c) => {
  const userId = c.get("userId");
  const apiKeyId = c.get("apiKeyId");

  const body = await c.req.json();

  const { valid, error } = validateSearchRequest(body);
  if (!valid) {
    return c.json({ error }, { status: HTTP_BAD_REQUEST });
  }

  const startTime = Date.now();

  try {
    const results = await searchContents({
      query: body.query,
      locale: body.locale,
      type: body.type,
      limit: body.limit,
    });

    const searchTime = Date.now() - startTime;

    await c.env.runMutation(
      internal.contents.mutations.logAccess,
      {
        apiKeyId,
        contentSlug: `search:${body.query}`,
        action: "search",
        metadata: JSON.stringify(body),
      }
    );

    return c.json(
      {
        results,
        total: results.length,
        query: body.query,
        searchTime,
      },
      { status: HTTP_OK }
    );
  } catch (error) {
    return c.json(
      { error: "Search failed", details: error.message },
      { status: 500 }
    );
  }
});
```

**Output**: Route handler

---

### Subtask 2.3.3.2: Add Tests

**File**: `packages/backend/convex/routes/__tests__/contents-search.test.ts`

**Tests**:

```typescript
describe("POST /v1/contents/search", () => {
  it("should return ranked results", async () => {
    const response = await api.v1.contents.search(
      { query: "algebra" },
      { apiKeyId: testApiKeyId }
    );

    expect(response.results).toBeInstanceOf(Array);
    expect(response.results.length).toBeGreaterThan(0);
  });

  it("should generate snippet with highlight", async () => {
    const response = await api.v1.contents.search(
      { query: "democracy" },
      { apiKeyId: testApiKeyId }
    );

    expect(response.results[0].snippet).toContain("**democracy**");
  });

  it("should enforce rate limit", async () => {
    for (let i = 0; i < 26; i++) {
      await api.v1.contents.search(
        { query: `test-${i}` },
        { apiKeyId: testApiKeyId }
      );
    }

    const response = await api.v1.contents.search(
      { query: "test-27" },
      { apiKeyId: testApiKeyId }
    );

    expect(response.error).toBe("Rate limit exceeded");
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.3.4 - Search Docs

## Related

- Task 2.3.1: Search Types
- Task 2.3.2: Search Algorithm

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.3.3 completed

Key decisions:
- POST method for complex queries
- Search time tracked for monitoring
- Rate limit applied before search

Files changed:
- packages/backend/convex/routes/v1/index.ts
- packages/backend/convex/routes/__tests__/contents-search.test.ts

Blockers: None
```
