# Task 2.4.1: Rate Limit Helper Functions

## Goal

Create helper functions that integrate with Better Auth's built-in rate limiting.

## Context

**Better Auth Already Provides**:
- ✅ Rate limiting built into `apikey` table
- ✅ Automatic counter management (`requestCount`, `remaining`)
- ✅ Configurable windows (`rateLimitTimeWindow`, `rateLimitMax`)
- ✅ Refill mechanism (`refillInterval`, `refillAmount`)

**We Need**:
- Helper functions to configure Better Auth rate limits per tier
- Integration layer for API route middleware
- Usage statistics query helpers

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD

```json
{
  "category": "architecture",
  "description": "Better Auth rate limiting integration helpers",
  "steps": [
    "Create tier limit configuration constants",
    "Create configureTierLimits helper function",
    "Create getUsageStats helper function",
    "Add unit tests"
  ],
  "passes": false
}
```

## Success

- [ ] `TIER_LIMITS` constants defined
- [ ] `configureTierLimits()` helper created
- [ ] `getUsageStats()` helper created
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.4.1.1: Create Tier Limits

**File**: `packages/backend/convex/lib/rateLimitConfig.ts`

**Implementation**:

```typescript
import { v } from "convex/values";

/**
 * Tier-based rate limit configuration
 * Maps to Better Auth's rate limiting fields:
 * - rateLimitMax: Maximum requests per time window
 * - rateLimitTimeWindow: Time window in milliseconds
 * - refillInterval: How often to reset counters (ms)
 * - refillAmount: How many tokens to add per refill
 */
export const TIER_LIMITS = {
  free: {
    rateLimitMax: 25,
    rateLimitTimeWindow: 86400000, // 1 day in milliseconds
    refillInterval: null, // Daily reset only
    refillAmount: null,
  },
  pro: {
    rateLimitMax: 100,
    rateLimitTimeWindow: 60000, // 1 minute in milliseconds
    refillInterval: 60000, // Refill every minute
    refillAmount: 100, // Add 100 tokens per minute (1000/day)
  },
  enterprise: {
    rateLimitMax: null, // Unlimited
    rateLimitTimeWindow: null,
    refillInterval: null,
    refillAmount: null,
  },
} as const;

export type SubscriptionTier = "free" | "pro" | "enterprise";
export type TierLimits = typeof TIER_LIMITS[SubscriptionTier];

/**
 * Get rate limit configuration for a subscription tier
 */
export function getTierLimits(tier: SubscriptionTier): TierLimits {
  return TIER_LIMITS[tier];
}

/**
 * Configure API key rate limits based on subscription tier
 * Returns the rate limit settings to apply to an API key
 */
export function configureTierLimits(
  tier: SubscriptionTier
): {
  rateLimitEnabled: boolean;
  rateLimitMax?: number;
  rateLimitTimeWindow?: number;
  refillInterval?: number;
  refillAmount?: number;
  metadata?: { subscriptionTier: string };
} {
  const limits = getTierLimits(tier);

  if (tier === "enterprise") {
    return {
      rateLimitEnabled: false,
      metadata: { subscriptionTier: "enterprise" },
    };
  }

  return {
    rateLimitEnabled: true,
    rateLimitMax: limits.rateLimitMax ?? undefined,
    rateLimitTimeWindow: limits.rateLimitTimeWindow ?? undefined,
    refillInterval: limits.refillInterval ?? undefined,
    refillAmount: limits.refillAmount ?? undefined,
    metadata: { subscriptionTier: tier },
  };
}
```

**Output**: Tier limits configuration

---

### Subtask 2.4.1.2: Create Usage Stats Helper

**File**: `packages/backend/convex/lib/usageHelpers.ts`

**Implementation**:

```typescript
import { v } from "convex/values";
import type { Id } from "../_generated/dataModel";

/**
 * Usage statistics for an API key
 * Derived from Better Auth's built-in rate limit fields
 */
export interface UsageStats {
  apiKeyId: string; // Better Auth uses string IDs
  subscriptionTier: "free" | "pro" | "enterprise";
  requestCount: number;
  remaining: number;
  lastRequest: number | undefined;
  rateLimitMax: number | undefined;
  rateLimitEnabled: boolean;
  tierDescription: string;
}

/**
 * Get usage statistics for an API key
 * Uses Better Auth's built-in rate limit fields
 */
export function getUsageStats(
  apiKey: any
): UsageStats {
  const metadata = apiKey.metadata
    ? JSON.parse(apiKey.metadata as string)
    : { subscriptionTier: "free" };

  const subscriptionTier = metadata.subscriptionTier || "free";

  return {
    apiKeyId: apiKey.id,
    subscriptionTier,
    requestCount: apiKey.requestCount || 0,
    remaining: apiKey.remaining || 0,
    lastRequest: apiKey.lastRequest,
    rateLimitMax: apiKey.rateLimitMax,
    rateLimitEnabled: apiKey.rateLimitEnabled || false,
    tierDescription: getTierDescription(subscriptionTier),
  };
}

/**
 * Get human-readable tier description
 */
function getTierDescription(tier: string): string {
  switch (tier) {
    case "free":
      return "25 requests/day";
    case "pro":
      return "100 requests/minute, 1000/day";
    case "enterprise":
      return "Unlimited";
    default:
      return "Unknown";
  }
}

/**
 * Calculate percentage of rate limit used
 */
export function getRateLimitPercentage(usage: UsageStats): number | null {
  if (!usage.rateLimitMax || usage.rateLimitMax === 0) {
    return null; // Unlimited or no limit
  }

  const total = usage.rateLimitMax - usage.remaining;
  return Math.round((total / usage.rateLimitMax) * 100);
}

/**
 * Check if rate limit is near threshold (> 80% used)
 */
export function isRateLimitNearLimit(usage: UsageStats): boolean {
  const percentage = getRateLimitPercentage(usage);
  return percentage !== null && percentage > 80;
}
```

**Output**: Usage stats helper

---

### Subtask 2.4.1.3: Add Tests

**File**: `packages/backend/convex/lib/__tests__/rateLimitConfig.test.ts`

**Tests**:

```typescript
import { describe, it, expect } from "vitest";
import { configureTierLimits, getTierLimits, type TierLimits } from "../rateLimitConfig";

describe("configureTierLimits", () => {
  describe("free tier", () => {
    it("should configure 25 requests/day limit", () => {
      const config = configureTierLimits("free");

      expect(config.rateLimitEnabled).toBe(true);
      expect(config.rateLimitMax).toBe(25);
      expect(config.rateLimitTimeWindow).toBe(86400000); // 1 day
      expect(config.metadata?.subscriptionTier).toBe("free");
    });
  });

  describe("pro tier", () => {
    it("should configure 100/min and 1000/day limits", () => {
      const config = configureTierLimits("pro");

      expect(config.rateLimitEnabled).toBe(true);
      expect(config.rateLimitMax).toBe(100);
      expect(config.rateLimitTimeWindow).toBe(60000); // 1 minute
      expect(config.refillInterval).toBe(60000);
      expect(config.refillAmount).toBe(100);
      expect(config.metadata?.subscriptionTier).toBe("pro");
    });
  });

  describe("enterprise tier", () => {
    it("should disable rate limiting", () => {
      const config = configureTierLimits("enterprise");

      expect(config.rateLimitEnabled).toBe(false);
      expect(config.rateLimitMax).toBeUndefined();
      expect(config.metadata?.subscriptionTier).toBe("enterprise");
    });
  });

  describe("getTierLimits", () => {
    it("should return correct limits for each tier", () => {
      const freeLimits = getTierLimits("free");
      const proLimits = getTierLimits("pro");
      const enterpriseLimits = getTierLimits("enterprise");

      expect(freeLimits.rateLimitMax).toBe(25);
      expect(proLimits.rateLimitMax).toBe(100);
      expect(enterpriseLimits.rateLimitMax).toBeNull();
    });
  });
});
```

**File**: `packages/backend/convex/lib/__tests__/usageHelpers.test.ts`

**Tests**:

```typescript
import { describe, it, expect } from "vitest";
import { getUsageStats, getRateLimitPercentage, isRateLimitNearLimit } from "../usageHelpers";

describe("getUsageStats", () => {
  it("should extract usage from Better Auth API key", () => {
    const apiKey = {
      id: "test-key-id",
      key: "nak_pk_test",
      userId: "user-123",
      requestCount: 10,
      remaining: 15,
      lastRequest: Date.now(),
      rateLimitMax: 25,
      rateLimitEnabled: true,
      metadata: JSON.stringify({ subscriptionTier: "free" }),
    };

    const stats = getUsageStats(apiKey);

    expect(stats.apiKeyId).toBe("test-key-id");
    expect(stats.subscriptionTier).toBe("free");
    expect(stats.requestCount).toBe(10);
    expect(stats.remaining).toBe(15);
    expect(stats.rateLimitMax).toBe(25);
    expect(stats.tierDescription).toBe("25 requests/day");
  });

  it("should default to free tier if metadata missing", () => {
    const apiKey = {
      id: "test-key-id",
      key: "nak_pk_test",
      userId: "user-123",
      requestCount: 0,
      remaining: 25,
      rateLimitMax: 25,
      rateLimitEnabled: true,
      metadata: null,
    };

    const stats = getUsageStats(apiKey);

    expect(stats.subscriptionTier).toBe("free");
  });
});

describe("getRateLimitPercentage", () => {
  it("should calculate percentage used", () => {
    const apiKey = {
      id: "test-key-id",
      key: "nak_pk_test",
      userId: "user-123",
      requestCount: 20,
      remaining: 5,
      rateLimitMax: 25,
      rateLimitEnabled: true,
      metadata: JSON.stringify({ subscriptionTier: "free" }),
    };

    const stats = getUsageStats(apiKey);
    const percentage = getRateLimitPercentage(stats);

    expect(percentage).toBe(80);
  });

  it("should return null for unlimited", () => {
    const apiKey = {
      id: "test-key-id",
      key: "nak_pk_test",
      userId: "user-123",
      requestCount: 1000,
      remaining: null,
      rateLimitMax: null,
      rateLimitEnabled: false,
      metadata: JSON.stringify({ subscriptionTier: "enterprise" }),
    };

    const stats = getUsageStats(apiKey);
    const percentage = getRateLimitPercentage(stats);

    expect(percentage).toBeNull();
  });
});

describe("isRateLimitNearLimit", () => {
  it("should return true when > 80% used", () => {
    const apiKey = {
      id: "test-key-id",
      key: "nak_pk_test",
      userId: "user-123",
      requestCount: 22,
      remaining: 3,
      rateLimitMax: 25,
      rateLimitEnabled: true,
      metadata: JSON.stringify({ subscriptionTier: "free" }),
    };

    const stats = getUsageStats(apiKey);
    const nearLimit = isRateLimitNearLimit(stats);

    expect(nearLimit).toBe(true);
  });

  it("should return false when < 80% used", () => {
    const apiKey = {
      id: "test-key-id",
      key: "nak_pk_test",
      userId: "user-123",
      requestCount: 10,
      remaining: 15,
      rateLimitMax: 25,
      rateLimitEnabled: true,
      metadata: JSON.stringify({ subscriptionTier: "free" }),
    };

    const stats = getUsageStats(apiKey);
    const nearLimit = isRateLimitNearLimit(stats);

    expect(nearLimit).toBe(false);
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.4.2 - Rate Limit Middleware (API route integration)

## Related

- Task 2.5.1: Create API Key Mutation (uses configureTierLimits)
- Task 2.6.1: Usage Query (uses getUsageStats)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.4.1 completed

Key decisions:
- Better Auth handles rate limiting automatically
- We only provide configuration and usage helpers
- No need for separate apiKeyUsage table (Better Auth has built-in counters)
- Use Better Auth's metadata field for subscriptionTier

Files changed:
- packages/backend/convex/lib/rateLimitConfig.ts
- packages/backend/convex/lib/usageHelpers.ts
- packages/backend/convex/lib/__tests__/rateLimitConfig.test.ts
- packages/backend/convex/lib/__tests__/usageHelpers.test.ts

Blockers: None
```
