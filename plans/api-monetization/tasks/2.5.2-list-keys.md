# Task 2.5.2: List Keys Query

## Goal

Create query to list user's API keys with pagination.

## Context

Users need to:
- View all their API keys
- See usage status
- Manage keys (enable/disable/delete)

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD
```json
{
  "category": "functional",
  "description": "Query to list user API keys with pagination",
  "steps": [
    "Create listApiKeys query with v.object() validators",
    "Use .withIndex() for O(log n) lookup",
    "Add .take() limit for pagination",
    "Return metadata (tier, usage, enabled status)",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Query created
- [ ] Pagination works
- [ ] Usage data included
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.5.2.1: Create Query

**File**: `packages/backend/convex/betterAuth/queries/listApiKeys.ts`


**Implementation**:

```typescript
import { v } from "convex/values";
import { query } from "../../_generated/server";
import type { Id } from "../../_generated/dataModel";

export interface ListApiKeysResult {
  apiKeys: Array<{
    _id: Id<"apikey">;
    name: string;
    key: string;
    subscriptionTier: "free" | "pro" | "enterprise";
    permissions: string[];
    enabled: boolean;
    createdAt: number;
    lastUsedAt: number | undefined;
    requestsToday: number;
    requestsThisMinute: number;
    dailyResetTime: number;
    minuteResetTime: number;
  }>;
  total: number;
}

export const listApiKeys = query({
  args: v.object({
    userId: v.id("users"),
    limit: v.optional(v.number()),
    cursor: v.optional(v.string()),
  }),
  returns: v.object({
    apiKeys: v.array(
      v.object({
        _id: v.id("apikey"),
        name: v.string(),
        key: v.string(),
        subscriptionTier: v.union(v.literal("free"), v.literal("pro"), v.literal("enterprise")),
        permissions: v.array(v.string()),
        enabled: v.boolean(),
        createdAt: v.number(),
        lastUsedAt: v.optional(v.number()),
        requestsToday: v.number(),
        requestsThisMinute: v.number(),
        dailyResetTime: v.number(),
        minuteResetTime: v.number(),
      })
    ),
    total: v.number(),
    nextCursor: v.optional(v.string()),
  }),
  handler: async (ctx, args) => {
    const { userId, limit = 10, cursor } = args;

    const apiKeysQuery = ctx.db
      .query("apikey")
      .withIndex("userId")
      .eq("userId", userId)
      .order("desc");

    const apiKeys = await apiKeysQuery.take(limit).collect();

    const apiKeyIds = apiKeys.map((k) => k._id);

    const usageRecords = await ctx.db
      .query("apiKeyUsage")
      .collect(apiKeyIds.map((id) => ({
        apiKeyId: id,
        requestsToday: v.optional(v.number()),
        requestsThisMinute: v.optional(v.number()),
        dailyResetTime: v.optional(v.number()),
        minuteResetTime: v.optional(v.number()),
      })));

    const usageMap = new Map(usageRecords.map((u) => [u.apiKeyId, u] as const));

    const enrichedKeys = apiKeys.map((key) => {
      const usage = usageMap.get(key._id);
      return {
        ...key,
        requestsToday: usage?.requestsToday ?? 0,
        requestsThisMinute: usage?.requestsThisMinute ?? 0,
        dailyResetTime: usage?.dailyResetTime ?? 0,
        minuteResetTime: usage?.minuteResetTime ?? 0,
      };
    });

    return {
      apiKeys: enrichedKeys,
      total: apiKeys.length,
      nextCursor: apiKeys.length >= limit ? apiKeys[apiKeys.length - 1]._id : undefined,
    };
  },
});
```

**Output**: Query created

---

### Subtask 2.5.2.2: Add Tests

**File**: `packages/backend/convex/betterAuth/__tests__/listApiKeys.test.ts`

**Tests**:

```typescript
describe("listApiKeys", () => {
  it("should list user's API keys", async () => {
    const result = await listApiKeys({
      userId: testUserId,
    });

    expect(result.apiKeys).toBeInstanceOf(Array);
    expect(result.total).toBeGreaterThan(0);
    expect(result.apiKeys[0].requestsToday).toBeDefined();
  });

  it("should respect limit parameter", async () => {
    await createTestKeys(15);

    const result5 = await listApiKeys({
      userId: testUserId,
      limit: 5,
    });

    expect(result5.apiKeys.length).toBe(5);
  });

  it("should include usage data", async () => {
    const result = await listApiKeys({
      userId: testUserId,
    });

    const firstKey = result.apiKeys[0];
    expect(firstKey.requestsToday).toBeDefined();
    expect(firstKey.requestsThisMinute).toBeDefined();
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.5.3 - Delete Key Mutation

## Related

- Task 2.5.1: Create Key (used by this query)
- Task 2.5.3: Delete Key (needs to handle usage)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.5.2 completed

Key decisions:
- Single query with collect(apiKeyIds) for O(n) lookup
- Enrich API keys with usage data
- Use cursor-based pagination

Files changed:
- packages/backend/convex/betterAuth/queries/listApiKeys.ts
- packages/backend/convex/betterAuth/__tests__/listApiKeys.test.ts

Blockers: None
```
