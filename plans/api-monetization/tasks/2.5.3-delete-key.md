# Task 2.5.3: Delete Key Mutation

## Goal

Create mutation to disable/delete API keys.

## Context

Users need to:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Delete unused keys
- Revoke compromised keys
- Clean up old keys

## PRD

```json
{
  "category": "functional",
  "description": "Mutation to delete API keys",
  "steps": [
    "Create deleteApiKey mutation",
    "Set enabled to false",
    "Add reason field",
    "Log to securityEvents",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Mutation created
- [ ] Key disabled (enabled=false)
- [ ] Revoke reason stored
- [ ] Security event logged
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.5.3.1: Create Mutation

**File**: `packages/backend/convex/betterAuth/mutations/deleteApiKey.ts`

**Implementation**:

```typescript
import { v } from "convex/values";
import { internalMutation } from "../../_generated/server";

export const deleteApiKey = internalMutation({
  args: v.object({
    apiKeyId: v.id("apikey"),
    reason: v.optional(v.string()),
  }),
  returns: v.object({
    success: v.boolean(),
  }),
  handler: async (ctx, args) => {
    const apiKey = await ctx.db.get("apikey", args.apiKeyId);

    if (!apiKey) {
      return { success: false };
    }

    await ctx.db.patch("apikey", args.apiKeyId, {
      enabled: false,
      lastRevokeReason: args.reason ?? "user_requested",
      revokedAt: Date.now(),
    });

    await ctx.db.insert("securityEvents", {
      type: "api_key_deleted",
      severity: "info",
      apiKeyId: args.apiKeyId,
      userId: apiKey.userId,
      details: JSON.stringify({ reason: args.reason }),
      createdAt: Date.now(),
    });

    return { success: true };
  },
});
```

**Output**: Mutation created

---

### Subtask 2.5.3.2: Add Tests

**File**: `packages/backend/convex/betterAuth/__tests__/deleteApiKey.test.ts`

**Tests**:

```typescript
describe("deleteApiKey", () => {
  it("should delete API key", async () => {
    const result = await deleteApiKey({
      apiKeyId: testApiKeyId,
      reason: "No longer needed",
    });

    expect(result.success).toBe(true);
  });

  it("should set enabled to false", async () => {
    await deleteApiKey({ apiKeyId: testApiKeyId });

    const apiKey = await ctx.db.get("apikey", testApiKeyId);
    expect(apiKey?.enabled).toBe(false);
    expect(apiKey?.revokedAt).toBeDefined();
  });

  it("should log security event", async () => {
    await deleteApiKey({ apiKeyId: testApiKeyId });

    const events = await ctx.db.query("securityEvents")
      .withIndex("apiKeyId")
      .eq("apiKeyId", testApiKeyId)
      .collect();

    expect(events.some((e) => e.type === "api_key_deleted")).toBe(true);
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.5.4 - Update Key Mutation

## Related

- Task 2.5.1: Create Key (used by this)
- Task 2.5.2: List Keys (shows deleted keys)
- Task 2.5.4: Update Key (alternative to delete)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.5.3 completed

Key decisions:
- Soft delete (set enabled=false instead of db.delete)
- Keep record for audit trail
- Log to securityEvents table

Files changed:
- packages/backend/convex/betterAuth/mutations/deleteApiKey.ts
- packages/backend/convex/betterAuth/__tests__/deleteApiKey.test.ts

Blockers: None
```
