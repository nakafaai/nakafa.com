# Task 0.1: Internal API Key Storage

## üéØ Goal

Store internal API key securely in both Vercel and Convex environment variables for redundant access.

## üìç Context

This is **Phase 0.1** of Foundation phase.

Internal content endpoints need authentication. Internal API key must be:

- Stored in Vercel environment variables (for API app)
- Stored in Convex environment variables (for serverless functions)
- Accessible to all internal systems
- Rotatable (can be changed quarterly)

## PRD

```json
{
  "category": "security",
  "description": "Internal API key stored in both Vercel and Convex for redundancy",
  "steps": [
    "Generate secure random API key",
    "Add to Vercel environment variables",
    "Add to Convex environment variables",
    "Verify both systems can access key",
    "Document rotation procedure"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] `INTERNAL_CONTENT_API_KEY` environment variable set in Vercel
- [ ] `INTERNAL_CONTENT_API_KEY` environment variable set in Convex
- [ ] Key is cryptographically strong (32+ chars)
- [ ] Rotation procedure documented
- [ ] Test verifies key accessible from both systems

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck  
pnpm test
```

## üìù Subtasks

### Subtask 0.1.1: Generate Secure API Key

Generate cryptographically strong internal API key.

**Command**: Run from root directory

```bash
# Generate 32-byte random key (base64url encoded)
node -e "console.log(require('crypto').randomBytes(32).toString('base64url'))"
```

**Expected Output**:

```txt
# Example: a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0u1V2w3
```

**Security Requirements**:

- ‚úÖ Minimum 32 bytes (256 bits)
- ‚úÖ Base64url encoded (URL-safe characters)
- ‚úÖ Random generation (not predictable)

**Output**: Generated internal API key

---

### Subtask 0.1.2: Add to Vercel Environment Variables

Configure Vercel to store and expose internal API key.

**File to modify**: Vercel dashboard (no file)

**Steps**:

1. Navigate to Vercel dashboard: <https://vercel.com/dashboard>
2. Select `api` project
3. Go to Settings ‚Üí Environment Variables
4. Add new variable:
   - **Name**: `INTERNAL_CONTENT_API_KEY`
   - **Value**: Paste generated key
   - **Environment**: All (Production, Preview, Development)
5. Click Save

**Verification**:

```bash
# From root directory
pnpm --filter api dev
```

Check logs show key is accessible:

```typescript
// apps/api/lib/internal-auth.ts (to be created in Task 1.1)
const INTERNAL_API_KEY = process.env.INTERNAL_CONTENT_API_KEY;

if (!INTERNAL_API_KEY) {
  throw new Error("INTERNAL_CONTENT_API_KEY not set");
}
```

**Output**: Key available in Vercel API app

---

### Subtask 0.1.3: Add to Convex Environment Variables

Configure Convex to store and expose internal API key.

**File to modify**: Convex dashboard (no file)

**Steps**:

1. Navigate to Convex dashboard: <https://dashboard.convex.dev>
2. Select `nakafa` project
3. Go to Settings ‚Üí Environment Variables
4. Add new variable:
   - **Name**: `INTERNAL_CONTENT_API_KEY`
   - **Value**: Paste generated key
   - **Environment**: All (Production, Development)
5. Click Save

**Convex Usage Example** (Task 1.3):

```typescript
// packages/connection/env.ts
export const env = createEnv({
  server: {
    INTERNAL_CONTENT_API_KEY: z.string().min(1),
  },
  runtimeEnv: {
    INTERNAL_CONTENT_API_KEY: process.env.INTERNAL_CONTENT_API_KEY,
  },
});
```

**Output**: Key available in Convex functions

---

### Subtask 0.1.4: Document Rotation Procedure

Create procedure for regularly rotating internal API key.

**File to create**: `plans/api-monetization/docs/internal-key-rotation.md`

**Content**:

```markdown
# Internal API Key Rotation

## Why Rotate?

- **Security**: Reduce exposure window if key compromised
- **Best practice**: Quarterly rotation recommended
- **Compliance**: Some standards require regular rotation

## Rotation Procedure

### 1. Generate New Key

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('base64url'))"
```

### 2. Update Vercel

1. Go to Vercel dashboard
2. Update `INTERNAL_CONTENT_API_KEY` environment variable
3. Save changes

### 3. Update Convex

1. Go to Convex dashboard
2. Update `INTERNAL_CONTENT_API_KEY` environment variable
3. Save changes

### 4. Deploy Changes

```bash
pnpm build
git add .
git commit -m "Rotate internal API key"
git push
```

### 5. Verify Access

- Test internal endpoints still work
- Verify AI tools can fetch content
- Check logs show new key being used

## Notes

- **Zero downtime**: Deploy both systems simultaneously
- **Backward compatible**: Both old and new keys work during deployment
- **Monitor**: Watch for any authentication failures during rotation

**Output**: Rotation procedure documented

---

### Subtask 0.1.5: Verify Key Accessibility

Test that both Vercel and Convex can access internal API key.

**Test File**: `plans/api-monetization/__tests__/0.1-internal-key-storage.test.ts`

**Test Cases**:

```typescript
describe("Internal API Key Storage", () => {
  describe("Vercel accessibility", () => {
    it("should have INTERNAL_CONTENT_API_KEY in Vercel env", () => {
      // Test will run in Vercel environment
      expect(process.env.INTERNAL_CONTENT_API_KEY).toBeDefined();
      expect(process.env.INTERNAL_CONTENT_API_KEY.length).toBeGreaterThan(32);
    });
  });

  describe("Convex accessibility", () => {
    it("should have INTERNAL_CONTENT_API_KEY in Convex env", async () => {
      // Test will run in Convex environment
      const result = await ctx.runQuery(
        internal.testing.queries.getEnvVar,
        { name: "INTERNAL_CONTENT_API_KEY" }
      );
      expect(result.value).toBeDefined();
      expect(result.value.length).toBeGreaterThan(32);
    });
  });

  describe("key strength", () => {
    it("should be base64url encoded", () => {
      const key = process.env.INTERNAL_CONTENT_API_KEY;
      expect(key).toMatch(/^[A-Za-z0-9_\-]+$/);
    });

    it("should be at least 32 chars", () => {
      const key = process.env.INTERNAL_CONTENT_API_KEY;
      expect(key.length).toBeGreaterThanOrEqual(32);
    });
  });
});
```

**Coverage**:

- ‚úÖ Vercel env variable accessible
- ‚úÖ Convex env variable accessible
- ‚úÖ Key is base64url encoded
- ‚úÖ Key is strong (32+ chars)

**Output**: Verification tests passing

---

## üöÄ Next Steps

After completing this task:

1. **Next task**: Task 0.2 - Extend Better Auth Schema

## üîó Related Tasks

- Task 1.1: Create Internal Auth Middleware (uses this key)
- Task 1.2: Apply Internal Auth to Content Routes (validates this key)
- Task 1.3: Update Internal Fetcher to Use Auth (passes this key)

## ‚ö†Ô∏è Important Notes

### Security

- **Never log** the key value
- **Never commit** the key to git
- **Use environment variables** (not hardcoded)
- **Rotate quarterly** (or on suspected compromise)
- **Use different keys** for different environments (dev/staging/prod)

### Redundancy Strategy

- **Dual storage**: Both Vercel and Convex
- **Purpose**: If one system is compromised, other still works
- **Sync required**: Both must have same value

### DX Considerations

- **Zero code changes**: Pure configuration
- **Immediate effect**: No redeploy needed for access
- **Clear documentation**: Rotation procedure is well-defined

### Progress Tracking

After completing this task, update `plans/api-monetization/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 0.1 completed

Key decisions:
- Use 32-byte random base64url encoded key
- Store in both Vercel and Convex for redundancy
- Rotate quarterly per security best practices

Files changed:
- plans/api-monetization/docs/internal-key-rotation.md (created)

Blockers/notes:
- None. Ready to proceed to Task 0.2.
```
