# Task 5.1: Alert Helpers

## Goal

Create helper functions for alerting.

## Context

Alerting needs:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Email sending helpers
- Alert formatting
- Testable pure functions

## PRD

```json
{
  "category": "architecture",
  "description": "Helper functions for alerting",
  "steps": [
    "Create email formatting helpers",
    "Create alert type helpers",
    "Add unit tests"
  ],
  "passes": false
}
```

## Success

- [ ] Formatting helpers created
- [ ] Alert helpers created
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 5.1.1: Create Email Formatting

**File**: `packages/backend/convex/model/alerting.ts`

```typescript
export interface AlertEmail {
  to: string;
  subject: string;
  html: string;
}

export function createRateLimitEmail(
  apiKeyId: string,
  rateLimitType: "daily" | "minute",
  retryAfter: number
): AlertEmail {
  return {
    to: "user@example.com",
    subject: "API Rate Limit Exceeded",
    html: `<p>Your API key (${apiKeyId}) has ${rateLimitType} limit exceeded.</p>
<p>Retry after: ${Math.ceil(retryAfter / 60000)} minutes.</p>
<p>Check your usage at /v1/me/usage</p>`,
  };
}

export function createRevocationEmail(
  apiKeyId: string,
  reason: string
): AlertEmail {
  return {
    to: "user@example.com",
    subject: "API Key Revoked",
    html: `<p>Your API key (${apiKeyId}) has been revoked.</p>
<p>Reason: ${reason}</p>
<p>If you believe this is an error, contact support.</p>`,
  };
}

export function createScrapingAlertEmail(
  apiKeyId: string,
  alertType: string
): AlertEmail {
  return {
    to: "user@example.com",
    subject: "Scraping Alert",
    html: `<p>Scraping pattern detected for API key (${apiKeyId}).</p>
<p>Alert type: ${alertType}</p>
<p>Your account may be temporarily suspended.</p>`,
  };
}
```

**Output**: Email helpers

---

### Subtask 5.1.2: Add Tests

**File**: `packages/backend/convex/model/__tests__/alerting.test.ts`

```typescript
import { describe, it, expect } from "vitest";
import { createRateLimitEmail, createRevocationEmail, createScrapingAlertEmail } from "../alerting";

describe("alerting", () => {
  it("should create rate limit email", () => {
    const email = createRateLimitEmail("key-123", "daily", 3600);

    expect(email.subject).toBe("API Rate Limit Exceeded");
    expect(email.html).toContain("Retry after");
  });

  it("should create revocation email", () => {
    const email = createRevocationEmail("key-123", "automated_scraping");

    expect(email.subject).toBe("API Key Revoked");
    expect(email.html).toContain("Reason: automated_scraping");
  });

  it("should create scraping alert email", () => {
    const email = createScrapingAlertEmail("key-123", "sequential_access");

    expect(email.subject).toBe("Scraping Alert");
    expect(email.html).toContain("sequential_access");
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 5.2 - Email Implementation

## Related

- Task 5.1: Alert Helpers (used by email actions)
- Task 5.3: Security Dashboard (displays alerts)

## Progress

```
[YYYY-MM-DD HH:mm] Task 5.1 completed

Key decisions:
- Pure functions for email formatting
- Reusable helpers for all alert types
- HTML email format for rich rendering

Files changed:
- packages/backend/convex/model/alerting.ts
- packages/backend/convex/model/__tests__/alerting.test.ts

Blockers: None
```
