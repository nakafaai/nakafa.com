# Task 2.5.4: Update Key Mutation

## Goal

Create mutation to update API key metadata.

## Context

Users need to:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Rename keys
- Change tier
- Update permissions
- Update key limits

## PRD

```json
{
  "category": "functional",
  "description": "Mutation to update API key properties",
  "steps": [
    "Create updateApiKey mutation",
    "Allow updating name, tier, permissions",
    "Update usage records on tier change",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Mutation created
- [ ] Name can be updated
- [ ] Tier can be changed
- [ ] Permissions can be updated
- [ ] Usage counters reset on tier change
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.5.4.1: Create Mutation

**File**: `packages/backend/convex/betterAuth/mutations/updateApiKey.ts`

**Implementation**:

```typescript
import { v } from "convex/values";
import { internalMutation } from "../../_generated/server";
import { TIER_LIMITS } from "../../model/rateLimit";

export const updateApiKey = internalMutation({
  args: v.object({
    apiKeyId: v.id("apikey"),
    name: v.optional(v.string()),
    subscriptionTier: v.optional(v.union(
      v.literal("free"),
      v.literal("pro"),
      v.literal("enterprise")
    )),
    permissions: v.optional(v.array(v.string())),
    enabled: v.optional(v.boolean()),
  }),
  returns: v.object({
    success: v.boolean(),
  }),
  handler: async (ctx, args) => {
    const apiKey = await ctx.db.get("apikey", args.apiKeyId);

    if (!apiKey) {
      return { success: false };
    }

    const updates: any = {};

    if (args.name !== undefined) {
      updates.name = args.name;
    }

    if (args.subscriptionTier !== undefined) {
      updates.subscriptionTier = args.subscriptionTier;
      const newLimits = TIER_LIMITS[args.subscriptionTier];

      await ctx.db.patch("apiKeyUsage", args.apiKeyId, {
        rateLimitDaily: newLimits.rateLimitDaily,
        rateLimitMinute: newLimits.rateLimitMinute,
      });
    }

    if (args.permissions !== undefined) {
      updates.permissions = args.permissions;
    }

    if (args.enabled !== undefined) {
      updates.enabled = args.enabled;
    }

    await ctx.db.patch("apikey", args.apiKeyId, updates);

    await ctx.db.insert("securityEvents", {
      type: "api_key_updated",
      severity: "info",
      apiKeyId: args.apiKeyId,
      userId: apiKey.userId,
      details: JSON.stringify({ updates }),
      createdAt: Date.now(),
    });

    return { success: true };
  },
});
```

**Output**: Mutation created

---

### Subtask 2.5.4.2: Add Tests

**File**: `packages/backend/convex/betterAuth/__tests__/updateApiKey.test.ts`

**Tests**:

```typescript
describe("updateApiKey", () => {
  it("should update name", async () => {
    const result = await updateApiKey({
      apiKeyId: testApiKeyId,
      name: "New Name",
    });

    expect(result.success).toBe(true);

    const apiKey = await ctx.db.get("apikey", testApiKeyId);
    expect(apiKey?.name).toBe("New Name");
  });

  it("should update tier", async () => {
    const result = await updateApiKey({
      apiKeyId: testApiKeyId,
      subscriptionTier: "pro",
    });

    expect(result.success).toBe(true);

    const apiKey = await ctx.db.get("apikey", testApiKeyId);
    expect(apiKey?.subscriptionTier).toBe("pro");

    const usage = await ctx.db.get("apiKeyUsage", testApiKeyId);
    expect(usage?.rateLimitDaily).toBe(1000);
  });

  it("should update permissions", async () => {
    const result = await updateApiKey({
      apiKeyId: testApiKeyId,
      permissions: ["contents", "search"],
    });

    expect(result.success).toBe(true);

    const apiKey = await ctx.db.get("apikey", testApiKeyId);
    expect(apiKey?.permissions).toEqual(["contents", "search"]);
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.5.5 - API Key Routes

## Related

- Task 2.5.1: Create Key (used by this)
- Task 2.5.2: List Keys (shows updated keys)
- Task 2.5.3: Delete Key (alternative to this)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.5.4 completed

Key decisions:
- Update usage counters when tier changes
- Log to securityEvents for audit
- Allow updating all mutable fields

Files changed:
- packages/backend/convex/betterAuth/mutations/updateApiKey.ts
- packages/backend/convex/betterAuth/__tests__/updateApiKey.test.ts

Blockers: None
```
