# Task 4.2: IP-Based Limiting

## Goal

Track IP addresses and detect API key sharing.

## Context

IP tracking detects:
- API key sharing (same key from multiple IPs)
- Unusual access patterns
- Geographic distribution

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD
```json
{
  "category": "functional",
  "description": "IP-based rate limiting and key sharing detection",
  "steps": [
    "Create IP tracking helpers",
    "Add IP logging to content access",
    "Detect API key sharing",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] IP tracking created
- [ ] Sharing detection implemented
- [ ] Logs show IPs
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.2.1: Create IP Tracking

**File**: `packages/backend/convex/model/ipTracking.ts`

**Implementation**:

```typescript
export interface IPAccess {
  apiKeyId: string;
  ipAddress: string;
  firstSeenAt: number;
  lastSeenAt: number;
  requestCount: number;
}

export async function trackIPAccess(
  apiKeyId: string,
  ipAddress: string
): Promise<{ isNew: boolean; totalIPs: number }> {
  const now = Date.now();
  const oneWeekAgo = now - 604800000;

  const existingIPs = await ctx.db
    .query("apiKeyIPs")
    .withIndex("apiKeyId_firstSeenAt")
    .eq("apiKeyId", apiKeyId)
    .gte("lastSeenAt", oneWeekAgo)
    .collect();

  const existingIP = existingIPs.find((ip) => ip.ipAddress === ipAddress);

  if (existingIP) {
    await ctx.db.patch("apiKeyIPs", existingIP._id, {
      lastSeenAt: now,
      requestCount: existingIP.requestCount + 1,
    });

    return { isNew: false, totalIPs: existingIPs.length };
  }

  await ctx.db.insert("apiKeyIPs", {
    apiKeyId,
    ipAddress,
    firstSeenAt: now,
    lastSeenAt: now,
    requestCount: 1,
  });

  return { isNew: true, totalIPs: 1 };
}
```


**Output**: IP tracking

---

### Subtask 4.2.2: Detect Key Sharing

**File**: `packages/backend/convex/model/ipTracking.ts`

**Changes**:

```typescript
export async function detectKeySharing(
  apiKeyId: string
): Promise<{ sharing: boolean; ipCount: number }> {
  const oneHourAgo = Date.now() - 3600000;

  const recentIPs = await ctx.db
    .query("apiKeyIPs")
    .withIndex("apiKeyId_lastSeenAt")
    .eq("apiKeyId", apiKeyId)
    .gte("lastSeenAt", oneHourAgo)
    .collect();

  const ipCount = recentIPs.length;

  if (ipCount >= 5) {
    return { sharing: true, ipCount };
  }

  return { sharing: false, ipCount };
}
```

**Output**: Key sharing detection

---

### Subtask 4.2.3: Integrate with Content Access

**File**: `packages/backend/convex/contents/mutations/logAccess.ts`

**Changes**:

```typescript
import { trackIPAccess } from "../../model/ipTracking";

export const logContentAccess = mutation({
  args: v.object({
    apiKeyId: v.id("apikey"),
    contentSlug: v.string(),
    action: v.string(),
    ipAddress: v.string(),
  }),
  returns: v.object({
    success: v.boolean(),
  }),
  handler: async (ctx, args) => {
    await ctx.db.insert("contentAccessLog", {
      apiKeyId: args.apiKeyId,
      contentSlug: args.contentSlug,
      action: args.action,
      ipAddress: args.ipAddress,
      accessedAt: Date.now(),
    });

    await trackIPAccess(args.apiKeyId, args.ipAddress);

    return { success: true };
  },
});
```

**Output**: IP tracking integrated

---

### Subtask 4.2.4: Add Tests

**File**: `packages/backend/convex/model/__tests__/ipTracking.test.ts`

**Tests**:

```typescript
describe("IP Tracking", () => {
  it("should track new IP address", async () => {
    const result = await trackIPAccess(testApiKeyId, "192.168.1.1");

    expect(result.isNew).toBe(true);
    expect(result.totalIPs).toBe(1);
  });

  it("should update existing IP", async () => {
    await trackIPAccess(testApiKeyId, "192.168.1.1");
    await trackIPAccess(testApiKeyId, "192.168.1.2");

    const result = await trackIPAccess(testApiKeyId, "192.168.1.3");

    expect(result.isNew).toBe(false);
    expect(result.totalIPs).toBe(3);
  });

  it("should detect key sharing", async () => {
    for (let i = 0; i < 5; i++) {
      await trackIPAccess(testApiKeyId, `192.168.1.${i}`);
    }

    const result = await detectKeySharing(testApiKeyId);

    expect(result.sharing).toBe(true);
    expect(result.ipCount).toBe(5);
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.3 - Request Signatures

## Related

- Task 4.1: Velocity Detection (complementary security)
- Task 4.3: Request Signatures (adds cryptographic proof)
- Task 4.5: Auto-Revocation (triggers on sharing)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.2 completed

Key decisions:
- Track IP addresses per API key
- Detect sharing when 5+ IPs in 1 hour
- Use 7-day retention for IP records
- Integrate with content access logging

Files changed:
- packages/backend/convex/model/ipTracking.ts
- packages/backend/convex/contents/mutations/logAccess.ts
- packages/backend/convex/model/__tests__/ipTracking.test.ts

Blockers: None
```
