# Task 4.5.1: Revocation Helpers

## Goal

Create helper functions for API key revocation.

## Context

Revocation needs:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Helper functions in model directory
- Proper reason tracking
- Testable pure functions

## PRD

```json
{
  "category": "functional",
  "description": "Helper functions for API key revocation",
  "steps": [
    "Create revocation reason types",
    "Create revocation helpers",
    "Add unit tests"
  ],
  "passes": false
}
```

## Success

- [ ] Reason types defined
- [ ] Helpers created
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.5.1.1: Create Revocation Types

**File**: `packages/backend/convex/model/revocation.ts`

```typescript
export type RevocationReason =
  | "automated_scraping"
  | "api_key_sharing"
  | "rate_limit_abuse"
  | "manual_admin"
  | "user_requested"
  | "investigation_pending"
  | "false_positive";

export interface RevocationSeverity {
  reason: RevocationReason;
  severity: "critical" | "warning" | "info";
}

export const REVOCATION_SEVERITY: Record<RevocationReason, RevocationSeverity> = {
  automated_scraping: { reason: "automated_scraping", severity: "critical" },
  api_key_sharing: { reason: "api_key_sharing", severity: "critical" },
  rate_limit_abuse: { reason: "rate_limit_abuse", severity: "critical" },
  manual_admin: { reason: "manual_admin", severity: "info" },
  user_requested: { reason: "user_requested", severity: "info" },
  investigation_pending: { reason: "investigation_pending", severity: "warning" },
  false_positive: { reason: "false_positive", severity: "info" },
} as const;

export function getRevocationSeverity(reason: RevocationReason): RevocationSeverity {
  return REVOCATION_SEVERITY[reason];
}
```

**Output**: Revocation types

---

### Subtask 4.5.1.2: Create Revocation Helpers

**File**: `packages/backend/convex/model/revocation.ts` (update)

```typescript
export function shouldAutoRevoke(severity: "critical" | "warning" | "info"): boolean {
  return severity === "critical";
}

export function createRevocationDetails(reason: RevocationReason): string {
  const timestamp = new Date().toISOString();
  return JSON.stringify({ reason, timestamp });
}
```

**Output**: Helpers created

---

### Subtask 4.5.1.3: Add Tests

**File**: `packages/backend/convex/model/__tests__/revocation.test.ts`

```typescript
import { describe, it, expect } from "vitest";
import { getRevocationSeverity, shouldAutoRevoke } from "../revocation";

describe("revocation", () => {
  it("should map reasons to severity", () => {
    expect(getRevocationSeverity("automated_scraping").severity).toBe("critical");
    expect(getRevocationSeverity("false_positive").severity).toBe("info");
  });

  it("should auto-revoke critical reasons", () => {
    expect(shouldAutoRevoke("critical")).toBe(true);
    expect(shouldAutoRevoke("info")).toBe(false);
  });

  it("should create revocation details", () => {
    const details = createRevocationDetails("automated_scraping");

    expect(details).toContain("automated_scraping");
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.5.2 - Revoke Mutation

## Related

- Task 4.1.1: Scraping Helpers (triggers this)
- Task 4.2.2: IP Tracking (can trigger this)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.5.1 completed

Key decisions:
- Centralized reason to severity mapping
- Clear auto-revoke logic
- Testable helper functions

Files changed:
- packages/backend/convex/model/revocation.ts
- packages/backend/convex/model/__tests__/revocation.test.ts

Blockers: None
```
