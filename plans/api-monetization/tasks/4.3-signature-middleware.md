# Task 4.3: Signature Middleware

## Goal

Add Hono middleware for signature verification.

## Context

Middleware needs to:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Verify signatures from clients
- Apply to protected routes
- Work with Convex helpers

## PRD

```json
{
  "category": "security",
  "description": "Hono middleware for request signature verification",
  "steps": [
    "Create requireSignature middleware",
    "Verify signatures using helpers",
    "Return 401 on invalid signatures",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Middleware created
- [ ] Signatures verified
- [ ] 401 on invalid
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.3.1: Create Middleware

**File**: `packages/backend/convex/routes/middleware/signature.ts`

```typescript
import type { MiddlewareHandler } from "hono";
import type { ActionCtx } from "../../../_generated/server";
import { verifySignature } from "../../model/requestSignature";
import { HTTP_UNAUTHORIZED } from "../constants";

export const requireSignature = (maxAge: number = 60000): MiddlewareHandler<{
  Bindings: ActionCtx;
  Variables: {
    apiKeyId: string;
  };
}> => {
  return async (c, next) => {
    const apiKeyId = c.get("apiKeyId");

    if (!apiKeyId) {
      return c.json({ error: "API key ID not found" }, { status: 500 });
    }

    const signature = c.req.header("X-Signature");
    const timestampStr = c.req.header("X-Timestamp");
    const timestamp = timestampStr ? Number.parseInt(timestampStr) : 0;

    if (!signature || !timestamp) {
      return c.json({ error: "Signature or timestamp missing" }, { status: HTTP_UNAUTHORIZED });
    }

    const apiKey = await c.env.runQuery(api.betterAuth.queries.getApiKeyWithSecret, { id: apiKeyId }));

    if (!apiKey || !apiKey.signingSecret) {
      return c.json({ error: "Signing secret not found" }, { status: 500 });
    }

    const isValid = verifySignature(
      apiKey.signingSecret,
      signature,
      c.req.method,
      c.req.url,
      await c.req.text(),
      timestamp,
      maxAge
    );

    if (!isValid) {
      await c.env.runMutation(api.security.mutations.logSignatureFailure, {
        apiKeyId,
        signature,
        timestamp,
        ip: c.req.header("CF-Connecting-IP"),
      });

      return c.json({ error: "Invalid signature or expired timestamp" }, { status: HTTP_UNAUTHORIZED });
    }

    await next();
  };
};
```

**Output**: Middleware created

---

### Subtask 4.3.2: Add Tests

**File**: `packages/backend/convex/routes/__tests__/signature-middleware.test.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from "vitest";

describe("requireSignature", () => {
  it("should reject missing signature", async () => {
    const middleware = requireSignature();
    await middleware(mockContextNoSignature, mockNext);

    expect(mockNext).toHaveBeenCalledWith();
    expect(mockResponse.status).toBe(401);
  });

  it("should reject expired timestamp", async () => {
    const middleware = requireSignature(60000);
    const oldTimestamp = Date.now() - 70000;

    await middleware(mockContextWithOldTimestamp(oldTimestamp), mockNext);

    expect(mockNext).toHaveBeenCalledWith();
    expect(mockResponse.status).toBe(401);
  });

  it("should accept valid signature", async () => {
    const middleware = requireSignature();
    const validSignature = generateValidSignature();

    await middleware(mockContextWithValidSignature(validSignature), mockNext);

    expect(mockNext).toHaveBeenCalledWith();
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.4 - Watermarking

## Related

- Task 4.3: Request Signatures (helpers used)
- Task 4.5: Auto-Revocation (triggers on signature failures)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.3 completed

Key decisions:
- Configurable maxAge for timestamp validation
- Log all signature failures for forensics
- Use Hono middleware pattern

Files changed:
- packages/backend/convex/routes/middleware/signature.ts
- packages/backend/convex/routes/__tests__/signature-middleware.test.ts

Blockers: None
```
