# Task 2.6.1: Usage Query

## Goal

Create query to fetch API usage statistics.

## Context

Users need to see:
- Today's usage
- Historical usage
- Usage by tier
- Rate limit status

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD

```json
{
  "category": "functional",
  "description": "Query to fetch API usage statistics",
  "steps": [
    "Create getUsage query with v.object() validators",
    "Use .withIndex() for O(1) lookup",
    "Return daily/minute/counters",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Query created
- [ ] Returns usage data
- [ ] O(1) lookup
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.6.1.1: Create Query

**File**: `packages/backend/convex/betterAuth/queries/getUsage.ts`


**Implementation**:

```typescript
import { v } from "convex/values";
import { query } from "../../_generated/server";
import type { Id } from "../../_generated/dataModel";

export const getUsage = query({
  args: v.object({
    apiKeyId: v.id("apikey"),
  }),
  returns: v.object({
    apiKeyId: v.id("apikey"),
    subscriptionTier: v.union(v.literal("free"), v.literal("pro"), v.literal("enterprise")),
    requestsToday: v.number(),
    requestsThisMinute: v.number(),
    lastRequestTime: v.number(),
    dailyResetTime: v.number(),
    minuteResetTime: v.number(),
  }),
  handler: async (ctx, args) => {
    const usage = await ctx.db
      .query("apiKeyUsage")
      .withIndex("apiKeyId")
      .eq("apiKeyId", args.apiKeyId)
      .unique();

    if (!usage) {
      return null;
    }

    return usage;
  },
});
```

**Output**: Query created

---

### Subtask 2.6.1.2: Add Tests

**File**: `packages/backend/convex/betterAuth/__tests__/getUsage.test.ts`

**Tests**:

```typescript
describe("getUsage", () => {
  it("should return usage data", async () => {
    const usage = await getUsage({ apiKeyId: testApiKeyId });

    expect(usage).toBeDefined();
    expect(usage?.subscriptionTier).toBeDefined();
    expect(usage?.requestsToday).toBeGreaterThanOrEqual(0);
  });

  it("should return null for non-existent key", async () => {
    const usage = await getUsage({ apiKeyId: invalidApiKeyId });

    expect(usage).toBeNull();
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.6.2 - Usage Route

## Related

- Task 2.4.1: Rate Limit Model (usage data structure)
- Task 2.6.2: Usage Route (uses this query)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.6.1 completed

Key decisions:
- O(1) lookup via .withIndex().unique()
- Return full usage object
- Return null for missing keys

Files changed:
- packages/backend/convex/betterAuth/queries/getUsage.ts
- packages/backend/convex/betterAuth/__tests__/getUsage.test.ts

Blockers: None
```
