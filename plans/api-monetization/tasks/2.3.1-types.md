# Task 2.3.1: Create Search Request/Response Types

## Goal

Create TypeScript interfaces for search endpoint following Convex best practices.

## Context

This is **Phase 2.3.1** of Build Public Content API phase.

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

Search endpoint needs type-safe interfaces for:
- Request parameters (query, filters, limits)
- Response structure (results, relevance, pagination)
- Search result items (metadata + snippets)

## PRD
```json
{
  "category": "architecture",
  "description": "Type-safe interfaces for search endpoint",
  "steps": [
    "Create SearchContentsRequest interface",
    "Create SearchContentsResponse interface",
    "Create SearchResult interface",
    "Define relevance score range type"
  ],
  "passes": false
}
```

## Success Criteria

- [ ] `SearchContentsRequest` interface created
- [ ] `SearchContentsResponse` interface created
- [ ] `SearchResult` interface created
- [ ] RelevanceScore type defined
- [ ] All types export correctly

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.3.1.1: Create Request Interface

Create TypeScript interface for search request.

**File to create**: `packages/backend/convex/routes/v1/contents/search/types.ts`

**Implementation**:

```typescript
export interface SearchContentsRequest {
  query: string;
  locale?: "en" | "id";
  type?: "articles" | "subject" | "exercises";
  limit?: number;
}
```

**Output**: Request interface

---

### Subtask 2.3.1.2: Create Response Interface

Create TypeScript interface for search response.

**File to modify**: `packages/backend/convex/routes/v1/contents/search/types.ts`

**Implementation**:

```typescript
export interface SearchContentsResponse {
  results: SearchResult[];
  total: number;
  query: string;
  searchTime: number;
}

export interface SearchResult {
  slug: string;
  url: string;
  locale: string;
  type: "articles" | "subject" | "exercises";
  title: string;
  description: string;
  snippet: string;
  relevanceScore: RelevanceScore;
  metadata: {
    tags: string[];
    category?: string;
    grade?: string;
    material?: string;
  };
}

export type RelevanceScore = 0 | 0.1 | 0.2 | 0.3 | 0.4 | 0.5 | 0.6 | 0.7 | 0.8 | 0.9 | 1;
```

**Output**: Response interfaces

---

### Subtask 2.3.1.3: Add Type Constraints

Create type guards and validation helpers.

**File to modify**: `packages/backend/convex/routes/v1/contents/search/types.ts`

**Implementation**:

```typescript
export interface SearchConstraints {
  MAX_LIMIT: 100;
  MIN_QUERY_LENGTH: 1;
  MAX_QUERY_LENGTH: 200;
}

export const SEARCH_CONSTANTS: SearchConstraints = {
  MAX_LIMIT: 100,
  MIN_QUERY_LENGTH: 1,
  MAX_QUERY_LENGTH: 200,
} as const;

export function validateSearchRequest(request: SearchContentsRequest): { valid: boolean; error?: string } {
  const { query, limit } = request;

  if (!query || query.trim().length === 0) {
    return { valid: false, error: "Query parameter is required" };
  }

  if (query.length < SEARCH_CONSTANTS.MIN_QUERY_LENGTH) {
    return { valid: false, error: `Query must be at least ${SEARCH_CONSTANTS.MIN_QUERY_LENGTH} character` };
  }

  if (query.length > SEARCH_CONSTANTS.MAX_QUERY_LENGTH) {
    return { valid: false, error: `Query must not exceed ${SEARCH_CONSTANTS.MAX_QUERY_LENGTH} characters` };
  }

  if (limit && (limit < 1 || limit > SEARCH_CONSTANTS.MAX_LIMIT)) {
    return { valid: false, error: `Limit must be between 1 and ${SEARCH_CONSTANTS.MAX_LIMIT}` };
  }

  return { valid: true };
}
```

**Output**: Type constraints

---

## Next Steps

After completing this task:

1. **Next task**: Task 2.3.2 - Implement Search Algorithm

## Related Tasks

- Task 2.3.2: Implement Search Algorithm (uses these types)
- Task 2.3.3: Implement Route Handler (uses these types)
- Task 2.3.4: Add Unit Tests (validates these types)

## Important Notes

### Type Safety

- Strict interfaces prevent runtime errors
- RelevanceScore type prevents invalid scores
- Type guards catch invalid inputs early

### DX Considerations

- Clear error messages from type guards
- Constants defined in one place
- Reusable across all search-related code

### Implementation Notes

These types will be used with Convex actions. Search algorithm (next task) must follow best practices from `../CONVEX_GUIDE.md`.

### Future Enhancements

- Consider adding `sort` parameter type
- Consider adding `highlightMatches` option
- Consider adding `searchFields` array

## Progress Tracking

After completing this task, update `plans/api-monetization/progress.txt`:

```
[YYYY-MM-DD HH:mm] Task 2.3.1 completed

Key decisions:
- Use RelevanceScore type (0-1) for type safety
- Add validation helpers for request constraints
- Define constants in one place for maintainability

Files changed:
- packages/backend/convex/routes/v1/contents/search/types.ts (created)

Blockers/notes:
- None. Ready for Task 2.3.2.
```
