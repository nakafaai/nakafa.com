# Task 2.2.2: Create Fetch Content Action

## Goal

Create Convex action to fetch content from internal source following Convex best practices.

## Context

This is **Phase 2.2.2** of Build Public Content API phase.

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

Content get endpoint needs to fetch content from internal source:
- Uses `getContents` utility from `@repo/contents/_lib/content`
- Runs in Convex action context
- Fetches from `/contents/*` internal endpoints
- Returns both metadata and full content

## PRD
```json
{
  "category": "functional",
  "description": "Create Convex action to fetch content from internal source",
  "steps": [
    "Create fetchContent action with proper args validator",
    "Call getContents utility with includeMDX flag",
    "Handle errors and return proper format",
    "Test action with various content types"
  ],
  "passes": false
}
```

## Success Criteria

- [ ] `fetchContent` action created
- [ ] Proper `v.object()` arg validator
- [ ] Returns proper `v.object()` result type
- [ ] Handles errors gracefully
- [ ] Unit tests pass

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck  
pnpm test
```

## Subtasks

### Subtask 2.2.2.1: Create Fetch Content Action

Create Convex action for fetching content.

**File to create**: `packages/backend/convex/contents/actions.ts` (or add to existing)

**Implementation**:

```typescript
import { v } from "convex/values";
import { action } from "../_generated/server";
import { getContents } from "@repo/contents/_lib/content";

export const fetchContent = action({
  args: v.object({
    slug: v.string(),
    includeMDX: v.boolean(),
    locale: v.optional(v.union(v.literal("en"), v.literal("id"))),
  }),
  returns: v.object({
    success: v.boolean(),
    content: v.optional(v.any()),
    error: v.optional(v.string()),
  }),
  handler: async (ctx, args) => {
    const { slug, includeMDX, locale } = args;

    try {
      const contents = await getContents({
        locale: locale || "en",
        basePath: slug,
        includeMDX,
      });

      if (!contents || contents.length === 0) {
        return {
          success: false,
          error: "Content not found",
        };
      }

      return {
        success: true,
        content: contents[0],
      };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : "Failed to fetch content",
      };
    }
  },
});
```

**Output**: Fetch content action created

---

### Subtask 2.2.2.2: Add Unit Tests

Test fetch content action for all scenarios.

**Test File**: `packages/backend/convex/contents/__tests__/actions.test.ts`

**Test Cases**:

```typescript
import { describe, it, expect, beforeAll } from "vitest";
import { api } from "../../_generated/api";

describe("fetchContent action", () => {
  let testUserId: Id<"users">;
  let testApiKeyId: Id<"apikey">;

  beforeAll(async () => {
    testUserId = await api.users.mutations.createTestUser({});
    testApiKeyId = await api.betterAuth.mutations.createApiKey({
      userId: testUserId,
      subscriptionTier: "free",
    });
  });

  describe("successful fetch", () => {
    it("should fetch article content", async () => {
      const result = await api.contents.actions.fetchContent({
        slug: "en/articles/politics/democracy",
        includeMDX: true,
      });

      expect(result.success).toBe(true);
      expect(result.content).toBeDefined();
      expect(result.content.metadata.title).toBeDefined();
      expect(result.content.raw).toBeDefined();
    });

    it("should fetch subject content", async () => {
      const result = await api.contents.actions.fetchContent({
        slug: "en/subject/mathematics/algebra",
        includeMDX: true,
      });

      expect(result.success).toBe(true);
      expect(result.content).toBeDefined();
    });

    it("should fetch exercise content", async () => {
      const result = await api.contents.actions.fetchContent({
        slug: "en/exercises/calculus/derivatives",
        includeMDX: true,
      });

      expect(result.success).toBe(true);
      expect(result.content).toBeDefined();
    });
  });

  describe("error handling", () => {
    it("should return error for missing content", async () => {
      const result = await api.contents.actions.fetchContent({
        slug: "en/articles/does-not-exist",
        includeMDX: true,
      });

      expect(result.success).toBe(false);
      expect(result.error).toBeDefined();
    });

    it("should handle includeMDX parameter correctly", async () => {
      const result1 = await api.contents.actions.fetchContent({
        slug: "en/articles/politics/democracy",
        includeMDX: true,
      });

      const result2 = await api.contents.actions.fetchContent({
        slug: "en/articles/politics/democracy",
        includeMDX: false,
      });

      expect(result1.content?.raw).toBeDefined();
      expect(result2.content?.raw).toBeUndefined();
    });
  });
});
```

**Coverage**:
- Successful fetch for articles
- Successful fetch for subjects
- Successful fetch for exercises
- Error handling for missing content
- includeMDX parameter handling

**Output**: Comprehensive test suite

---

## Next Steps

After completing this task:

1. **Next task**: Task 2.2.3 - Implement Get Route Handler

## Related Tasks

- Task 2.2.1: Create Get Content Types (uses these interfaces)
- Task 2.2.3: Implement Get Route Handler (uses this action)
- Task 2.1: Content List Endpoint (similar pattern)

## Important Notes

### Implementation Notes

- Actions run on server (better for security)
- Single transaction for all operations
- Proper error handling with typed results

### DX Considerations

- Type-safe args prevent runtime errors
- Consistent error format across all endpoints
- Simple success boolean pattern

### Performance

- No sequential calls to internal endpoints (uses existing utility)
- Single database round-trip
- Proper error handling prevents unnecessary retries

### Future Enhancements

- Consider adding caching for frequently accessed content
- Consider adding prefetching for related content
- Consider adding content versioning for cache busting

## Progress Tracking

After completing this task, update `plans/api-monetization/progress.txt`:

```
[YYYY-MM-DD HH:mm] Task 2.2.2 completed

Key decisions:
- Use existing getContents utility (no duplicate code)
- Keep action simple and focused
- Return both success flag and content/error

Files changed:
- packages/backend/convex/contents/actions.ts (created)
- packages/backend/convex/contents/__tests__/actions.test.ts (created)

Blockers/notes:
- None. Ready for Task 2.2.3.
```
