# Task 6.1: Security Tests

## Goal

Create comprehensive security test suite.

## Context

Testing needs to verify:
- Authentication works correctly
- Rate limiting enforced
- Scraping detection triggers
- Request signatures validated
- Watermarking applied
- Revocation works

## PRD

```json
{
  "category": "testing",
  "description": "Comprehensive security test suite",
  "steps": [
    "Create authentication tests",
    "Create rate limit tests",
    "Create scraping detection tests",
    "Create signature verification tests",
    "Create watermarking tests",
    "Create revocation tests",
    "Add integration tests"
  ],
  "passes": false
}
```

## Success

- [ ] All security tests pass
- [ ] Coverage is comprehensive
- [ ] Tests run in CI/CD

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 6.1.1: Authentication Tests

**File**: `packages/backend/convex/__tests__/security/auth.test.ts`

```typescript
import { describe, it, expect, beforeAll } from "vitest";

describe("Security Authentication", () => {
  let testApiKeyId;

  beforeAll(async () => {
    testApiKeyId = await api.betterAuth.mutations.createApiKey({
      userId: testUserId,
      subscriptionTier: "free",
    });
  });

  it("should reject missing API key", async () => {
    const result = await api.v1.contents.list({});

    expect(result.error).toBeDefined();
    expect(result.status).toBe(401);
  });

  it("should reject invalid API key", async () => {
    const result = await api.v1.contents.list({}, { apiKeyId: "invalid-key" });

    expect(result.error).toBeDefined();
    expect(result.status).toBe(401);
  });

  it("should accept valid API key", async () => {
    const result = await api.v1.contents.list({}, { apiKeyId: testApiKeyId });

    expect(result.contents).toBeDefined();
  });
});
```

**Output**: Auth tests

---

### Subtask 6.1.2: Rate Limit Tests

**File**: `packages/backend/convex/__tests__/security/rateLimit.test.ts`

```typescript
describe("Security Rate Limiting", () => {
  let testApiKeyId;

  beforeAll(async () => {
    testApiKeyId = await createFreeApiKey();
  });

  it("should enforce free tier limit", async () => {
    for (let i = 0; i < 25; i++) {
      await api.v1.contents.list({}, { apiKeyId: testApiKeyId });
    }

    const result26 = await api.v1.contents.list({}, { apiKeyId: testApiKeyId });

    expect(result.error).toBe("Rate limit exceeded");
  });

  it("should enforce pro tier limit", async () => {
    const proKeyId = await createProApiKey();

    for (let i = 0; i < 100; i++) {
      await api.v1.contents.list({}, { apiKeyId: proKeyId });
    }

    const result101 = await api.v1.contents.list({}, { apiKeyId: proKeyId });

    expect(result.error).toBe("Rate limit exceeded");
  });
});
```

**Output**: Rate limit tests

---

### Subtask 6.1.3: Scraping Detection Tests

**File**: `packages/backend/convex/__tests__/security/scraping.test.ts`

```typescript
describe("Security Scraping Detection", () => {
  let testApiKeyId;

  beforeAll(async () => {
    testApiKeyId = await createFreeApiKey();
  });

  it("should trigger on velocity exceeded", async () => {
    for (let i = 0; i < 101; i++) {
      await logAccess(testApiKeyId, `test-${i}`);
    }

    const result = await api.v1.contents.list({}, { apiKeyId: testApiKeyId });

    expect(result.error).toBe("Rate limit exceeded");
  });

  it("should trigger on bulk access", async () => {
    const paths = Array.from({ length: 60 }, (_, i) => `test-${i}`);

    for (const path of paths) {
      await logAccess(testApiKeyId, path);
    }

    const result = await api.v1.contents.list({}, { apiKeyId: testApiKeyId });

    expect(result.error).toBe("Rate limit exceeded");
  });
});
```

**Output**: Scraping tests

---

### Subtask 6.1.4: Signature Tests

**File**: `packages/backend/convex/__tests__/security/signatures.test.ts`

```typescript
describe("Security Signatures", () => {
  it("should reject invalid signature", async () => {
    const invalidSignature = "invalid-signature";
    const result = await api.v1.contents.list({}, {
      headers: {
        "X-Signature": invalidSignature,
        "X-Timestamp": Date.now().toString(),
      },
    });

    expect(result.error).toBeDefined();
    expect(result.status).toBe(401);
  });

  it("should reject expired timestamp", async () => {
    const oldTimestamp = Date.now() - 70000;

    const result = await api.v1.contents.list({}, {
      headers: {
        "X-Timestamp": oldTimestamp.toString(),
        "X-Signature": generateValidSignature(),
      },
    });

    expect(result.error).toBeDefined();
    expect(result.status).toBe(401);
  });
});
```

**Output**: Signature tests

---

### Subtask 6.1.5: Revocation Tests

**File**: `packages/backend/convex/__tests__/security/revocation.test.ts`

```typescript
describe("Security Revocation", () => {
  let testApiKeyId;

  beforeAll(async () => {
    testApiKeyId = await createProApiKey();
  });

  it("should revoke key", async () => {
    await revokeKey({ apiKeyId: testApiKeyId, reason: "automated_scraping" });

    const apiKey = await ctx.db.get("apikey", testApiKeyId);

    expect(apiKey?.enabled).toBe(false);
  });

  it("should unban key", async () => {
    await unbanKey({ apiKeyId: testApiKeyId, adminNotes: "False positive" });

    const apiKey = await ctx.db.get("apikey", testApiKeyId);

    expect(apiKey?.enabled).toBe(true);
  });
});
```

**Output**: Revocation tests

---

## Next Steps

After: Task 6.2 - Load Tests

## Related

- All Phase 1-5 tasks tested here

## Progress

```
[YYYY-MM-DD HH:mm] Task 6.1 completed

Key decisions:
- Comprehensive test coverage of all security layers
- Tests for auth, rate limits, scraping, signatures, revocation
- Edge cases covered

Files changed:
- packages/backend/convex/__tests__/security/auth.test.ts
- packages/backend/convex/__tests__/security/rateLimit.test.ts
- packages/backend/convex/__tests__/security/scraping.test.ts
- packages/backend/convex/__tests__/security/signatures.test.ts
- packages/backend/convex/__tests__/security/revocation.test.ts

Blockers: None
```
