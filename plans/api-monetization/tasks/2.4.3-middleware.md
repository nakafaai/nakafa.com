# Task 2.4.3: Rate Limit Middleware

## Goal

Create Hono middleware for rate limiting all API routes.

## Context

Middleware needs to:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Wrap checkRateLimit mutation
- Return proper HTTP status (429)
- Add Retry-After header
- Be reusable across routes

## PRD
```json
{
  "category": "functional",
  "description": "Hono middleware for rate limiting",
  "steps": [
    "Create requireRateLimit middleware",
    "Call checkRateLimit mutation",
    "Handle 429 responses with headers",
    "Add rate limit remaining to context"
  ],
  "passes": false
}
```

## Success

- [ ] Middleware created
- [ ] Returns 429 on exceeded
- [ ] Adds Retry-After header
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.4.3.1: Create Middleware

**File**: `packages/backend/convex/routes/middleware/rateLimit.ts`

**Implementation**:

```typescript
import type { MiddlewareHandler } from "hono";
import type { Id } from "../../_generated/dataModel";
import { HTTP_TOO_MANY_REQUESTS } from "../constants";

export const requireRateLimit = (
  resource: string,
  action: string,
): MiddlewareHandler<{
  Bindings: any;
  Variables: {
    apiKeyId: Id<"apikey">;
  };
}> => {
  return async (c, next) => {
    const apiKeyId = c.get("apiKeyId");

    if (!apiKeyId) {
      return c.json(
        { error: "API key ID not found in context" },
        { status: 500 }
      );
    }

    const result = await c.env.runMutation(
      internal.betterAuth.mutations.checkRateLimit,
      { apiKeyId, resource, action }
    );

    if (!result.allowed) {
      return c.json(
        {
          error: "Rate limit exceeded",
          retryAfter: result.retryAfter,
          remaining: result.remaining,
        },
        {
          status: HTTP_TOO_MANY_REQUESTS,
          headers: {
            "Retry-After": result.retryAfter?.toString() ?? "0",
            "X-RateLimit-Remaining": result.remaining?.toString() ?? "0",
          },
        }
      );
    }

    c.set("rateLimitRemaining", result.remaining);
    await next();
  };
};
```

**Output**: Middleware

---

### Subtask 2.4.3.2: Add Tests

**File**: `packages/backend/convex/routes/__tests__/middleware-rateLimit.test.ts`

**Tests**:

```typescript
describe("requireRateLimit middleware", () => {
  it("should call checkRateLimit mutation", async () => {
    const middleware = requireRateLimit("contents", "get");
    await middleware(mockContext, mockNext);

    expect(mockEnv.runMutation).toHaveBeenCalledWith(
      internal.betterAuth.mutations.checkRateLimit,
      expect.objectContaining({
        apiKeyId: testApiKeyId,
        resource: "contents",
        action: "get",
      })
    );
  });

  it("should return 429 when limit exceeded", async () => {
    const middleware = requireRateLimit("contents", "get");
    const result = await middleware(mockContextWithExceeded, mockNext);

    expect(result.status).toBe(429);
    expect(result.headers.get("Retry-After")).toBeDefined();
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.4.4 - Rate Limit Tests

## Related

- Task 2.4.1: Model (helper used)
- Task 2.4.2: Mutation (called by middleware)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.4.3 completed

Key decisions:
- Reusable middleware pattern
- Headers for client-side tracking
- Context-based remaining quota

Files changed:
- packages/backend/convex/routes/middleware/rateLimit.ts
- packages/backend/convex/routes/__tests__/middleware-rateLimit.test.ts

Blockers: None
```
