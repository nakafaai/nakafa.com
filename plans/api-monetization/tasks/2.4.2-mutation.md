# Task 2.4.2: Rate Limit Mutation

## Goal

Create checkRateLimit mutation using helper from model directory.

## Context

Mutation needs to:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Call helper function from `model/rateLimit.ts`
- Wrap with proper v.object() validators
- Follow Convex best practices

## PRD
```json
{
  "category": "functional",
  "description": "Rate limit mutation with v.object() validators",
  "steps": [
    "Create checkRateLimit mutation",
    "Use helper from model/rateLimit.ts",
    "Add proper args and returns validators",
    "Test all tier scenarios"
  ],
  "passes": false
}
```

## Success

- [ ] Mutation created
- [ ] Uses helper function
- [ ] v.object() validators correct
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.4.2.1: Create Mutation

**File**: `packages/backend/convex/betterAuth/mutations/rateLimit.ts`

**Implementation**:

```typescript
import { v } from "convex/values";
import { internalMutation } from "../../_generated/server";
import { checkRateLimitHelper, type RateLimitCheckArgs } from "../../model/rateLimit";

export const checkRateLimit = internalMutation({
  args: v.object({
    apiKeyId: v.id("apikey"),
    resource: v.string(),
    action: v.string(),
  }),
  returns: v.object({
    allowed: v.boolean(),
    retryAfter: v.optional(v.number()),
    remaining: v.optional(v.number()),
  }),
  handler: async (ctx, args: RateLimitCheckArgs) => {
    return await checkRateLimitHelper(ctx, args);
  },
});
```

**Output**: Mutation created

---

### Subtask 2.4.2.2: Add Tests

**File**: `packages/backend/convex/betterAuth/__tests__/rateLimit.test.ts`

**Tests**:

```typescript
describe("checkRateLimit mutation", () => {
  it("should call helper function", async () => {
    const result = await checkRateLimit({
      apiKeyId: testApiKeyId,
      resource: "contents",
      action: "get",
    });

    expect(result.allowed).toBeDefined();
  });

  it("should enforce free tier limit", async () => {
    for (let i = 0; i < 25; i++) {
      await checkRateLimit({
        apiKeyId: freeKeyId,
        resource: "contents",
        action: "get",
      });
    }

    const result = await checkRateLimit({
      apiKeyId: freeKeyId,
      resource: "contents",
      action: "get",
    });

    expect(result.allowed).toBe(false);
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 2.4.3 - Middleware

## Related

- Task 2.4.1: Model (helper used here)
- Task 2.4.3: Middleware (uses this mutation)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.4.2 completed

Key decisions:
- Use helper from model/ directory
- Wrap with v.object() validators
- Keep mutation thin

Files changed:
- packages/backend/convex/betterAuth/mutations/rateLimit.ts
- packages/backend/convex/betterAuth/__tests__/rateLimit.test.ts

Blockers: None
```
