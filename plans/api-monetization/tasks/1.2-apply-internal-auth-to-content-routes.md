# Task 1.2: Apply Internal Auth to Content Routes

## üéØ Goal

Apply internal API key authentication to all `/contents/[locale]/*` endpoints to prevent unauthorized access.

## üìç Context

This is **Phase 1.2** of Secure Internal Content Endpoints phase.

Currently, all content endpoints are **completely public**:

- `/contents/[locale]/articles/[...slug]/route.ts`
- `/contents/[locale]/subject/[...slug]/route.ts`
- `/contents/[locale]/exercises/[...slug]/route.ts`
- `/contents/[locale]/quran/[surah]/route.ts`

Anyone can call these endpoints to scrape your entire content library.

This task applies `requireInternalApiKey()` middleware (created in Task 1.1) to all content routes.

## PRD

```json
{
  "category": "security",
  "description": "Apply internal API key authentication to all 4 content routes",
  "steps": [
    "Add requireInternalApiKey import to articles route",
    "Validate API key before fetching content in articles route",
    "Repeat for subject, exercises, and quran routes",
    "Verify 401 response on missing/invalid key",
    "Test AI tools can still fetch content"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] All 4 content routes protected with internal auth
- [ ] Middleware called before any content fetch
- [ ] Invalid requests return 401 consistently
- [ ] Valid requests (internal key) work as before
- [ ] No breaking changes to AI tools (they still work)
- [ ] All routes have consistent error handling

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck  
pnpm test
```

## üìù Subtasks

### Subtask 1.2.1: Protect Articles Route

Add internal auth to `/contents/[locale]/articles/[...slug]/route.ts`.

**File to modify**: `apps/api/app/contents/[locale]/articles/[...slug]/route.ts`

**Changes Required**:

```typescript
// Add import at top
import { requireInternalApiKey } from "@/lib/internal-auth";

// Modify GET function
export async function GET(
  req: Request, // Add req parameter
  { params }: { params: Promise<{ locale: string; slug: string[] }> }
) {
  const authResult = await requireInternalApiKey(req);

  if (authResult.error) {
    return authResult.error;
  }

  const { locale, slug } = await params;
  const basePath = slug.join("/");
  const cleanPath = `articles/${basePath}` as const;

  return NextResponse.json(content);
}
```

**Verification**:

```bash
# Should FAIL (no internal key)
curl https://api.nakafa.com/contents/en/articles/politics

# Should SUCCEED (with internal key)
curl https://api.nakafa.com/contents/en/articles/politics \
  -H "Authorization: Bearer ${INTERNAL_CONTENT_API_KEY}"
```

**Output**: Articles route protected

---

### Subtask 1.2.2: Protect Subject Route

Add internal auth to `/contents/[locale]/subject/[...slug]/route.ts`.

**File to modify**: `apps/api/app/contents/[locale]/subject/[...slug]/route.ts`

**Changes Required**:

```typescript
import { requireInternalApiKey } from "@/lib/internal-auth";

export async function GET(
  req: Request,
  { params }: { params: Promise<{ locale: string; slug: string[] }> }
) {
  const authResult = await requireInternalApiKey(req);

  if (authResult.error) {
    return authResult.error;
  }

  const { locale, slug } = await params;
  return NextResponse.json(content);
}
```

**Output**: Subject route protected

---

### Subtask 1.2.3: Protect Exercises Route

Add internal auth to `/contents/[locale]/exercises/[...slug]/route.ts`.

**File to modify**: `apps/api/app/contents/[locale]/exercises/[...slug]/route.ts`

**Changes Required**:

```typescript
import { requireInternalApiKey } from "@/lib/internal-auth";

export async function GET(
  req: Request,
  { params }: { params: Promise<{ locale: string; slug: string[] }> }
) {
  const authResult = await requireInternalApiKey(req);

  if (authResult.error) {
    return authResult.error;
  }

  const { locale, slug } = await params;
  return NextResponse.json(content);
}
```

**Output**: Exercises route protected

---

### Subtask 1.2.4: Protect Quran Route

Add internal auth to `/contents/[locale]/quran/[surah]/route.ts`.

**File to modify**: `apps/api/app/contents/[locale]/quran/[surah]/route.ts`

**Changes Required**:

```typescript
import { requireInternalApiKey } from "@/lib/internal-auth";

export async function GET(
  req: Request,
  { params }: { params: Promise<{ surah: string }> }
) {
  const authResult = await requireInternalApiKey(req);

  if (authResult.error) {
    return authResult.error;
  }

  const { surah } = await params;
  return NextResponse.json(content);
}
```

**Output**: Quran route protected

---

### Subtask 1.2.5: Test AI Tools Still Work

Verify that AI tools (chat, etc.) can still fetch content.

**Test Scenario**:

AI tools in `packages/ai/tools/content.ts` call:

```typescript
await api.contents.getContent({ slug });
```

This calls `packages/connection/lib/fetcher.ts` which will:

1. Make request to `/contents/[locale]/[...slug]`
2. Include `Authorization: Bearer ${INTERNAL_CONTENT_API_KEY}` header (in Task 1.3)
3. Receive full content

**Verification Steps**:

```bash
# 1. Start API app locally
pnpm --filter api dev

# 2. Start www app locally
pnpm --filter www dev

# 3. Test chat functionality
# Navigate to http://localhost:3000/chat
# Ask AI to explain a content page
# Verify AI can fetch and explain content

# 4. Check logs
# API should show successful internal auth
```

**Expected Result**:

- AI tools successfully fetch content
- No 401 errors in logs
- Chat functionality works as before

**Output**: Verified internal auth doesn't break AI tools

---

### Subtask 1.2.6: Update Health Endpoint Documentation

Document that `/contents/*` now requires authentication.

**Changes**:

- Update any README or API docs that mention `/contents/*` endpoints
- Document that these are **internal only**
- List that external developers should use `/v1/contents/*` (created in Phase 2)

**Documentation Update**:

```markdown
## Internal Content Endpoints

Purpose: Internal endpoints used by Nakafa's AI tools and internal systems.

Authentication: Internal API key required via `Authorization: Bearer <key>` header.

Access: These endpoints are not public. External developers must use public API at `/v1/contents/*`.

Endpoints:
- GET /contents/{locale}/articles/{slug}
- GET /contents/{locale}/subject/{slug}
- GET /contents/{locale}/exercises/{slug}
- GET /contents/{locale}/quran/{surah}
```

**Output**: Documentation updated

---

## üöÄ Next Steps

After completing this task:

1. **Next task**: Task 1.3 - Update Internal Fetcher to Use Auth

## üîó Related Tasks

- Task 1.1: Create Internal Auth Middleware (provides function used in this task)
- Task 1.3: Update Internal Fetcher to Use Auth (adds auth headers to requests)
- Task 2.1: Create Content List Endpoint (public API alternative)
- packages/ai/tools/content.ts: Uses content endpoints (must still work)

## ‚ö†Ô∏è Important Notes

### Breaking Change

This is a breaking change for direct access to `/contents/*`. Anyone calling these endpoints directly will now get 401 errors.

### No Breaking Change

AI tools will continue to work (they'll use internal key via fetcher). Users on nakafa.com will not be affected (they use chat, not direct API calls).

### Monitoring

After deployment, monitor logs for:

- Unexpected 401 errors (indicates something is calling without auth)
- AI tool errors (indicates internal auth is working correctly)

## Progress Tracking

After completing this task, update `plans/api-monetization/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 1.2 completed

Key decisions:
- Apply auth check at START of each GET handler
- Return error immediately if auth fails (no content fetch)
- Keep existing logic unchanged after auth check

Files changed:
- apps/api/app/contents/[locale]/articles/[...slug]/route.ts
- apps/api/app/contents/[locale]/subject/[...slug]/route.ts
- apps/api/app/contents/[locale]/exercises/[...slug]/route.ts
- apps/api/app/contents/[locale]/quran/[surah]/route.ts

Blockers/notes:
- None. Ready for Task 1.3.
```
