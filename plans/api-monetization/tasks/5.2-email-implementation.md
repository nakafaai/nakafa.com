# Task 5.2: Email Implementation

## Goal

Implement email sending via Resend.

## Context

Email needs to:
- Integrate with Resend API
- Send HTML emails
- Handle send failures
- Track sent emails

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD

```json
{
  "category": "functional",
  "description": "Resend email integration for alerts",
  "steps": [
    "Create sendEmail mutation",
    "Integrate with Resend API",
    "Add error handling",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Mutation created
- [ ] Resend integrated
- [ ] Errors handled
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 5.2.1: Create Email Mutation

**File**: `packages/backend/convex/emails/mutations/sendEmail.ts`


**Output**: Email mutation created

---

### Subtask 5.2.2: Add Tests

**File**: `packages/backend/convex/emails/__tests__/sendEmail.test.ts`

```typescript
import { describe, it, expect, beforeEach } from "vitest";

describe("sendEmail", () => {
  beforeEach(() => {
    process.env.RESEND_API_KEY = "test-key";
  });

  it("should send email successfully", async () => {
    const result = await sendEmail({
      to: "user@example.com",
      subject: "Test Email",
      html: "<p>Test content</p>",
    });

    expect(result.success).toBe(true);
  });

  it("should handle missing API key", async () => {
    delete process.env.RESEND_API_KEY;

    const result = await sendEmail({
      to: "user@example.com",
      subject: "Test",
      html: "<p>Test</p>",
    });

    expect(result.success).toBe(false);
    expect(result.error).toBe("Resend API key not configured");
  });

  it("should handle Resend API error", async () => {
    global.fetch = vi.fn().mockRejectedValue({
      ok: false,
      json: async () => ({ error: "API Error" }),
    });

    const result = await sendEmail({
      to: "user@example.com",
      subject: "Test",
      html: "<p>Test</p>",
    });

    expect(result.success).toBe(false);
    expect(result.error).toBeDefined();
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 5.3 - Security Dashboard

## Related

- Task 5.1: Alert Helpers (used by email actions)
- Task 5.3: Security Dashboard (displays emails)

## Progress

```
[YYYY-MM-DD HH:mm] Task 5.2 completed

Key decisions:
- Use action for Resend API calls
- Log sent emails to database for tracking
- Handle Resend API errors gracefully

Files changed:
- packages/backend/convex/emails/mutations/sendEmail.ts
- packages/backend/convex/emails/__tests__/sendEmail.test.ts

Blockers: None
```
