# Task 4.4.2: Watermark Middleware

## Goal

Add Hono middleware to apply watermarks to responses.

## Context

Middleware needs to:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Get API key ID from context
- Generate watermarks
- Prepend to content
- Be reusable across routes

## PRD

```json
{
  "category": "functional",
  "description": "Hono middleware for content watermarking",
  "steps": [
    "Create requireWatermark middleware",
    "Generate and apply watermarks",
    "Add to content routes",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Middleware created
- [ ] Watermarks applied
- [ ] Routes updated
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.4.2.1: Create Middleware

**File**: `packages/backend/convex/routes/middleware/watermark.ts`

```typescript
import type { MiddlewareHandler } from "hono";
import type { ActionCtx } from "../../../_generated/server";
import { createWatermark } from "../../model/watermarking";

export const requireWatermark = (): MiddlewareHandler<{
  Bindings: ActionCtx;
  Variables: {
    apiKeyId: string;
    content?: string;
  };
}> => {
  return async (c, next) => {
    const apiKeyId = c.get("apiKeyId");

    if (!apiKeyId) {
      return c.json({ error: "API key ID not found" }, { status: 500 });
    }

    const content = c.get("content");

    if (typeof content === "string") {
      const watermark = createWatermark(apiKeyId, "test-slug");

      const watermarkedContent = `${watermark}\n${content}`;
      c.set("content", watermarkedContent);
    }

    await next();
  };
};
```

**Output**: Middleware created

---

### Subtask 4.4.2.2: Add to Content Routes

**File**: `packages/backend/convex/routes/v1/index.ts`

```typescript
import { requireWatermark } from "../middleware/watermark";

v1.get("/contents/:slug", requireApiKey(), requireRateLimit("contents", "get"), requireWatermark(), async (c) => {
  const content = c.get("content");

  return c.json(content, { status: 200 });
});
```

**Output**: Routes updated

---

### Subtask 4.4.2.3: Add Tests

**File**: `packages/backend/convex/routes/__tests__/watermark-middleware.test.ts`

```typescript
import { describe, it, expect } from "vitest";

describe("requireWatermark", () => {
  it("should apply watermark to string content", async () => {
    const middleware = requireWatermark();
    await middleware(mockContextWithStringContent, mockNext);

    const content = mockContext.getString("content");
    expect(content).toContain("<!-- NAK:API:");
    expect(content).toContain(" -->");
  });

  it("should handle non-string content", async () => {
    const middleware = requireWatermark();
    await middleware(mockContextWithObjectContent, mockNext);

    await next();
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.5 - Auto-Revocation

## Related

- Task 4.4.1: Watermark Helpers (used by this middleware)
- Task 4.3: Request Signatures (similar middleware pattern)
- Task 4.5: Auto-Revocation (uses watermarks for leak detection)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.4.2 completed

Key decisions:
- Middleware stores watermarked content in context
- Watermarks prepended to content
- Simple and reusable pattern

Files changed:
- packages/backend/convex/routes/middleware/watermark.ts
- packages/backend/convex/routes/v1/index.ts
- packages/backend/convex/routes/__tests__/watermark-middleware.test.ts

Blockers: None
```
