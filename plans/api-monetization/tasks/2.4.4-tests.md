# Task 2.4.4: Rate Limit Tests

## Goal

Add comprehensive tests for rate limiting across all tiers.

## Context

Tests need to cover:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- All three tiers (free, pro, enterprise)
- Daily limits
- Minute limits
- Automatic resets
- Edge cases

## PRD
```json
{
  "category": "testing",
  "description": "Comprehensive rate limit tests for all tiers",
  "steps": [
    "Test free tier (25/day, no minute limit)",
    "Test pro tier (100/min, 1000/day)",
    "Test enterprise tier (unlimited)",
    "Test automatic resets (daily, minute)",
    "Test edge cases"
  ],
  "passes": false
}
```

## Success

- [ ] All tiers tested
- [ ] Daily limits enforced
- [ ] Minute limits enforced
- [ ] Resets working
- [ ] Edge cases covered

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 2.4.4.1: Add Tier Tests

**File**: `packages/backend/convex/betterAuth/__tests__/rateLimit-tiers.test.ts`

**Tests**:

```typescript
describe("Rate Limit Tiers", () => {
  describe("free tier", () => {
    it("should allow 25 requests per day", async () => {
      for (let i = 0; i < 25; i++) {
        const result = await checkRateLimit({
          apiKeyId: freeKeyId,
          resource: "contents",
          action: "get",
        });
        expect(result.allowed).toBe(true);
      }

      const result26 = await checkRateLimit({
        apiKeyId: freeKeyId,
        resource: "contents",
        action: "get",
      });
      expect(result26.allowed).toBe(false);
      expect(result26.retryAfter).toBeGreaterThan(0);
    });

    it("should not enforce minute limit", async () => {
      for (let i = 0; i < 150; i++) {
        await checkRateLimit({
          apiKeyId: freeKeyId,
          resource: "contents",
          action: "get",
        });
      }

      const result = await checkRateLimit({
        apiKeyId: freeKeyId,
        resource: "contents",
        action: "get",
      });
      expect(result.allowed).toBe(true);
    });
  });

  describe("pro tier", () => {
    it("should allow 100 requests per minute", async () => {
      for (let i = 0; i < 100; i++) {
        const result = await checkRateLimit({
          apiKeyId: proKeyId,
          resource: "contents",
          action: "get",
        });
        expect(result.allowed).toBe(true);
      }

      const result101 = await checkRateLimit({
        apiKeyId: proKeyId,
        resource: "contents",
        action: "get",
      });
      expect(result101.allowed).toBe(false);
      expect(result101.retryAfter).toBeGreaterThan(0);
    });

    it("should allow 1000 requests per day", async () => {
      for (let i = 0; i < 1000; i++) {
        await checkRateLimit({
          apiKeyId: proKeyId,
          resource: "contents",
          action: "get",
        });
      }

      const result1001 = await checkRateLimit({
        apiKeyId: proKeyId,
        resource: "contents",
        action: "get",
      });
      expect(result1001.allowed).toBe(false);
    });
  });

  describe("enterprise tier", () => {
    it("should allow unlimited requests", async () => {
      for (let i = 0; i < 10000; i++) {
        const result = await checkRateLimit({
          apiKeyId: enterpriseKeyId,
          resource: "contents",
          action: "get",
        });
        expect(result.allowed).toBe(true);
      }
    });
  });
});
```

**Output**: Tier tests

---

### Subtask 2.4.4.2: Add Reset Tests

**Tests for automatic resets**:

```typescript
describe("Rate Limit Resets", () => {
  it("should reset daily counter at midnight", async () => {
    const freeKeyId = await createApiKey("free");

    for (let i = 0; i < 25; i++) {
      await checkRateLimit({
        apiKeyId: freeKeyId,
        resource: "contents",
        action: "get",
      });
    }

    await sleep(120000);

    const result = await checkRateLimit({
      apiKeyId: freeKeyId,
      resource: "contents",
      action: "get",
    });

    expect(result.allowed).toBe(true);
    expect(result.remaining).toBe(24);
  });

  it("should reset minute counter on minute", async () => {
    const proKeyId = await createApiKey("pro");

    for (let i = 0; i < 100; i++) {
      await checkRateLimit({
        apiKeyId: proKeyId,
        resource: "contents",
        action: "get",
      });
    }

    await sleep(61000);

    const result = await checkRateLimit({
      apiKeyId: proKeyId,
      resource: "contents",
      action: "get",
    });

    expect(result.allowed).toBe(true);
    expect(result.remaining).toBe(999);
  });
});
```

**Output**: Reset tests

---

## Next Steps

After: Task 2.4.5 - Rate Limit Docs

## Related

- Task 2.4.1: Model (logic tested)
- Task 2.4.2: Mutation (tested)
- Task 2.4.3: Middleware (tested)

## Progress

```
[YYYY-MM-DD HH:mm] Task 2.4.4 completed

Key decisions:
- Test all three tiers
- Test automatic resets
- Use realistic limits in tests

Files changed:
- packages/backend/convex/betterAuth/__tests__/rateLimit-tiers.test.ts

Blockers: None
```
