# Task 4.3: Request Signatures

## Goal

Add cryptographic request signatures for tamper-proof requests.

## Context

Signatures provide:
- Request authenticity
- Tamper detection
- Evidence for revocation
- Replay attack prevention

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD
```json
{
  "category": "security",
  "description": "Request signature verification",
  "steps": [
    "Create signature helpers",
    "Add signature generation to client",
    "Add signature verification to server",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Signature helpers created
- [ ] Client signing implemented
- [ ] Server verification implemented
- [ ] Tamper detection working
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.3.1: Create Signature Helpers

**File**: `packages/backend/convex/model/requestSignature.ts`

**Implementation**:

```typescript
import crypto from "crypto";

export function generateSignature(
  apiKeySecret: string,
  method: string,
  path: string,
  body: string,
  timestamp: number
): string {
  const payload = `${method}:${path}:${body}:${timestamp}`;
  const signature = crypto
    .createHmac("sha256", apiKeySecret)
    .update(payload)
    .digest("hex");

  return signature;
}

export function verifySignature(
  apiKeySecret: string,
  signature: string,
  method: string,
  path: string,
  body: string,
  timestamp: number,
  maxAge: number = 60000
): boolean {
  const payload = `${method}:${path}:${body}:${timestamp}`;
  const expectedSignature = crypto
    .createHmac("sha256", apiKeySecret)
    .update(payload)
    .digest("hex");

  if (signature !== expectedSignature) {
    return false;
  }

  const now = Date.now();
  if (now - timestamp > maxAge) {
    return false;
  }

  return true;
}

export function generateTimestamp(): number {
  return Date.now();
}
```


**Output**: Signature helpers

---

### Subtask 4.3.2: Add Client Signature

**File**: `packages/connection/lib/signer.ts`

**Implementation**:

```typescript
import { generateSignature, generateTimestamp } from "@repo/backend/convex/model/requestSignature";

export function signRequest(
  apiKeySecret: string,
  method: string,
  path: string,
  body: string
): { signature: string; timestamp: number } {
  const timestamp = generateTimestamp();
  const signature = generateSignature(apiKeySecret, method, path, body, timestamp);

  return { signature, timestamp };
}

export function addAuthHeaders(
  apiKeySecret: string,
  method: string,
  path: string,
  body: string
): HeadersInit {
  const { signature, timestamp } = signRequest(apiKeySecret, method, path, body);

  return {
    "Authorization": `Bearer ${apiKeySecret}`,
    "X-Signature": signature,
    "X-Timestamp": timestamp.toString(),
  };
}
```

**Output**: Client signature

---

### Subtask 4.3.3: Add Server Verification

**File**: `packages/backend/convex/routes/middleware/signatureVerification.ts`

**Implementation**:

```typescript
import type { MiddlewareHandler } from "hono";
import { verifySignature, generateTimestamp } from "../../model/requestSignature";
import type { ActionCtx } from "../../../_generated/server";
import { HTTP_UNAUTHORIZED } from "../constants";

export const requireSignatureVerification = (maxAge: number = 60000): MiddlewareHandler<{
  Bindings: ActionCtx;
  Variables: {
    apiKeyId: string;
  };
}> => {
  return async (c, next) => {
    const apiKeyId = c.get("apiKeyId");

    if (!apiKeyId) {
      return c.json(
        { error: "API key ID not found" },
        { status: HTTP_UNAUTHORIZED }
      );
    }

    const apiKey = await c.env.runQuery(
      api.betterAuth.queries.getApiKeyWithSecret,
      { id: apiKeyId }
    );

    if (!apiKey || !apiKey.signingSecret) {
      return c.json(
        { error: "Signing secret not configured" },
        { status: HTTP_UNAUTHORIZED }
      );
    }

    const signature = c.req.header("X-Signature");
    const timestampStr = c.req.header("X-Timestamp");
    const timestamp = timestampStr ? Number.parseInt(timestampStr) : 0;

    if (!signature || !timestamp) {
      return c.json(
        { error: "Signature or timestamp missing" },
        { status: HTTP_UNAUTHORIZED }
      );
    }

    const isValid = verifySignature(
      apiKey.signingSecret,
      signature,
      c.req.method,
      c.req.url,
      await c.req.text(),
      timestamp,
      maxAge
    );

    if (!isValid) {
      await c.env.runMutation(
        api.security.mutations.logSignatureFailure,
        { apiKeyId, signature, timestamp, ip: c.req.header("CF-Connecting-IP") }
      );

      return c.json(
        { error: "Invalid signature or expired timestamp" },
        { status: HTTP_UNAUTHORIZED }
      );
    }

    await next();
  };
};
```

**Output**: Verification middleware

---

### Subtask 4.3.4: Add Tests

**File**: `packages/backend/convex/routes/__tests__/signatureVerification.test.ts`

**Tests**:

```typescript
describe("requireSignatureVerification", () => {
  it("should reject invalid signature", async () => {
    const result = await verifySignature(secret, "invalid", "GET", "/test", "", now, 60000);

    expect(result).toBe(false);
  });

  it("should reject expired timestamp", async () => {
    const oldTimestamp = Date.now() - 70000;
    const result = await verifySignature(secret, "valid", "GET", "/test", "", oldTimestamp, 60000);

    expect(result).toBe(false);
  });

  it("should accept valid signature", async () => {
    const signature = generateSignature(secret, "GET", "/test", "", now);
    const result = await verifySignature(secret, signature, "GET", "/test", "", now, 60000);

    expect(result).toBe(true);
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.4 - Watermarking

## Related

- Task 4.1: Velocity Detection (signatures add evidence)
- Task 4.4: Watermarking (another protection layer)
- Task 4.5: Auto-Revocation (triggers on signature failures)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.3 completed

Key decisions:
- Use HMAC-SHA256 for signatures
- Include timestamp for replay prevention
- Log all signature failures for forensics
- 60s max age for timestamps (configurable)

Files changed:
- packages/backend/convex/model/requestSignature.ts
- packages/connection/lib/signer.ts
- packages/backend/convex/routes/middleware/signatureVerification.ts
- packages/backend/convex/routes/__tests__/signatureVerification.test.ts

Blockers: None
```
