# Task 4.5.2: Revoke Mutation

## Goal

Create mutation to revoke API keys with reason tracking.

## Context

Mutation needs to:
- Set enabled to false
- Store revocation reason
- Log to security events
- Send email notification

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD

```json
{
  "category": "functional",
  "description": "Mutation to revoke API keys with reason tracking",
  "steps": [
    "Create revokeKey mutation with v.object() validators",
    "Use helpers from model/revocation.ts",
    "Log to securityEvents table",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Mutation created
- [ ] Key disabled
- [ ] Reason logged
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.5.2.1: Create Mutation

**File**: `packages/backend/convex/apikeys/mutations/revoke.ts`


**Output**: Mutation created

---

### Subtask 4.5.2.2: Add Tests

**File**: `packages/backend/convex/apikeys/__tests__/revoke.test.ts`

```typescript
import { describe, it, expect, beforeAll } from "vitest";
import { api } from "../../../_generated/api";

describe("revokeKey", () => {
  let testApiKeyId;

  beforeAll(async () => {
    testApiKeyId = await api.betterAuth.mutations.createApiKey({
      userId: testUserId,
      subscriptionTier: "free",
    });
  });

  it("should revoke key for scraping", async () => {
    const result = await revokeKey({
      apiKeyId: testApiKeyId,
      reason: "automated_scraping",
    });

    expect(result.success).toBe(true);

    const apiKey = await ctx.db.get("apikey", testApiKeyId);
    expect(apiKey?.enabled).toBe(false);
    expect(apiKey?.revokedAt).toBeDefined();
  });

  it("should log security event", async () => {
    await revokeKey({
      apiKeyId: testApiKeyId,
      reason: "automated_scraping",
    });

    const events = await ctx.db.query("securityEvents").collect();

    expect(events.some((e) => e.type === "api_key_revoked")).toBe(true);
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.5.3 - Unban Mutation

## Related

- Task 4.5.1: Revocation Helpers (used by this mutation)
- Task 4.5.3: Unban (restore falsely revoked keys)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.5.2 completed

Key decisions:
- Soft revoke (enabled: false instead of db.delete)
- Security events for audit trail
- Email notifications for critical revocations

Files changed:
- packages/backend/convex/apikeys/mutations/revoke.ts
- packages/backend/convex/apikeys/__tests__/revoke.test.ts

Blockers: None
```
