# Task 3.1: MCP Auth

## Goal

Add user token auth to MCP transport layer.

## Context

MCP tools need to:
See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

- Use user's subscription-based limits
- Validate user tokens
- Apply rate limits

## PRD
```json
{
  "category": "functional",
  "description": "MCP transport layer auth with user subscription limits",
  "steps": [
    "Add token validation to MCP transport",
    "Apply user subscription rate limits",
    "Update MCP tool handlers",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Token validation added
- [ ] Subscription limits applied
- [ ] MCP tools updated
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 3.1.1: Add Token Validation

**File**: `apps/mcp/lib/auth.ts`

**Implementation**:

```typescript
import { betterAuth } from "@repo/better-auth";

export async function validateUserToken(token: string): Promise<{ valid: boolean; userId?: string }> {
  try {
    const session = await betterAuth.api.getSession({ token });

    if (!session || !session.user) {
      return { valid: false };
    }

    return { valid: true, userId: session.user.id };
  } catch {
    return { valid: false };
  }
}
```

**Output**: Token validation

---

### Subtask 3.1.2: Update MCP Transport

**File**: `apps/mcp/index.ts`

**Changes**:

```typescript
import { validateUserToken } from "./lib/auth";

export async function initializeMCP(token: string) {
  const { valid, userId } = await validateUserToken(token);

  if (!valid) {
    throw new Error("Invalid user token");
  }

  return {
    userId,
    subscriptionTier: await getUserSubscriptionTier(userId),
  };
}
```

**Output**: MCP auth updated

---

### Subtask 3.1.3: Add Tests

**File**: `apps/mcp/lib/__tests__/auth.test.ts`

**Tests**:

```typescript
describe("validateUserToken", () => {
  it("should validate valid token", async () => {
    const result = await validateUserToken(validToken);

    expect(result.valid).toBe(true);
    expect(result.userId).toBeDefined();
  });

  it("should reject invalid token", async () => {
    const result = await validateUserToken("invalid-token");

    expect(result.valid).toBe(false);
    expect(result.userId).toBeUndefined();
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 3.2 - MCP Routes

## Related

- Task 3.2: MCP Routes (uses this auth)
- Task 3.3: Subscription Limits (applies to MCP)

## Progress

```
[YYYY-MM-DD HH:mm] Task 3.1 completed

Key decisions:
- Use better-auth for token validation
- Return userId and subscription tier
- Throw error on invalid tokens

Files changed:
- apps/mcp/lib/auth.ts
- apps/mcp/index.ts
- apps/mcp/lib/__tests__/auth.test.ts

Blockers: None
```
