# Task 4.1.2: Velocity Mutation

## Goal

Create mutation to check velocity and trigger alerts.

## Context

Mutation needs to:
- Fetch recent access logs
- Calculate metrics using helpers
- Detect velocity patterns
- Log alerts

See `../CONVEX_GUIDE.md` for Convex best practices (indexes, validators, helpers).

## PRD

```json
{
  "category": "functional",
  "description": "Velocity scraping detection mutation",
  "steps": [
    "Create checkVelocity mutation with v.object() validators",
    "Use helpers from model/scrapingDetection.ts",
    "Log alerts to scrapingAlerts table",
    "Add tests"
  ],
  "passes": false
}
```

## Success

- [ ] Mutation created
- [ ] Helpers used correctly
- [ ] Alerts logged
- [ ] Tests pass

## Commands

```bash
pnpm lint
pnpm typecheck
pnpm test
```

## Subtasks

### Subtask 4.1.2.1: Create Mutation

**File**: `packages/backend/convex/scraping/mutations/checkVelocity.ts`


**Output**: Mutation created

---

### Subtask 4.1.2.2: Add Tests

**File**: `packages/backend/convex/scraping/__tests__/checkVelocity.test.ts`

```typescript
import { describe, it, expect, beforeAll } from "vitest";
import { api } from "../../../_generated/api";

describe("checkVelocity", () => {
  let testApiKeyId;

  beforeAll(async () => {
    testApiKeyId = await api.betterAuth.mutations.createApiKey({
      userId: testUserId,
      subscriptionTier: "free",
    });
  });

  it("should detect sequential pattern", async () => {
    const result = await checkVelocity({ apiKeyId: testApiKeyId });

    expect(result.alertTriggered).toBe(true);
    expect(result.pattern).toBe("sequential");
  });

  it("should not alert on normal usage", async () => {
    const result = await checkVelocity({ apiKeyId: testApiKeyId });

    expect(result.alertTriggered).toBe(false);
    expect(result.pattern).toBe("normal");
  });
});
```

**Output**: Tests

---

## Next Steps

After: Task 4.2 - IP-Based Limiting

## Related

- Task 4.1.1: Scraping Helpers (used by this mutation)
- Task 4.2.2: IP Tracking (complementary security)

## Progress

```
[YYYY-MM-DD HH:mm] Task 4.1.2 completed

Key decisions:
- Use .withIndex().order().take() for O(log n) + performance
- Log alerts to separate scrapingAlerts table
- Return pattern type for downstream logic

Files changed:
- packages/backend/convex/scraping/mutations/checkVelocity.ts
- packages/backend/convex/scraping/__tests__/checkVelocity.test.ts

Blockers: None
```
