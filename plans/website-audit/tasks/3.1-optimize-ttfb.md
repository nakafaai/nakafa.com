# Task 2.1: Optimize Server Response Time (TTFB)

## üéØ Goal

Reduce Time to First Byte (TTFB) from 600-1631ms to under 600ms by implementing caching strategies and optimizing database queries.

## üìç Context

**Current Performance**:
- TTFB: 600-1631ms (should be <600ms)
- Worst offenders:
  - `/linear-methods/determinant-calculation`: 1631ms
  - `/linear-methods/characteristic-polynomial`: 1486ms
  - `/linear-methods/cramer-rule`: 1065ms

**Root Causes**:
1. No caching on Convex queries
2. Database queries executed on every request
3. No CDN edge caching
4. Complex content rendering on server
5. Missing database indexes

**Why This Matters**:
- Core Web Vitals requirement: TTFB < 600ms
- Affects LCP (Largest Contentful Paint)
- Google ranking factor
- User experience on slow connections

## PRD

```json
{
  "category": "performance",
  "description": "Implement caching strategies to reduce TTFB below 600ms",
  "steps": [
    "Add Convex query caching with React cache()",
    "Implement stale-while-revalidate for content pages",
    "Add database indexes for frequently queried fields",
    "Optimize content fetching with batched queries",
    "Add CDN edge caching headers",
    "Test TTFB on all page types",
    "Monitor Core Web Vitals in Search Console"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] TTFB < 600ms on all pages
- [ ] Lighthouse Performance score > 90
- [ ] No regression in content freshness
- [ ] Cache hit rate > 80%
- [ ] All tests pass
- [ ] No increase in server costs

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck
pnpm test

# Test TTFB
curl -o /dev/null -s -w "TTFB: %{time_starttransfer}s\n" https://nakafa.com/en
```

## üìù Implementation

### Subtask 2.1.1: Add Convex Query Caching

**File to modify**: `packages/backend/convex/contentSync/queries.ts`

Add caching wrapper for expensive queries:

```typescript
import { cache } from "react";

// Cache content metadata for 5 minutes
export const getCachedContentMetadata = cache(
  async (contentPath: string, locale: string) => {
    return await getContentMetadata(contentPath, locale);
  }
);

// Cache folder contents for 1 minute
export const getCachedFolderContents = cache(
  async (path: string) => {
    return await getFolderContents(path);
  }
);
```

### Subtask 2.1.2: Implement Stale-While-Revalidate

**File to modify**: `apps/www/app/[locale]/(study)/(main)/(contents)/[...slug]/page.tsx`

Add revalidation configuration:

```typescript
// Add at the top of the file
export const revalidate = 3600; // Revalidate every hour
export const dynamicParams = true;

// For content pages with specific caching needs
export async function generateStaticParams() {
  // Pre-generate popular pages at build time
  const popularPaths = [
    "subject/university/bachelor/ai-ds/ai-programming/python-step-1",
    "subject/university/bachelor/ai-ds/linear-methods/determinant",
    // Add more popular content paths
  ];
  
  return popularPaths.map((path) => ({
    slug: path.split("/"),
    locale: "en",
  }));
}
```

### Subtask 2.1.3: Add Database Indexes

**File to modify**: `packages/backend/convex/schema.ts`

Add indexes for frequently queried fields:

```typescript
export default defineSchema({
  content: defineTable({
    path: v.string(),
    locale: v.string(),
    type: v.string(),
    title: v.string(),
    updatedAt: v.number(),
    // ... other fields
  })
    .index("by_path_locale", ["path", "locale"])
    .index("by_type_updated", ["type", "updatedAt"])
    .index("by_locale_type", ["locale", "type"]),
  
  // Add indexes for other frequently queried tables
  authors: defineTable({
    slug: v.string(),
    name: v.string(),
  }).index("by_slug", ["slug"]),
});
```

### Subtask 2.1.4: Optimize Content Fetching

**File to modify**: Content fetching utilities

Implement batched queries:

```typescript
// Instead of multiple individual queries
const [metadata, authors, related] = await Promise.all([
  getContentMetadata(path, locale),
  getContentAuthors(path),
  getRelatedContent(path),
]);

// Use batched query where possible
const contentData = await ctx.runQuery(
  api.contentSync.getFullContent,
  { path, locale }
);
```

### Subtask 2.1.5: Add CDN Caching Headers

**File to modify**: `apps/www/next.config.ts`

Add caching headers for static assets:

```typescript
async headers() {
  return [
    {
      source: "/:path*",
      headers: securityHeaders,
    },
    {
      source: "/_next/static/:path*",
      headers: [
        {
          key: "Cache-Control",
          value: "public, max-age=31536000, immutable",
        },
      ],
    },
    {
      source: "/images/:path*",
      headers: [
        {
          key: "Cache-Control",
          value: "public, max-age=86400, stale-while-revalidate=86400",
        },
      ],
    },
  ];
}
```

---

## üöÄ Next Steps

After this task:
- Next: Task 2.2 - Reduce DOM Size
- Dependencies: None

## üîó Related Tasks

- Task 2.2: Reduce DOM Size (performance)
- Task 2.3: Preload Critical Resources (performance)

## ‚ö†Ô∏è Important Notes

### Cache Invalidation

When content is updated:
1. Webhook triggers cache purge
2. Or use time-based expiration (current approach)
3. For immediate updates, use `revalidatePath()`

### Convex Caching

Convex has built-in caching:
- Query results cached automatically
- Mutations invalidate relevant queries
- Use `cache()` from React for server-side caching

### Testing TTFB

```bash
# Test multiple times to get average
for i in {1..5}; do
  curl -o /dev/null -s -w "TTFB: %{time_starttransfer}s\n" https://nakafa.com/en
done
```

### Monitoring

After deployment:
1. Check Core Web Vitals in Search Console
2. Monitor TTFB in Vercel Analytics
3. Set up alerts for TTFB > 800ms

---

## Progress Update Template

After completing this task, update `plans/website-audit/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 2.1 completed - Optimize TTFB

Key decisions:
- Implemented React cache() for Convex queries
- Added revalidate: 3600 for stale-while-revalidate
- Added database indexes for path/locale queries
- Implemented batched queries to reduce round trips
- Added CDN caching headers for static assets

Files changed:
- packages/backend/convex/contentSync/queries.ts
- packages/backend/convex/schema.ts
- apps/www/app/[locale]/(study)/(main)/(contents)/[...slug]/page.tsx
- apps/www/next.config.ts

Performance improvements:
- TTFB: 1631ms ‚Üí 450ms (72% improvement)
- Lighthouse Performance: 84 ‚Üí 92
- Cache hit rate: 85%

Blockers/notes:
- None
- Monitoring TTFB in Vercel Analytics
- Will adjust cache duration based on real-world usage
```
