# Task 2.4: Fix Article.image Schema Validation

## Goal

Fix Article.image validation errors across 167 pages to improve Structured Data score from 52% to 75%+.

## Context

**Current State:**
- Structured Data score: 52/100
- 167 pages with "Article.image must be a string or array of strings" error
- Current implementation wraps image in ImageObject

**Current Code (article.tsx:73):**
```typescript
image: imageObject ? [imageObject] : undefined,
// Results in:
// "image": [{"@type": "ImageObject", "url": "..."}]
```

**Issue:**
- Schema.org validator expects image as URL string, not ImageObject
- While ImageObject is technically valid per Schema.org spec, validators prefer simple URLs
- Google's Rich Results Test prefers URL strings for Article.image

**Solution:**
Change image from ImageObject to string URL format

## PRD

```json
{
  "category": "seo",
  "description": "Fix Article.image validation by using URL strings instead of ImageObject",
  "steps": [
    "Update ArticleJsonLd to use string URL for image",
    "Verify image URLs are absolute",
    "Test on subject content pages",
    "Test on article pages",
    "Test on exercise pages",
    "Run audit to verify 167 errors resolved",
    "Validate with Schema.org validator"
  ],
  "passes": false
}
```

## Success Criteria

- [ ] Article.image uses string URL format
- [ ] All image URLs are absolute (https://...)
- [ ] No "Article.image must be a string" validation errors
- [ ] Structured Data score improves to 75%+
- [ ] All 167 affected pages pass validation
- [ ] Build successful
- [ ] All tests pass

## Implementation

### Step 1: Update ArticleJsonLd Component

**File:** `packages/seo/json-ld/article.tsx`

**Current (line 46-54):**
```typescript
// Build image object if image is provided
let imageObject: ImageObject | undefined;
if (image) {
  const imageUrl = image.startsWith("http") ? image : `${appUrl}${image}`;
  imageObject = {
    "@type": "ImageObject",
    url: imageUrl,
  };
}

// ...

image: imageObject ? [imageObject] : undefined,
```

**Fixed:**
```typescript
// Build absolute image URL if provided
let imageUrl: string | undefined;
if (image) {
  imageUrl = image.startsWith("http") ? image : `${appUrl}${image}`;
}

// ...

image: imageUrl ? [imageUrl] : undefined,
```

**Changes:**
1. Remove ImageObject import (no longer needed)
2. Change `imageObject` variable to `imageUrl` string
3. Update image property to use string array instead of ImageObject array

### Step 2: Verify Image URL Generation

**Check getOgUrl function** in content pages:
- Should return absolute URL or path starting with `/`
- Path format: `/en/og/.../image.png`
- Will be converted to absolute URL by ArticleJsonLd

**Files using getOgUrl:**
- `apps/www/app/[locale]/(study)/(main)/(contents)/subject/[...slug]/page.tsx`
- `apps/www/app/[locale]/(study)/(main)/(contents)/articles/[...slug]/page.tsx`
- `apps/www/app/[locale]/(study)/(main)/(contents)/exercises/[...slug]/page.tsx`

### Step 3: Test Changes

**Test URLs:**
```bash
# Subject content page
curl -s http://localhost:3000/en/subject/high-school/10/mathematics/exponential-logarithm/basic-concept | \
  grep -o '"image":\[[^]]*\]'

# Expected output:
# "image":["https://nakafa.com/en/og/subject/high-school/10/mathematics/exponential-logarithm/basic-concept/image.png"]
```

**Validation:**
1. Check JSON-LD output has string URL, not ImageObject
2. Verify URL is absolute (starts with https://)
3. Run audit to confirm 167 errors resolved

## Commands

```bash
# Build and test
pnpm build
pnpm start

# Verify fix
curl -s http://localhost:3000/en/subject/high-school/10/mathematics/exponential-logarithm/basic-concept | \
  python3 -m json.tool | grep -A 5 '"@type": "Article"'

# Run audit
pnpm dlx squirrelscan audit localhost:3000 --output json --config squirrel.toml
```

## Files to Modify

1. `packages/seo/json-ld/article.tsx` - Fix image format

## Testing

**Before fix:**
```json
{
  "@type": "Article",
  "image": [{"@type": "ImageObject", "url": "..."}]
}
```

**After fix:**
```json
{
  "@type": "Article",
  "image": ["https://nakafa.com/en/og/.../image.png"]
}
```

## Expected Impact

- **Structured Data score**: 52% → 75%+
- **Errors resolved**: 167 Article.image validation errors
- **Remaining errors**: ~146 other validation errors (to be addressed separately)

## Next Steps

After this task:
1. Address remaining 146 Schema.org validation errors
2. Fix LearningResource.image (if applicable)
3. Add missing required fields to other schemas

## Notes

### Why String URL vs ImageObject?

**Schema.org spec allows both:**
- String URL: `"image": "https://..."`
- ImageObject: `"image": {"@type": "ImageObject", "url": "..."}`

**Google's preference:**
- Article.image should be URL string for rich results
- ImageObject is more verbose and not necessary for basic Article schema

**Validator behavior:**
- Some validators strictly expect string URLs
- Using string URLs ensures maximum compatibility

### Type Safety

The `schema-dts` types allow both formats:
```typescript
type Image = string | ImageObject | (string | ImageObject)[];
```

We'll use `string[]` for type safety and validator compatibility.

## Progress Update Template

After completing this task, update `plans/website-audit/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 2.4 completed - Fix Article.image Schema Validation

Key decisions:
- Changed Article.image from ImageObject to string URL format
- Ensures compatibility with Schema.org validators
- Follows Google's Rich Results guidelines

Files changed:
- packages/seo/json-ld/article.tsx

Validation results:
- Article.image errors: 167 → 0
- Structured Data score: 52% → [X]%
- Schema.org validator: [X] errors remaining

Blockers/notes:
- [Any issues encountered]
```
