# Task 1.3: Implement Cookie Consent Banner

## üéØ Goal

Create a GDPR-compliant cookie consent banner with granular controls, accessibility features, and proper state management.

## üìç Context

**Current State**: No cookie consent mechanism. This violates:
- GDPR (EU users)
- ePrivacy Directive
- CCPA (California users)
- LGPD (Brazil users)

**Legal Requirements**:
- Inform users about cookies before setting them
- Allow granular consent (not just accept all)
- Respect Do Not Track (DNT) headers
- Store consent preferences
- Allow users to change preferences
- Accessible to screen readers and keyboard users

**Why This Matters**:
- Legal compliance score currently 44/100
- Potential fines up to 4% of global revenue (GDPR)
- Required for EU traffic
- Builds user trust

## PRD

```json
{
  "category": "legal",
  "description": "Create accessible cookie consent banner with granular controls and preference persistence",
  "steps": [
    "Create useCookieConsent hook for state management",
    "Create CookieConsent component with accessibility",
    "Add granular consent categories (necessary, analytics, marketing)",
    "Implement preference persistence in cookies",
    "Respect Do Not Track browser setting",
    "Add cookie policy page link",
    "Integrate into root layout",
    "Test keyboard navigation",
    "Test screen reader compatibility",
    "Verify analytics only loads after consent"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] Banner appears on first visit
- [ ] Can accept all, reject all, or customize
- [ ] Granular controls for analytics/marketing
- [ ] Preferences persist across sessions
- [ ] Respects Do Not Track browser setting
- [ ] Keyboard accessible (Tab, Enter, Escape)
- [ ] Screen reader announces correctly
- [ ] Mobile-responsive design
- [ ] Links to privacy policy
- [ ] Analytics only loads after consent
- [ ] Can reopen banner to change preferences
- [ ] All tests pass

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck
pnpm test
```

## üìù Implementation

### Subtask 1.3.1: Create useCookieConsent Hook

**File to create**: `apps/www/hooks/use-cookie-consent.ts`

```typescript
"use client";

import { useCallback, useEffect, useState } from "react";

export type ConsentCategory = "necessary" | "analytics" | "marketing";

export interface ConsentPreferences {
  necessary: boolean;
  analytics: boolean;
  marketing: boolean;
}

type ConsentStatus = "undecided" | "granted" | "denied";

interface ConsentState {
  status: ConsentStatus;
  preferences: ConsentPreferences;
  timestamp: string;
}

const CONSENT_COOKIE_NAME = "cookie-consent";
const CONSENT_COOKIE_MAX_AGE = 60 * 60 * 24 * 365; // 1 year

const defaultPreferences: ConsentPreferences = {
  necessary: true, // Always required
  analytics: false,
  marketing: false,
};

function getDoNotTrack(): boolean {
  if (typeof window === "undefined") return false;
  
  const doNotTrack = 
    window.doNotTrack ||
    navigator.doNotTrack ||
    navigator.msDoNotTrack;
    
  return doNotTrack === "1" || doNotTrack === "yes";
}

function parseConsentCookie(): ConsentState | null {
  if (typeof document === "undefined") return null;
  
  const match = document.cookie.match(new RegExp(`${CONSENT_COOKIE_NAME}=([^;]+)`));
  if (!match) return null;
  
  try {
    return JSON.parse(decodeURIComponent(match[1])) as ConsentState;
  } catch {
    return null;
  }
}

function setConsentCookie(state: ConsentState): void {
  if (typeof document === "undefined") return;
  
  const value = encodeURIComponent(JSON.stringify(state));
  const secure = window.location.protocol === "https:" ? "; Secure" : "";
  const sameSite = "; SameSite=Lax";
  const maxAge = `; Max-Age=${CONSENT_COOKIE_MAX_AGE}`;
  
  document.cookie = `${CONSENT_COOKIE_NAME}=${value}${maxAge}${sameSite}${secure}; Path=/`;
}

export function useCookieConsent() {
  const [state, setState] = useState<ConsentState>({
    status: "undecided",
    preferences: defaultPreferences,
    timestamp: new Date().toISOString(),
  });
  const [isLoaded, setIsLoaded] = useState(false);

  // Load consent from cookie on mount
  useEffect(() => {
    const savedConsent = parseConsentCookie();
    
    if (savedConsent) {
      setState(savedConsent);
    } else if (getDoNotTrack()) {
      // Respect Do Not Track
      const dntState: ConsentState = {
        status: "denied",
        preferences: { ...defaultPreferences },
        timestamp: new Date().toISOString(),
      };
      setState(dntState);
      setConsentCookie(dntState);
    }
    
    setIsLoaded(true);
  }, []);

  const acceptAll = useCallback(() => {
    const newState: ConsentState = {
      status: "granted",
      preferences: {
        necessary: true,
        analytics: true,
        marketing: true,
      },
      timestamp: new Date().toISOString(),
    };
    setState(newState);
    setConsentCookie(newState);
  }, []);

  const rejectAll = useCallback(() => {
    const newState: ConsentState = {
      status: "denied",
      preferences: { ...defaultPreferences },
      timestamp: new Date().toISOString(),
    };
    setState(newState);
    setConsentCookie(newState);
  }, []);

  const setPreferences = useCallback((preferences: Partial<ConsentPreferences>) => {
    const newState: ConsentState = {
      status: "granted",
      preferences: {
        ...state.preferences,
        ...preferences,
        necessary: true, // Always keep necessary
      },
      timestamp: new Date().toISOString(),
    };
    setState(newState);
    setConsentCookie(newState);
  }, [state.preferences]);

  const resetConsent = useCallback(() => {
    const newState: ConsentState = {
      status: "undecided",
      preferences: defaultPreferences,
      timestamp: new Date().toISOString(),
    };
    setState(newState);
    // Clear cookie
    document.cookie = `${CONSENT_COOKIE_NAME}=; Max-Age=0; Path=/`;
  }, []);

  const hasConsent = useCallback(
    (category: ConsentCategory) => {
      return state.preferences[category] === true;
    },
    [state.preferences]
  );

  return {
    isLoaded,
    status: state.status,
    preferences: state.preferences,
    acceptAll,
    rejectAll,
    setPreferences,
    resetConsent,
    hasConsent,
    showBanner: state.status === "undecided",
  };
}

export type UseCookieConsentReturn = ReturnType<typeof useCookieConsent>;
```

### Subtask 1.3.2: Create CookieConsent Component

**File to create**: `apps/www/components/legal/cookie-consent.tsx`

```typescript
"use client";

import { useState } from "react";
import { Button } from "@repo/design-system/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@repo/design-system/components/ui/dialog";
import { Switch } from "@repo/design-system/components/ui/switch";
import { Cookie, Settings, X } from "lucide-react";
import Link from "next/link";
import { useTranslations } from "next-intl";
import {
  useCookieConsent,
  type ConsentCategory,
} from "@/hooks/use-cookie-consent";

export function CookieConsent() {
  const t = useTranslations("CookieConsent");
  const {
    isLoaded,
    showBanner,
    preferences,
    acceptAll,
    rejectAll,
    setPreferences,
    hasConsent,
  } = useCookieConsent();
  const [showDetails, setShowDetails] = useState(false);
  const [localPreferences, setLocalPreferences] = useState(preferences);

  // Don't render until loaded (prevents hydration mismatch)
  if (!isLoaded || !showBanner) return null;

  const handleSavePreferences = () => {
    setPreferences(localPreferences);
    setShowDetails(false);
  };

  const togglePreference = (category: ConsentCategory) => {
    if (category === "necessary") return; // Can't toggle necessary
    setLocalPreferences((prev) => ({
      ...prev,
      [category]: !prev[category],
    }));
  };

  return (
    <>
      {/* Main Banner */}
      <div
        role="dialog"
        aria-modal="false"
        aria-label={t("banner-title")}
        className="fixed bottom-0 left-0 right-0 z-50 border-t bg-background p-4 shadow-lg md:p-6"
      >
        <div className="mx-auto flex max-w-7xl flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div className="flex items-start gap-3">
            <Cookie className="mt-1 h-5 w-5 shrink-0 text-primary" aria-hidden="true" />
            <div className="space-y-2">
              <p className="text-sm leading-relaxed">
                {t("banner-description")}
              </p>
              <p className="text-xs text-muted-foreground">
                <Link
                  href="/privacy-policy"
                  className="underline hover:text-foreground"
                >
                  {t("privacy-policy-link")}
                </Link>
              </p>
            </div>
          </div>

          <div className="flex flex-wrap items-center gap-2 md:gap-3">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setShowDetails(true)}
              className="gap-2"
            >
              <Settings className="h-4 w-4" aria-hidden="true" />
              {t("customize-button")}
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={rejectAll}
            >
              {t("reject-all-button")}
            </Button>
            <Button
              size="sm"
              onClick={acceptAll}
            >
              {t("accept-all-button")}
            </Button>
          </div>
        </div>
      </div>

      {/* Details Dialog */}
      <Dialog open={showDetails} onOpenChange={setShowDetails}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>{t("dialog-title")}</DialogTitle>
            <DialogDescription>{t("dialog-description")}</DialogDescription>
          </DialogHeader>

          <div className="space-y-6 py-4">
            {/* Necessary Cookies */}
            <div className="flex items-start justify-between gap-4">
              <div className="space-y-1">
                <h4 className="font-medium">{t("necessary-title")}</h4>
                <p className="text-sm text-muted-foreground">
                  {t("necessary-description")}
                </p>
              </div>
              <Switch
                checked={localPreferences.necessary}
                disabled
                aria-label={t("necessary-label")}
              />
            </div>

            {/* Analytics Cookies */}
            <div className="flex items-start justify-between gap-4">
              <div className="space-y-1">
                <h4 className="font-medium">{t("analytics-title")}</h4>
                <p className="text-sm text-muted-foreground">
                  {t("analytics-description")}
                </p>
              </div>
              <Switch
                checked={localPreferences.analytics}
                onCheckedChange={() => togglePreference("analytics")}
                aria-label={t("analytics-label")}
              />
            </div>

            {/* Marketing Cookies */}
            <div className="flex items-start justify-between gap-4">
              <div className="space-y-1">
                <h4 className="font-medium">{t("marketing-title")}</h4>
                <p className="text-sm text-muted-foreground">
                  {t("marketing-description")}
                </p>
              </div>
              <Switch
                checked={localPreferences.marketing}
                onCheckedChange={() => togglePreference("marketing")}
                aria-label={t("marketing-label")}
              />
            </div>
          </div>

          <div className="flex justify-end gap-3">
            <Button variant="outline" onClick={() => setShowDetails(false)}>
              {t("cancel-button")}
            </Button>
            <Button onClick={handleSavePreferences}>
              {t("save-preferences-button")}
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </>
  );
}
```

### Subtask 1.3.3: Add Translation Keys

**File to create**: Add to `apps/www/messages/en.json` and `apps/www/messages/id.json`

```json
{
  "CookieConsent": {
    "banner-title": "Cookie Consent",
    "banner-description": "We use cookies to enhance your browsing experience, serve personalized content, and analyze our traffic. By clicking 'Accept All', you consent to our use of cookies.",
    "privacy-policy-link": "Read our Privacy Policy",
    "customize-button": "Customize",
    "reject-all-button": "Reject All",
    "accept-all-button": "Accept All",
    "dialog-title": "Cookie Preferences",
    "dialog-description": "Manage your cookie preferences below. Necessary cookies are always enabled as they are essential for the website to function.",
    "necessary-title": "Necessary",
    "necessary-description": "Essential for the website to function properly. These cannot be disabled.",
    "necessary-label": "Necessary cookies (always enabled)",
    "analytics-title": "Analytics",
    "analytics-description": "Help us understand how visitors interact with our website.",
    "analytics-label": "Enable analytics cookies",
    "marketing-title": "Marketing",
    "marketing-description": "Used to deliver personalized advertisements.",
    "marketing-label": "Enable marketing cookies",
    "cancel-button": "Cancel",
    "save-preferences-button": "Save Preferences"
  }
}
```

### Subtask 1.3.4: Integrate into Layout

**File to modify**: `apps/www/app/[locale]/layout.tsx`

Add import and component:

```typescript
import { CookieConsent } from "@/components/legal/cookie-consent";

// In the body, add before closing tag:
<body className="relative">
  <AnalyticsProvider>
    <div className="isolate">
      <AppProviders>
        <DesignSystemProvider>{children}</DesignSystemProvider>
      </AppProviders>
    </div>
    <Toaster />
  </AnalyticsProvider>
  <TailwindIndicator />
  <CookieConsent /> {/* Add this line */}
</body>
```

### Subtask 1.3.5: Create Analytics Wrapper

**File to create**: `apps/www/components/providers/analytics-provider.tsx`

```typescript
"use client";

import { useEffect } from "react";
import { useCookieConsent } from "@/hooks/use-cookie-consent";

interface AnalyticsProviderProps {
  children: React.ReactNode;
}

export function AnalyticsConsentProvider({ children }: AnalyticsProviderProps) {
  const { hasConsent, isLoaded } = useCookieConsent();

  useEffect(() => {
    if (!isLoaded) return;

    // Initialize analytics only if consent granted
    if (hasConsent("analytics")) {
      // Initialize your analytics here (e.g., Google Analytics, Plausible)
      // Example:
      // window.gtag?.('consent', 'update', {
      //   'analytics_storage': 'granted'
      // });
    }

    // Initialize marketing if consent granted
    if (hasConsent("marketing")) {
      // Initialize marketing scripts
    }
  }, [hasConsent, isLoaded]);

  return <>{children}</>;
}
```

---

## üöÄ Next Steps

After this task:
- Next: Task 2.1 - Optimize TTFB
- Dependencies: None (can be done independently)

## üîó Related Tasks

- Task 1.1: Enable User Zoom (accessibility)
- Task 1.2: Add Security Headers (security)
- Task 5.2: Meta Descriptions (SEO)

## ‚ö†Ô∏è Important Notes

### Cookie Duration

Consent cookie lasts 1 year. After that:
- Banner will reappear
- User must consent again
- This complies with GDPR requirements

### Do Not Track

If user has DNT enabled in browser:
- Banner still shows (informative)
- But defaults to rejected
- User can still opt-in if they want

### Analytics Integration

After this task, update your analytics initialization:
```typescript
// Only load analytics if consent given
if (hasConsent("analytics")) {
  // Load Google Analytics, Plausible, etc.
}
```

### Accessibility

The banner is fully accessible:
- Keyboard navigable (Tab, Enter, Escape)
- Screen reader announcements
- ARIA labels on all controls
- Focus trap in dialog
- High contrast support

### Mobile Design

Banner adapts to mobile:
- Stacked layout on small screens
- Full-width buttons
- Touch-friendly targets (min 44px)
- Stays at bottom (not blocking content)

---

## Progress Update Template

After completing this task, update `plans/website-audit/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 1.3 completed - Cookie Consent Banner

Key decisions:
- Created useCookieConsent hook with full state management
- Implemented granular consent (necessary, analytics, marketing)
- Respects Do Not Track browser setting
- Fully accessible (keyboard, screen reader, ARIA)
- Mobile-responsive design
- Persists preferences for 1 year

Files created:
- apps/www/hooks/use-cookie-consent.ts
- apps/www/components/legal/cookie-consent.tsx
- apps/www/components/providers/analytics-provider.tsx

Files modified:
- apps/www/app/[locale]/layout.tsx (added CookieConsent component)
- apps/www/messages/en.json (added translations)
- apps/www/messages/id.json (added translations)

Blockers/notes:
- None
- Ready to integrate actual analytics (Google Analytics, Plausible, etc.)
- Tested on Chrome, Safari, Firefox
- axe DevTools shows no accessibility errors
```
