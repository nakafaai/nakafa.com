# Task 4.2: Fix Form Labels

## üéØ Goal

Fix form label issues on 76 pages to improve Accessibility score from 89/100 to 95+/100.

## üìç Context

**Current State**: 
- Accessibility score: 89/100
- 76 pages with form label issues
- Form inputs without associated labels
- Missing `aria-label`, `aria-labelledby`, `aria-describedby`

**Why This Matters**:
- Screen readers can't announce unlabeled inputs
- WCAG 2.1 violation (Level A)
- Users with disabilities can't understand form fields
- Legal requirement in many jurisdictions

## PRD

```json
{
  "category": "accessibility",
  "description": "Add proper labels to all form inputs across 76 pages",
  "steps": [
    "Identify all form components without labels",
    "Add visible labels to all form inputs",
    "Add aria-label for icon-only inputs",
    "Link error messages with aria-describedby",
    "Add aria-invalid for invalid fields",
    "Test with screen reader",
    "Verify axe DevTools shows no form errors"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] All form inputs have associated labels
- [ ] All icon-only buttons have aria-label
- [ ] Error messages linked with aria-describedby
- [ ] Invalid fields marked with aria-invalid
- [ ] Screen reader announces all fields correctly
- [ ] axe DevTools shows no form errors
- [ ] Accessibility score > 95/100
- [ ] All tests pass

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck
pnpm test

# Audit to verify
squirrel audit https://nakafa.com --max-pages 100 --format llm
```

## üìù Implementation

### Step 1: Identify Form Components

**Files to audit**:
- `apps/www/components/ui/input.tsx`
- `apps/www/components/ui/select.tsx`
- `apps/www/components/ui/textarea.tsx`
- `apps/www/components/ui/checkbox.tsx`
- `apps/www/components/ui/radio-group.tsx`
- Search for form usage: `grep -r "type=\"text\"" apps/www --include="*.tsx"`

### Step 2: Create Accessible Input Component

**File**: `apps/www/components/ui/input.tsx`

**Current implementation** (check existing):
```typescript
// Check if it supports label prop
export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {}

export const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(/* styles */)}
        ref={ref}
        {...props}
      />
    );
  }
);
```

**Enhanced version with label support**:

```typescript
"use client";

import * as React from "react";
import { cn } from "@repo/design-system/lib/utils";
import { Label } from "./label";

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  helperText?: string;
}

export const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, label, error, helperText, id, ...props }, ref) => {
    // Generate unique ID if not provided
    const inputId = id || React.useId();
    const errorId = `${inputId}-error`;
    const helperId = `${inputId}-helper`;

    // Build aria-describedby
    const describedBy = [
      error && errorId,
      helperText && helperId,
    ]
      .filter(Boolean)
      .join(" ") || undefined;

    return (
      <div className="space-y-2">
        {label && (
          <Label htmlFor={inputId}>{label}</Label>
        )}
        <input
          id={inputId}
          type={type}
          className={cn(
            "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
            error && "border-red-500 focus-visible:ring-red-500",
            className
          )}
          ref={ref}
          aria-invalid={error ? "true" : undefined}
          aria-describedby={describedBy}
          {...props}
        />
        {helperText && (
          <p id={helperId} className="text-sm text-muted-foreground">
            {helperText}
          </p>
        )}
        {error && (
          <p id={errorId} className="text-sm text-red-500" role="alert">
            {error}
          </p>
        )}
      </div>
    );
  }
);

Input.displayName = "Input";
```

### Step 3: Create Label Component

**File**: `apps/www/components/ui/label.tsx`

```typescript
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { cva, type VariantProps } from "class-variance-authority";
import { cn } from "@repo/design-system/lib/utils";

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
);

export const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
));

Label.displayName = LabelPrimitive.Root.displayName;
```

### Step 4: Update Select Component

**File**: `apps/www/components/ui/select.tsx`

**Add label support**:

```typescript
"use client";

import * as React from "react";
import * as SelectPrimitive from "@radix-ui/react-select";
import { cn } from "@repo/design-system/lib/utils";
import { Label } from "./label";

export interface SelectProps {
  label?: string;
  error?: string;
  helperText?: string;
  children: React.ReactNode;
  // ... other props
}

export function Select({ label, error, helperText, children, ...props }: SelectProps) {
  const selectId = React.useId();
  const errorId = `${selectId}-error`;
  const helperId = `${selectId}-helper`;

  const describedBy = [
    error && errorId,
    helperText && helperId,
  ]
    .filter(Boolean)
    .join(" ") || undefined;

  return (
    <div className="space-y-2">
      {label && <Label>{label}</Label>}
      <SelectPrimitive.Root {...props}>
        {children}
      </SelectPrimitive.Root>
      {helperText && (
        <p id={helperId} className="text-sm text-muted-foreground">{helperText}</p>
      )}
      {error && (
        <p id={errorId} className="text-sm text-red-500" role="alert">{error}</p>
      )}
    </div>
  );
}
```

### Step 5: Update Textarea Component

**File**: `apps/www/components/ui/textarea.tsx`

```typescript
"use client";

import * as React from "react";
import { cn } from "@repo/design-system/lib/utils";
import { Label } from "./label";

export interface TextareaProps
  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {
  label?: string;
  error?: string;
  helperText?: string;
}

export const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, label, error, helperText, id, ...props }, ref) => {
    const textareaId = id || React.useId();
    const errorId = `${textareaId}-error`;
    const helperId = `${textareaId}-helper`;

    const describedBy = [
      error && errorId,
      helperText && helperId,
    ]
      .filter(Boolean)
      .join(" ") || undefined;

    return (
      <div className="space-y-2">
        {label && <Label htmlFor={textareaId}>{label}</Label>}
        <textarea
          id={textareaId}
          className={cn(
            "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
            error && "border-red-500 focus-visible:ring-red-500",
            className
          )}
          ref={ref}
          aria-invalid={error ? "true" : undefined}
          aria-describedby={describedBy}
          {...props}
        />
        {helperText && (
          <p id={helperId} className="text-sm text-muted-foreground">{helperText}</p>
        )}
        {error && (
          <p id={errorId} className="text-sm text-red-500" role="alert">{error}</p>
        )}
      </div>
    );
  }
);

Textarea.displayName = "Textarea";
```

### Step 6: Update Usage in Forms

**Find all form usage**:

```bash
grep -r "<Input" apps/www --include="*.tsx" | head -20
grep -r "<Select" apps/www --include="*.tsx" | head -20
grep -r "<Textarea" apps/www --include="*.tsx" | head -20
```

**Update form components**:

**Before**:
```tsx
<Input 
  type="email" 
  placeholder="Enter your email"
  value={email}
  onChange={(e) => setEmail(e.target.value)}
/>
```

**After**:
```tsx
<Input
  type="email"
  label="Email Address"
  placeholder="Enter your email"
  value={email}
  onChange={(e) => setEmail(e.target.value)}
  error={errors.email}
  helperText="We'll never share your email"
/>
```

### Step 7: Fix Icon-Only Buttons

**Add aria-label to icon buttons**:

**Before**:
```tsx
<Button variant="ghost" size="icon">
  <SearchIcon className="h-4 w-4" />
</Button>
```

**After**:
```tsx
<Button 
  variant="ghost" 
  size="icon"
  aria-label="Search"
>
  <SearchIcon className="h-4 w-4" aria-hidden="true" />
</Button>
```

### Step 8: Test with Screen Reader

**Testing steps**:

1. **Enable screen reader**:
   - Mac: Cmd + F5 (VoiceOver)
   - Windows: Ctrl + Windows + Enter (Narrator)

2. **Navigate to forms**:
   - Tab through form fields
   - Verify each field is announced with label
   - Verify error messages are announced

3. **Check axe DevTools**:
   - Install axe DevTools extension
   - Run audit on pages with forms
   - Verify no "Form elements must have labels" errors

### Step 9: Verification

**Run audit**:
```bash
squirrel audit https://nakafa.com --max-pages 100 --format llm
```

**Manual checks**:
- [ ] All inputs have visible labels
- [ ] All icon buttons have aria-label
- [ ] Error messages linked to inputs
- [ ] Screen reader announces correctly
- [ ] axe DevTools shows no errors

---

## üöÄ Next Steps

After this task:
- Next: Task 4.1 - Add Accessible Names to Buttons
- Next: Task 4.3 - Add Skip Navigation Links
- Dependencies: None (can run in parallel)

## üîó Related Tasks

- Task 4.1: Add Accessible Names to Buttons (accessibility)
- Task 4.3: Add Skip Navigation Links (accessibility)
- Task 4.4: Fix Multiple Main Landmarks (accessibility)

## ‚ö†Ô∏è Important Notes

### WCAG Requirements

**Level A (Required)**:
- All form inputs must have labels
- Labels must be programmatically associated

**Level AA (Recommended)**:
- Error messages must be announced
- Invalid fields must be marked

### Label Association Methods

1. **Visible label with htmlFor**:
   ```tsx
   <Label htmlFor="email">Email</Label>
   <Input id="email" />
   ```

2. **Aria-label (no visible label)**:
   ```tsx
   <Input aria-label="Search query" />
   ```

3. **Aria-labelledby (reference other element)**:
   ```tsx
   <span id="search-label">Search</span>
   <Input aria-labelledby="search-label" />
   ```

### Error Handling

Always:
- Link error message with `aria-describedby`
- Mark invalid field with `aria-invalid="true"`
- Use `role="alert"` for error messages

### Testing

Test with:
- [ ] VoiceOver (Mac)
- [ ] NVDA (Windows)
- [ ] JAWS (Windows)
- [ ] axe DevTools
- [ ] Lighthouse accessibility audit

---

## Progress Update Template

After completing this task, update `plans/website-audit/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 4.2 completed - Fix Form Labels

Key decisions:
- Enhanced Input component with built-in label support
- Created Label component using Radix UI
- Updated Select and Textarea components
- Added aria-invalid and aria-describedby for errors
- Added aria-label to all icon-only buttons

Files changed:
- apps/www/components/ui/input.tsx
- apps/www/components/ui/label.tsx (new)
- apps/www/components/ui/select.tsx
- apps/www/components/ui/textarea.tsx
- [All form usage updated]

Results:
- Pages with form label issues: 76 ‚Üí 0
- axe DevTools errors: [X] ‚Üí 0
- Accessibility score: 89 ‚Üí [X]/100

Blockers/notes:
- [Any issues encountered]
- [Notes for next iteration]
```
