# Task 2.1: Fix JSON-LD Validation Errors

## üéØ Goal

Fix all JSON-LD structured data validation errors to improve Structured Data score from 46/100 to 80+/100.

## üìç Context

**Current State**: 
- Structured Data score: 46/100 (Grade F)
- 269 pages affected by validation errors
- Audit reports: "Schema.org validation errors detected" on all pages

**Issues Found**:
1. **BreadcrumbList missing `itemListElement`** - Required property not present
2. **Invalid JSON-LD syntax** - Malformed structured data
3. **WebSite SearchAction missing `query-input`** - Required for sitelinks searchbox
4. **Missing required Article fields** - Some optional fields causing validation warnings

**Why This Matters**:
- Rich snippets won't appear in Google search without valid structured data
- Invalid schema prevents Google from understanding page content
- E-E-A-T signals depend on proper Author/Organization markup
- Required for Google's "Enhancements" report in Search Console

## PRD

```json
{
  "category": "seo",
  "description": "Fix all JSON-LD structured data validation errors across 269 pages",
  "steps": [
    "Fix BreadcrumbList.itemListElement property",
    "Fix WebSite SearchAction query-input property",
    "Validate all JSON-LD syntax",
    "Test with Google Rich Results Test",
    "Test with Schema.org validator",
    "Verify no validation errors in audit"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] BreadcrumbList includes valid `itemListElement` array
- [ ] WebSite SearchAction includes `query-input` property
- [ ] All JSON-LD validates in Schema.org validator
- [ ] Rich Results Test shows no errors
- [ ] Structured Data score > 80/100
- [ ] All 269 pages pass validation
- [ ] No console errors
- [ ] All tests pass

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck
pnpm test

# Validate structured data (after deployment)
# Use Google Rich Results Test: https://search.google.com/test/rich-results
# Use Schema.org validator: https://validator.schema.org/
```

## üìù Implementation

### Step 1: Analyze Current Structured Data

**Files to examine**:
- `packages/seo/json-ld/article.tsx` - Article schema
- `packages/seo/json-ld/breadcrumb.tsx` - BreadcrumbList schema
- `packages/seo/json-ld/website.tsx` - WebSite schema
- `packages/seo/json-ld/constants.ts` - Shared constants

**Current issues identified**:

1. **BreadcrumbList.tsx** (line 36):
   ```typescript
   itemListElement: breadcrumbItems,
   ```
   Issue: `breadcrumbItems` might be undefined or improperly formatted

2. **WebsiteJsonLd.tsx** (lines 32-40):
   ```typescript
   potentialAction: [
     {
       "@type": "SearchAction",
       target: {
         "@type": "EntryPoint",
         urlTemplate: "https://nakafa.com/search?q={search_term_string}",
       },
     },
   ],
   ```
   Issue: Missing `query-input` property for SearchAction

### Step 2: Fix BreadcrumbList Component

**File**: `packages/seo/json-ld/breadcrumb.tsx`

**Current code**:
```typescript
export function BreadcrumbJsonLd({
  locale,
  breadcrumbItems,
  name,
  description,
}: Props) {
  const t = useTranslations("Metadata");

  const breadcrumbJsonLd: WithContext<BreadcrumbList> = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "@id": `${ORGANIZATION_URL}/${locale}#breadcrumb`,
    url: `${ORGANIZATION_URL}/${locale}`,
    name: name ?? t("title"),
    description: description ?? t("description"),
    potentialAction: [
      {
        "@type": "SearchAction",
        "@id": `${ORGANIZATION_URL}/${locale}/search`,
        target: `${ORGANIZATION_URL}/${locale}/search?q={search_term_string}`,
        query: "search_term_string",
      },
    ],
    itemListElement: breadcrumbItems,
  };

  return <JsonLd jsonLd={breadcrumbJsonLd} />;
}
```

**Issues**:
1. `breadcrumbItems` might be undefined
2. BreadcrumbList shouldn't have `potentialAction` (that's for WebSite)
3. Missing validation that `itemListElement` is a proper array

**Fixed code**:
```typescript
import { type Locale, useTranslations } from "next-intl";
import type { BreadcrumbList, ListItem, WithContext } from "schema-dts";
import { JsonLd } from ".";
import { ORGANIZATION_URL } from "./constants";

interface Props {
  locale: Locale;
  breadcrumbItems?: ListItem[];
  name?: string;
  description?: string;
}

export function BreadcrumbJsonLd({
  locale,
  breadcrumbItems,
  name,
  description,
}: Props) {
  const t = useTranslations("Metadata");

  // Ensure breadcrumbItems is a valid array
  const validItems = Array.isArray(breadcrumbItems) ? breadcrumbItems : [];

  // Don't render if no items
  if (validItems.length === 0) {
    return null;
  }

  const breadcrumbJsonLd: WithContext<BreadcrumbList> = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "@id": `${ORGANIZATION_URL}/${locale}#breadcrumb`,
    itemListElement: validItems,
  };

  return <JsonLd jsonLd={breadcrumbJsonLd} />;
}
```

### Step 3: Fix WebSite SearchAction

**File**: `packages/seo/json-ld/website.tsx`

**Current code** (lines 32-40):
```typescript
potentialAction: [
  {
    "@type": "SearchAction",
    target: {
      "@type": "EntryPoint",
      urlTemplate: "https://nakafa.com/search?q={search_term_string}",
    },
  },
],
```

**Issue**: Missing `query-input` property which is required for SearchAction

**Fixed code**:
```typescript
import { type Locale, useTranslations } from "next-intl";
import type { WebSite, WithContext } from "schema-dts";
import { JsonLd } from ".";

interface Props {
  locale: Locale;
}

export function WebsiteJsonLd({ locale }: Props) {
  const t = useTranslations("Metadata");

  const websiteJsonLd: WithContext<WebSite> = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "@id": "https://nakafa.com/#website",
    url: "https://nakafa.com",
    name: t("title"),
    description: t("description"),
    publisher: {
      "@type": "Organization",
      name: "PT. Nakafa Tekno Kreatif",
      logo: "https://nakafa.com/logo.svg",
      url: "https://nakafa.com",
    },
    maintainer: {
      "@type": "Organization",
      name: "PT. Nakafa Tekno Kreatif",
      logo: "https://nakafa.com/logo.svg",
      url: "https://nakafa.com",
    },
    inLanguage: locale,
    potentialAction: [
      {
        "@type": "SearchAction",
        target: {
          "@type": "EntryPoint",
          urlTemplate: "https://nakafa.com/search?q={search_term_string}",
        },
        "query-input": "required name=search_term_string",
      },
    ],
  };

  return <JsonLd jsonLd={websiteJsonLd} />;
}
```

**Key change**: Added `"query-input": "required name=search_term_string"` to SearchAction

### Step 4: Verify ArticleJsonLd Component

**File**: `packages/seo/json-ld/article.tsx`

**Current code** (already reviewed):
```typescript
export function ArticleJsonLd({
  headline,
  datePublished,
  dateModified,
  author,
  image,
  description,
  url,
}: ArticleJsonLdProps) {
  const appUrl = getAppUrl();
  const absoluteUrl = url.startsWith("http") ? url : `${appUrl}${url}`;
  
  let imageObject: ImageObject | undefined;
  if (image) {
    const imageUrl = image.startsWith("http") ? image : `${appUrl}${image}`;
    imageObject = {
      "@type": "ImageObject",
      url: imageUrl,
    };
  }

  const authors = Array.isArray(author) ? author : [author];

  const article = {
    "@context": "https://schema.org" as const,
    "@type": "Article" as const,
    name: headline,
    headline,
    url: absoluteUrl,
    mainEntityOfPage: {
      "@type": "WebPage" as const,
      "@id": absoluteUrl,
    },
    datePublished,
    dateModified: dateModified || datePublished,
    author: authors,
    image: imageObject ? [imageObject] : undefined,
    description,
    publisher: ORGANIZATION,
  };

  return <JsonLd jsonLd={article} />;
}
```

**Verification needed**:
- Ensure all pages pass `url` prop to ArticleJsonLd
- Verify `author` prop is properly formatted

### Step 5: Update Content Pages

**Check all pages using ArticleJsonLd**:

Files to verify:
- `apps/www/app/[locale]/(study)/(main)/(contents)/subject/[...slug]/page.tsx`
- `apps/www/app/[locale]/(study)/(main)/(contents)/articles/[...slug]/page.tsx`
- `apps/www/app/[locale]/(study)/(main)/(contents)/exercises/[...slug]/page.tsx`

**Example verification**:
```typescript
// Ensure url prop is passed
<ArticleJsonLd
  headline={content.title}
  description={content.description}
  url={`/subject/${category}/${grade}/${material}/${slug}`}
  datePublished={content.date}
  dateModified={content.updatedAt}
  author={content.authors}
  image={content.image}
/>
```

### Step 6: Validation Testing

**After deployment, test with**:

1. **Google Rich Results Test**:
   - Visit: https://search.google.com/test/rich-results
   - Enter: `https://nakafa.com/en/subject/high-school/10/mathematics`
   - Check for errors

2. **Schema.org Validator**:
   - Visit: https://validator.schema.org/
   - Enter URL or paste JSON-LD
   - Verify no validation errors

3. **SquirrelScan Audit**:
   ```bash
   squirrel audit https://nakafa.com --max-pages 50 --format llm
   ```
   - Check Structured Data score
   - Verify no "Schema.org validation errors"

---

## üöÄ Next Steps

After this task:
- Next: Task 2.2 - Fix Title Tags
- Next: Task 2.3 - Fix Meta Descriptions
- Dependencies: Task 0.1 (Production Deployment)

## üîó Related Tasks

- Task 2.2: Fix Title Tags (other SEO fix)
- Task 2.3: Fix Meta Descriptions (other SEO fix)
- Task 2.4: Add Missing H1 Tags (other SEO fix)

## ‚ö†Ô∏è Important Notes

### schema-dts Types

We use `schema-dts` for TypeScript types. Key types:
- `WithContext<T>` - Wraps schema with @context
- `BreadcrumbList` - For breadcrumbs
- `WebSite` - For site-wide schema
- `Article` - For content pages

### BreadcrumbList Format

Proper format for `itemListElement`:
```typescript
const breadcrumbItems: ListItem[] = [
  {
    "@type": "ListItem",
    position: 1,
    name: "Home",
    item: "https://nakafa.com/en",
  },
  {
    "@type": "ListItem",
    position: 2,
    name: "Mathematics",
    item: "https://nakafa.com/en/subject/high-school/10/mathematics",
  },
];
```

### SearchAction Format

Required properties:
- `target` - EntryPoint with urlTemplate
- `query-input` - String specifying required query parameter

### Testing Without Deployment

Test locally by viewing page source:
1. Open page in browser
2. View page source (Ctrl+U / Cmd+Option+U)
3. Find `<script type="application/ld+json">`
4. Copy JSON and paste into Schema.org validator

---

## Progress Update Template

After completing this task, update `plans/website-audit/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 2.1 completed - Fix JSON-LD Validation Errors

Key decisions:
- Fixed BreadcrumbList.itemListElement validation
- Added query-input to WebSite SearchAction
- Removed potentialAction from BreadcrumbList (belongs on WebSite)
- Added null checks to prevent rendering empty breadcrumbs

Files changed:
- packages/seo/json-ld/breadcrumb.tsx
- packages/seo/json-ld/website.tsx
- [Any content pages updated]

Validation results:
- Schema.org validator: [X] errors
- Rich Results Test: [X] errors
- SquirrelScan Structured Data score: 46 ‚Üí [X]/100

Blockers/notes:
- [Any issues encountered]
- [Notes for next iteration]
```
