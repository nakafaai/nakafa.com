# Task 1.2: Add Security Headers

## ðŸŽ¯ Goal

Implement comprehensive security headers in Next.js to improve security score, protect against common attacks, and boost SEO rankings.

## ðŸ“ Context

**Current State**: No security headers are configured. The site is vulnerable to:
- XSS attacks (no CSP)
- Clickjacking (no X-Frame-Options)
- MIME-type sniffing (no X-Content-Type-Options)
- Insecure referrer leakage (no Referrer-Policy)
- Downgrade attacks (no HSTS)

**Missing Headers**:
1. Content-Security-Policy (CSP)
2. X-Frame-Options
3. X-Content-Type-Options
4. Referrer-Policy
5. Strict-Transport-Security (HSTS)
6. Permissions-Policy

**Why This Matters**:
- Security score currently 73/100 (should be >90)
- Google uses HTTPS/security as ranking factor
- Required for compliance (SOC2, ISO 27001)
- Protects users from common attacks

## PRD

```json
{
  "category": "security",
  "description": "Add comprehensive security headers via Next.js headers configuration",
  "steps": [
    "Add headers() function to next.config.ts",
    "Configure Content-Security-Policy with strict defaults",
    "Add X-Frame-Options: DENY",
    "Add X-Content-Type-Options: nosniff",
    "Add Referrer-Policy: strict-origin-when-cross-origin",
    "Add Strict-Transport-Security (HSTS)",
    "Add Permissions-Policy for feature restrictions",
    "Test all pages load correctly",
    "Verify headers in browser devtools",
    "Run security scan to confirm improvements"
  ],
  "passes": false
}
```

## ðŸŽ¬ Success Criteria

- [ ] All 6 security headers present on every response
- [ ] CSP allows current functionality (scripts, styles, images)
- [ ] No console errors or blocked resources
- [ ] HSTS header with 1 year max-age
- [ ] Security score improves to >90
- [ ] All tests pass
- [ ] No breaking changes to existing features

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck
pnpm test

# Verify headers
curl -I https://nakafa.com | grep -i "content-security\|x-frame\|x-content\|referrer\|strict-transport\|permissions"
```

## ðŸ“ Implementation

### Step 1: Add Headers Configuration

**File to modify**: `apps/www/next.config.ts`

**Add headers() function** (before the existing config):

```typescript
import { config, withAnalyzer, withMDX } from "@repo/next-config";
import type { NextConfig } from "next";
import createNextIntlPlugin from "next-intl/plugin";
import { env } from "@/env";

const withNextIntl = createNextIntlPlugin(
  "../../packages/internationalization/src/request.ts"
);

// Security headers configuration
const securityHeaders = [
  {
    key: "Content-Security-Policy",
    value: [
      "default-src 'self'",
      "script-src 'self' 'unsafe-eval' 'unsafe-inline'",
      "style-src 'self' 'unsafe-inline'",
      "img-src 'self' blob: data: https:",
      "font-src 'self'",
      "connect-src 'self' https://*.convex.cloud https://*.convex.site",
      "frame-ancestors 'none'",
      "base-uri 'self'",
      "form-action 'self'",
    ].join("; "),
  },
  {
    key: "X-Frame-Options",
    value: "DENY",
  },
  {
    key: "X-Content-Type-Options",
    value: "nosniff",
  },
  {
    key: "Referrer-Policy",
    value: "strict-origin-when-cross-origin",
  },
  {
    key: "Strict-Transport-Security",
    value: "max-age=31536000; includeSubDomains; preload",
  },
  {
    key: "Permissions-Policy",
    value: [
      "camera=()",
      "microphone=()",
      "geolocation=()",
      "payment=()",
      "usb=()",
      "magnetometer=()",
      "gyroscope=()",
      "speaker=()",
      "sync-xhr=()",
    ].join(", "),
  },
];

let nextConfig: NextConfig = {
  ...config,
  serverExternalPackages: ["@takumi-rs/image-response"],
  
  // Add headers configuration
  async headers() {
    return [
      {
        source: "/:path*",
        headers: securityHeaders,
      },
    ];
  },
  
  async rewrites() {
    // ... existing rewrites
  },
  
  async redirects() {
    // ... existing redirects
  },
};

if (env.ANALYZE === "true") {
  nextConfig = withAnalyzer(nextConfig);
}

export default withMDX(withNextIntl(nextConfig));
```

### Step 2: CSP Policy Explanation

**Current CSP allows**:
- `default-src 'self'`: Only same-origin by default
- `script-src 'self' 'unsafe-eval' 'unsafe-inline'`: Needed for Next.js and Convex
- `style-src 'self' 'unsafe-inline'`: Needed for Tailwind and styled-components
- `img-src 'self' blob: data: https:`: Images from same origin, data URIs, and HTTPS
- `font-src 'self'`: Fonts from same origin
- `connect-src 'self' https://*.convex.cloud https://*.convex.site`: API calls to Convex
- `frame-ancestors 'none'`: Prevents clickjacking
- `base-uri 'self'`: Restricts base tag
- `form-action 'self'`: Forms only submit to same origin

### Step 3: Verification

**Check headers are present**:
```bash
# Local development
curl -I http://localhost:3000

# Production (after deploy)
curl -I https://nakafa.com
```

**Expected output**:
```
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; ...
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
Referrer-Policy: strict-origin-when-cross-origin
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
Permissions-Policy: camera=(), microphone=(), geolocation=(), ...
```

**Browser testing**:
1. Open DevTools â†’ Network tab
2. Load any page
3. Click on the main document request
4. Check Response Headers section
5. Verify all 6 headers present

**Functionality testing**:
- [ ] All pages load correctly
- [ ] Images display properly
- [ ] Fonts load correctly
- [ ] JavaScript executes (interactions work)
- [ ] Convex API calls succeed
- [ ] No CSP violations in console

---

## ðŸš€ Next Steps

After this task:
- Next: Task 1.3 - Cookie Consent Banner
- Dependencies: None (can be done independently)

## ðŸ”— Related Tasks

- Task 1.1: Enable User Zoom (other critical fix)
- Task 1.3: Cookie Consent Banner (legal compliance)

## âš ï¸ Important Notes

### CSP 'unsafe-inline' and 'unsafe-eval'

These are needed for:
- **Next.js**: Uses inline scripts for hydration
- **Tailwind CSS**: Uses inline styles
- **Convex**: Uses eval for some operations

**Future improvement**: Once Next.js supports nonce-based CSP, we can remove 'unsafe-inline'.

### HSTS Preload

The `preload` directive submits the site to browser preload lists. Requirements:
- HTTPS only (âœ… already enforced)
- HSTS max-age >= 1 year (âœ… 31536000 seconds)
- includeSubDomains directive (âœ… included)

**To submit**: Visit https://hstspreload.org/ after deployment

### Testing CSP

If something breaks:
1. Check browser console for CSP violation reports
2. Add the blocked source to appropriate directive
3. Test again
4. Common issues: external images, fonts, or scripts

### Permissions-Policy

Restricts browser features. Current policy disables:
- Camera/microphone access
- Geolocation
- Payment APIs
- USB devices
- Sensors

**Enable if needed**: Change `feature=()` to `feature=(self)` or `feature=(self "https://example.com")`

---

## Progress Update Template

After completing this task, update `plans/website-audit/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 1.2 completed - Add Security Headers

Key decisions:
- Implemented CSP with strict defaults but allowed necessary exceptions
- Added all 6 recommended security headers
- Used 'unsafe-inline' and 'unsafe-eval' for Next.js compatibility
- Added HSTS with preload directive for future submission

Files changed:
- apps/www/next.config.ts (added headers() function)

Security headers added:
- Content-Security-Policy
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Referrer-Policy: strict-origin-when-cross-origin
- Strict-Transport-Security (HSTS)
- Permissions-Policy

Blockers/notes:
- None
- All functionality tested and working
- Ready to submit to HSTS preload list after production deploy
```
