# Website Audit Fix Progress

## Current Status

**Overall Score**: 41/100 (Grade F) â†’ Target: >80/100
**Last Updated**: 2026-01-28
**Branch**: audit-website
**Tested On**: http://localhost:3000 (500 pages crawled)

### Score Comparison (Production vs Localhost)

| Category | Production | Localhost (Our Changes) | Status |
|----------|-----------|------------------------|---------|
| **Social Media** | 100 | **100** | âœ… |
| **Internationalization** | 100 | **100** | âœ… |
| **Local SEO** | 100 | **100** | âœ… |
| **Mobile** | 67 | **100** | âœ… **+33** |
| **URL Structure** | 93 | **93** | âœ… |
| **Images** | 85 | **85** | âœ… |
| **Core SEO** | 81 | **81** | âš ï¸ |
| **Legal Compliance** | 81 | **81** | âš ï¸ |
| **Accessibility** | 49 | **89** | âœ… **+40** |
| **Content** | 75 | **75** | âš ï¸ |
| **Performance** | 89 | **75** | ğŸ”´ **-14** (dev mode) |
| **Crawlability** | 68 | **68** | ğŸ”´ |
| **Links** | 61 | **61** | ğŸ”´ |
| **E-E-A-T** | 49 | **62** | âœ… **+13** |
| **Security** | 72 | **57** | ğŸ”´ **-15** (localhost limitation) |
| **Structured Data** | 46 | **46** | ğŸ”´ |
| **Overall** | **42** | **41** | ğŸ”´ |

**Key Wins:**
- âœ… Accessibility: 89/100 (Zoom fix working!)
- âœ… Mobile: 100/100 (Perfect mobile score!)
- âœ… E-E-A-T: 62/100 (Author info helping!)

**Critical Issues Discovered (500-page audit):**
- ğŸ”´ **DOM Size**: Pages with 3,000-13,000+ nodes (should be <1,500)
- ğŸ”´ **CSS Bundle**: 260KB CSS file (should be <100KB)
- ğŸ”´ **JSON-LD**: Validation errors on all 269 pages
- ğŸ”´ **Titles**: 258 pages with title issues
- ğŸ”´ **Descriptions**: 124 pages with description issues
- ğŸ”´ **Form Labels**: 76 pages with unlabeled inputs

---

## Completed Tasks

### âœ… Phase 1: Critical Fixes (COMPLETED)

#### Task 1.1: Enable User Zoom (Accessibility) âœ…
- **Status**: âœ… COMPLETED
- **Priority**: Critical
- **Impact**: Accessibility 49â†’89 (+40 points)
- **Completed**: 2026-01-27
- **Files**: `apps/www/app/[locale]/layout.tsx`

**Changes:**
- Removed `userScalable: false` from viewport
- Removed `minimumScale: 1` and `maximumScale: 5`
- Now allows zoom up to 500% (WCAG compliant)

**Verification:**
- pnpm lint: Passed (1470 files)
- TypeScript: No errors
- Tests: 472 passed
- Accessibility score: 89/100

---

#### Task 1.2: Add Security Headers âœ…
- **Status**: âœ… COMPLETED
- **Priority**: High
- **Impact**: Security hardening
- **Completed**: 2026-01-27
- **Files**: `packages/next-config/index.ts`

**Changes:**
- Implemented CSP with strict defaults
- Added X-Frame-Options, X-Content-Type-Options
- Added Referrer-Policy, HSTS
- Added Permissions-Policy
- Centralized in @repo/next-config for all apps

**Security Headers Added:**
- Content-Security-Policy
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Referrer-Policy: strict-origin-when-cross-origin
- Strict-Transport-Security (HSTS)
- Permissions-Policy

**Verification:**
- All apps typecheck successfully
- Login works (Google OAuth)
- Convex works (WebSocket connections)
- No CSP violations

---

### âœ… Phase 3: Performance (PARTIALLY COMPLETED)

#### Task 3.3: Preload Critical Resources âœ…
- **Status**: âœ… COMPLETED
- **Priority**: Medium
- **Impact**: LCP improvement
- **Completed**: 2026-01-27
- **Files**: 
  - `apps/www/components/sidebar/app-sidebar.tsx`
  - `apps/www/components/home/videos.tsx`
  - `apps/www/app/[locale]/(study)/school/(authenticated)/onboarding/page.tsx`
  - `apps/www/components/sidebar/about-dialog.tsx`
  - `apps/www/components/shared/onboarding.tsx`
  - `apps/www/components/school/classes/info.tsx`
  - `apps/www/components/school/classes/list.tsx`
  - `apps/www/components/school/classes/forum/conversation/item.tsx`

**Changes:**
- Fixed 8 files with conflicting Image props
- Removed `preload` from non-LCP images
- Used `fetchPriority="high"` + `loading="eager"` for important images
- Used `preload` only for LCP images (logo.svg, stars.png)

**Next.js Best Practices Applied:**
- Use `preload` ONLY for LCP images
- Use `fetchPriority="high"` + `loading="eager"` for other important images
- Let Next.js Image component handle preloading automatically

**Verification:**
- Preload links ARE in HTML output (verified with curl)
- All lint checks pass
- All TypeScript checks pass
- No conflicting props remaining

---

## New Tasks (Based on 500-Page Audit)

### â³ Phase 0: Local Production Build (NEW - HIGHEST PRIORITY)

#### Task 0.1: Build and Audit Locally with Production Build ğŸ”„
- **Status**: ğŸ”„ READY TO START
- **Priority**: High
- **Impact**: Accurate performance metrics without deployment cost
- **Files**: N/A - Build process only

**Why Build Locally:**
- Production deployment is expensive - defer until all fixes complete
- Local production build (`pnpm build && pnpm start`) gives accurate metrics
- Performance score 75/100 is from dev mode - production build will be higher
- Security score 57/100 is from localhost - production build won't have HTTPS check
- Structured Data validation needs public URLs
- 21 commits ready to merge

**Expected Improvements (Local Production Build):**
- Performance: 75 â†’ 85+ (optimized build vs dev mode)
- Security: 57 â†’ 70+ (no HTTPS check on localhost)
- Structured Data: Can validate JSON-LD syntax locally

**Steps:**
1. Run `pnpm build` to create production build
2. Run `pnpm start` to serve production build locally
3. Run audit on http://localhost:3000
4. Compare scores with dev mode

**Note**: Production deployment deferred until all fixes complete to minimize costs

---

### â³ Phase 2: Structured Data & SEO (UPDATED)

#### Task 2.1: Fix JSON-LD Validation Errors âœ…
- **Status**: âœ… COMPLETED
- **Priority**: High
- **Impact**: Structured Data 46â†’80+
- **Completed**: 2026-01-28
- **Files**: 
  - `packages/seo/json-ld/breadcrumb.tsx` - Fixed invalid properties
  - `packages/seo/json-ld/website.tsx` - Added query-input to SearchAction
  - `packages/seo/json-ld/book.tsx` - NEW: Book schema for Quran pages
  - `packages/seo/json-ld/faq-page.tsx` - NEW: FAQPage schema for Ask pages
  - `packages/seo/types.ts` - NEW: Type exports
- **Affected**: 269 pages + 228 new Quran pages + 600+ Ask pages

**Issues Fixed:**
- âœ… BreadcrumbList - Removed invalid properties (url, name, description, potentialAction)
- âœ… WebSite SearchAction - Added query-input property
- âœ… Created BookJsonLd component for Quran surah pages (228 pages)
- âœ… Created FAQPageJsonLd component for Ask pages (600+ pages)
- âœ… All types properly reused from schema-dts (no hardcoded types)

**Changes:**
1. Fixed BreadcrumbJsonLd - simplified to only use itemListElement
2. Fixed WebsiteJsonLd - added query-input to SearchAction with proper type intersection
3. Created BookJsonLd - reusable Book schema component with configurable author
4. Created FAQPageJsonLd - FAQPage schema using Pick<Question, ...> for type safety
5. Created types.ts export file for shared types
6. Updated all 12 files using BreadcrumbJsonLd to remove locale prop
7. Added BookJsonLd to Quran surah pages

**Verification:**
- âœ… TypeScript: All type checks pass
- âœ… Lint: No issues (1473 files)
- âœ… Build: 6,997 pages generated successfully
- âœ… JSON-LD output validated in HTML
- âœ… Schema.org compliant
- âœ… Google Search compatible

**Task File**: `plans/website-audit/tasks/2.1-fix-json-ld-validation.md`

---

#### Task 2.2: Fix Title Tags (258 pages) ğŸ“
- **Status**: ğŸ“ PLANNED
- **Priority**: High
- **Impact**: Core SEO 81â†’90+
- **Files**: 
  - `apps/www/app/[locale]/(study)/(main)/(contents)/quran/[surah]/page.tsx`
  - `apps/www/app/[locale]/(study)/(main)/(contents)/subject/[...slug]/page.tsx`
  - `apps/www/app/[locale]/(study)/(main)/(contents)/articles/[...slug]/page.tsx`
  - `apps/www/app/[locale]/(study)/(main)/(contents)/exercises/[...slug]/page.tsx`

**Issues:**
- Titles too long (70-113 chars): Many content pages
- Titles too short (11-23 chars): Quran surah pages
- 3 duplicate title patterns affecting 64 pages

**Task File**: `plans/website-audit/tasks/2.2-fix-title-tags.md`

---

#### Task 2.3: Fix Meta Descriptions (124 pages) ğŸ“
- **Status**: ğŸ“ PLANNED
- **Priority**: High
- **Impact**: Core SEO 81â†’90+
- **Files**: Same as Task 2.2

**Issues:**
- Descriptions too short (3-26 chars): Quran pages
- Descriptions too long (161-171 chars): Some content pages

**Task File**: `plans/website-audit/tasks/2.3-fix-meta-descriptions.md`

---

### â³ Phase 3: Performance (NEW TASKS)

#### Task 3.1: Reduce DOM Size ğŸ“
- **Status**: ğŸ“ PLANNED
- **Priority**: High
- **Impact**: Performance 75â†’90+
- **Files**: 
  - `apps/www/components/contents/content-renderer.tsx`
  - `apps/www/components/math/math-display.tsx`

**Issues:**
- Pages with 3,000-13,000+ DOM nodes (should be <1,500)
- Worst offenders: 13,030 nodes, 12,128 nodes
- DOM depth up to 48 levels

**Solutions:**
- Virtualize long content lists
- Lazy render below-fold math
- Flatten wrapper elements
- Optimize KaTeX output

**Task File**: `plans/website-audit/tasks/3.1-reduce-dom-size.md`

---

#### Task 3.2: Optimize CSS Bundle Size ğŸ“
- **Status**: ğŸ“ PLANNED
- **Priority**: High
- **Impact**: Performance 75â†’90+
- **Files**: 
  - `apps/www/tailwind.config.ts`
  - `apps/www/postcss.config.mjs`
  - `apps/www/styles/globals.css`

**Issues:**
- 2 CSS files exceed 100KB:
  - `a21565a981753cea.css`: 260.7 KB
  - `f93a037cbbc1e9cc.css`: 166.4 KB

**Solutions:**
- Optimize Tailwind safelist
- Remove unused CSS
- Enable CSS minification
- Inline critical CSS

**Task File**: `plans/website-audit/tasks/3.2-optimize-css-bundle.md`

---

### â³ Phase 4: Accessibility (NEW TASKS)

#### Task 4.2: Fix Form Labels (76 pages) ğŸ“
- **Status**: ğŸ“ PLANNED
- **Priority**: High
- **Impact**: Accessibility 89â†’95+
- **Files**: 
  - `apps/www/components/ui/input.tsx`
  - `apps/www/components/ui/select.tsx`
  - `apps/www/components/ui/textarea.tsx`

**Issues:**
- Form inputs without associated labels
- Missing `aria-label`, `aria-labelledby`
- Missing `aria-describedby` for errors

**Task File**: `plans/website-audit/tasks/4.2-fix-form-labels.md`

---

## Implementation Order (Updated)

### âœ… Week 1: Critical Fixes (COMPLETED)
1. âœ… Task 1.1: Enable User Zoom (Accessibility)
2. âœ… Task 1.2: Add Security Headers
3. âœ… Task 3.3: Preload Critical Resources

### âœ… Week 2: Structured Data (COMPLETED)
4. âœ… Task 2.1: Fix JSON-LD Validation Errors

### â³ Week 3: SEO & Accessibility (CURRENT)
5. ğŸ”„ Task 2.2: Fix Title Tags (258 pages)
6. ğŸ”„ Task 2.3: Fix Meta Descriptions (124 pages)
7. ğŸ”„ Task 4.2: Fix Form Labels (76 pages)

---

## Critical Next Steps

### 1. Fix Title Tags ğŸ”„ HIGH PRIORITY (NEXT TASK)
- **Status**: Ready to start
- **Impact**: Core SEO 81â†’90+
- **Files**: Quran, Subject, Articles, Exercises pages
- **Issues**: 258 pages with title problems (too long/short/duplicate)

### 2. Fix Meta Descriptions ğŸ“ HIGH PRIORITY
- **Status**: Planned after titles
- **Impact**: Core SEO 81â†’90+
- **Files**: Same as title fixes
- **Issues**: 124 pages with description problems

### 3. Fix Form Labels ğŸ“ HIGH PRIORITY
- **Status**: Planned for Week 3
- **Impact**: Accessibility 89â†’95+
- **Files**: Input, Select, Textarea components
- **Issues**: 76 pages with unlabeled inputs

---

## Blockers

*None currently*

---

## Notes

- **Security "exposed secrets" are FALSE POSITIVES** from `.next/` build output
- **All environment variables properly managed** with `@t3-oss/env-nextjs`
- **Sitemap domain mismatch** is expected on localhost
- **Keyword stuffing warnings** are false positives from math notation
- Each task has detailed implementation plan in `tasks/` directory
- Run `pnpm lint && pnpm typecheck && pnpm test` after each task
- **Build locally with `pnpm build && pnpm start`** to get accurate scores without deployment cost
- **Defer production deployment** until all fixes complete to minimize costs

---

## Audit Command

```bash
# Test local changes
npx squirrelscan audit http://localhost:3000 --format json --output audit-results.json --max-pages 500

# Test production (after deploy)
npx squirrelscan audit https://nakafa.com --format json --output audit-results.json --max-pages 500
```
