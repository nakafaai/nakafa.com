# Task 1.4: Frontend Checkout Implementation

## üéØ Goal

Create unified checkout experience with automatic regional pricing detection and real-time payment status updates.

## üìç Context

**Prerequisites:**
- QRIS.id backend implemented (Task 1.3)
- Polar pricing updated (Task 1.2)
- Regional pricing configured

**User Flow:**
1. User visits pricing page
2. System detects location (Indonesia vs International)
3. Shows appropriate price (Rp 89K or $8.99)
4. User clicks "Get Pro"
5. Shows QRIS (Indonesia) or Polar (International) checkout
6. Real-time status updates
7. Automatic activation on payment

## PRD

```json
{
  "category": "frontend",
  "description": "Create unified checkout with regional pricing detection and real-time status updates",
  "steps": [
    "Create location detection utility",
    "Build regional pricing component",
    "Implement QRIS checkout with QR code display",
    "Implement Polar checkout integration",
    "Add real-time status subscription",
    "Handle success and error states"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] Location detection working (IP-based)
- [ ] Regional pricing displays correctly
- [ ] QRIS checkout shows QR code
- [ ] Polar checkout redirects correctly
- [ ] Real-time status updates working
- [ ] Success state handled (redirect to dashboard)
- [ ] Error states handled (expired, failed)

## Commands

```bash
# From root directory
pnpm --filter www dev
pnpm lint
pnpm typecheck
```

## üìù Subtasks

### Subtask 1.4.1: Create Location Detection

Detect user location for regional pricing.

**File**: `apps/www/lib/location.ts`

```typescript
export type UserLocation = "ID" | "INTL";

export async function detectUserLocation(): Promise<UserLocation> {
  try {
    const response = await fetch("https://ipapi.co/json/");
    const data = await response.json();
    return data.country_code === "ID" ? "ID" : "INTL";
  } catch {
    return "INTL"; // Default to international
  }
}
```

**Usage:**

```typescript
const location = await detectUserLocation();
// "ID" for Indonesia, "INTL" for others
```

**Output**: Location detection utility created

---

### Subtask 1.4.2: Create Pricing Configuration

Define regional pricing constants.

**File**: `apps/www/lib/pricing.ts`

```typescript
export const PRICING = {
  ID: {
    amount: 89000,
    currency: "IDR",
    display: "Rp 89.000",
    paymentMethod: "qris" as const,
  },
  INTL: {
    amount: 8.99,
    currency: "USD",
    display: "$8.99",
    paymentMethod: "polar" as const,
  },
};

export type PricingRegion = keyof typeof PRICING;

export function getPricing(region: PricingRegion) {
  return PRICING[region];
}
```

**Output**: Pricing configuration created

---

### Subtask 1.4.3: Create Unified Checkout Component

Build main checkout component with regional detection.

**File**: `apps/www/components/payments/UnifiedCheckout.tsx`

```tsx
"use client";

import { useEffect, useState } from "react";
import { detectUserLocation } from "@/lib/location";
import { getPricing, PricingRegion } from "@/lib/pricing";
import { QrisCheckout } from "./QrisCheckout";
import { PolarCheckout } from "./PolarCheckout";

export function UnifiedCheckout() {
  const [location, setLocation] = useState<PricingRegion | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    detectUserLocation().then((loc) => {
      setLocation(loc);
      setLoading(false);
    });
  }, []);

  if (loading) {
    return <div>Detecting your location...</div>;
  }

  const pricing = getPricing(location!);

  return (
    <div className="checkout-container">
      <div className="pricing-header">
        <h1>Nakafa Pro</h1>
        <div className="price">{pricing.display}</div>
        <div className="period">/month</div>
      </div>

      {pricing.paymentMethod === "qris" ? (
        <QrisCheckout amount={pricing.amount} />
      ) : (
        <PolarCheckout amount={pricing.amount} />
      )}
    </div>
  );
}
```

**Output**: Unified checkout component created

---

### Subtask 1.4.4: Implement QRIS Checkout

Create QRIS-specific checkout with QR code and status polling.

**File**: `apps/www/components/payments/QrisCheckout.tsx`

```tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@repo/backend/convex/_generated/api";
import { QRCodeSVG } from "qrcode.react";
import { useEffect, useState } from "react";

interface Props {
  amount: number;
}

export function QrisCheckout({ amount }: Props) {
  const [invoiceData, setInvoiceData] = useState<{
    invoiceId: string;
    qrisContent: string;
    expiresAt: number;
    nmid: string;
  } | null>(null);
  
  const createPayment = useAction(api.qris.actions.createPayment);
  
  // Subscribe to real-time status
  const paymentStatus = useQuery(
    api.qris.queries.getPaymentStatus,
    invoiceData?.invoiceId ? { invoiceId: invoiceData.invoiceId } : "skip"
  );

  useEffect(() => {
    createPayment({ amount, planType: "monthly" }).then(setInvoiceData);
  }, [amount, createPayment]);

  // Handle successful payment
  useEffect(() => {
    if (paymentStatus?.status === "paid") {
      window.location.href = "/dashboard?payment=success";
    }
  }, [paymentStatus]);

  if (!invoiceData) {
    return <div>Generating QR code...</div>;
  }

  const isExpired = Date.now() > invoiceData.expiresAt;
  const timeLeft = Math.max(0, invoiceData.expiresAt - Date.now());
  const minutesLeft = Math.floor(timeLeft / 60000);

  return (
    <div className="qris-checkout">
      {/* QR Code */}
      <div className="qr-container">
        <QRCodeSVG 
          value={invoiceData.qrisContent} 
          size={256}
          level="M"
        />
      </div>

      {/* NMID (required by QRIS regulations) */}
      <p className="nmid">NMID: {invoiceData.nmid}</p>

      {/* Status */}
      {paymentStatus?.status === "pending" && !isExpired && (
        <div className="status pending">
          <p>‚è≥ Menunggu pembayaran...</p>
          <p className="timer">Berlaku {minutesLeft} menit</p>
          <p className="note">Bisa ditutup dan dibuka kembali nanti</p>
        </div>
      )}

      {paymentStatus?.status === "paid" && (
        <div className="status paid">
          <p>‚úÖ Pembayaran berhasil!</p>
          <p>Mengaktifkan Pro...</p>
        </div>
      )}

      {isExpired && paymentStatus?.status === "pending" && (
        <div className="status expired">
          <p>‚ùå QR code expired</p>
          <button 
            onClick={() => createPayment({ amount, planType: "monthly" }).then(setInvoiceData)}
          >
            Generate QR Baru
          </button>
        </div>
      )}

      {/* Instructions */}
      <div className="instructions">
        <h3>Cara bayar:</h3>
        <ol>
          <li>Buka aplikasi GoPay, OVO, DANA, atau mobile banking</li>
          <li>Pilih menu "Scan QRIS"</li>
          <li>Scan kode di atas</li>
          <li>Konfirmasi pembayaran Rp {amount.toLocaleString("id-ID")}</li>
        </ol>
      </div>
    </div>
  );
}
```

**Output**: QRIS checkout component created

---

### Subtask 1.4.5: Implement Polar Checkout

Create Polar integration for international users.

**File**: `apps/www/components/payments/PolarCheckout.tsx`

```tsx
"use client";

import { useAction } from "convex/react";
import { api } from "@repo/backend/convex/_generated/api";
import { useState } from "react";

interface Props {
  amount: number;
}

export function PolarCheckout({ amount }: Props) {
  const [loading, setLoading] = useState(false);
  const generateCheckoutLink = useAction(api.customers.actions.generateCheckoutLink);

  const handleSubscribe = async () => {
    setLoading(true);
    try {
      const result = await generateCheckoutLink({
        productIds: ["pro"],
      });
      
      if (result.checkoutUrl) {
        window.location.href = result.checkoutUrl;
      }
    } catch (error) {
      console.error("Failed to generate checkout:", error);
      alert("Failed to create checkout. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="polar-checkout">
      <button 
        onClick={handleSubscribe}
        disabled={loading}
        className="subscribe-button"
      >
        {loading ? "Loading..." : `Subscribe for $${amount}/month`}
      </button>
      
      <p className="note">
        Secure payment powered by Polar
      </p>
    </div>
  );
}
```

**Output**: Polar checkout component created

---

### Subtask 1.4.6: Create Pricing Page

Build main pricing page with unified checkout.

**File**: `apps/www/app/(app)/pricing/page.tsx`

```tsx
import { UnifiedCheckout } from "@/components/payments/UnifiedCheckout";

export default function PricingPage() {
  return (
    <div className="pricing-page">
      <header>
        <h1>Simple, Transparent Pricing</h1>
        <p>One plan. Everything included. Cancel anytime.</p>
      </header>

      <UnifiedCheckout />

      <section className="features">
        <h2>Everything you get:</h2>
        <ul>
          <li>‚úÖ Unlimited AI messages</li>
          <li>‚úÖ All AI models (GPT-4, Claude, Gemini)</li>
          <li>‚úÖ All 2,784 content files</li>
          <li>‚úÖ AI-generated study plans</li>
          <li>‚úÖ Advanced analytics</li>
          <li>‚úÖ File uploads (PDF, images)</li>
          <li>‚úÖ Web search in AI</li>
          <li>‚úÖ Priority support</li>
          <li>‚úÖ API access</li>
        </ul>
      </section>

      <section className="faq">
        <h2>FAQ</h2>
        <details>
          <summary>Can I cancel anytime?</summary>
          <p>Yes, you can cancel your subscription at any time. You'll keep access until the end of your billing period.</p>
        </details>
        <details>
          <summary>What payment methods are accepted?</summary>
          <p>Indonesia: QRIS (all e-wallets and mobile banking). International: Credit cards via Polar.</p>
        </details>
      </section>
    </div>
  );
}
```

**Output**: Pricing page created

---

## üöÄ Next Steps

After completing this task:

1. **Test**: End-to-end payment flows (both Indonesia and International)
2. **Launch**: Soft launch to beta users
3. **Monitor**: Track conversion rates and errors

## üîó Related Tasks

- Task 1.2: Polar Pricing Update (prerequisite)
- Task 1.3: QRIS Backend Integration (prerequisite)
- Task 1.5: Testing & Launch (next)

## ‚ö†Ô∏è Important Notes

### Real-Time Updates

**How it works:**
1. Frontend subscribes to payment status via Convex `useQuery`
2. Backend polling updates database every 30 seconds
3. Convex pushes updates to frontend automatically
4. No manual refresh needed

**Benefits:**
- User sees "paid" status immediately
- Works across devices
- No polling from frontend (efficient)

### Error Handling

**Handled Cases:**
- QR expired ‚Üí Show regenerate button
- Payment failed ‚Üí Show error message
- Network error ‚Üí Retry automatically
- Already paid ‚Üí Show success immediately

### UX Considerations

**Indonesia:**
- Show QRIS instructions in Indonesian
- Display NMID (required by regulations)
- Show timer (30-minute expiry)
- Mobile-first design (most users on phone)

**International:**
- Simple Polar checkout
- Credit card focus
- Clean, minimal design
- Trust badges (Polar, Stripe)

### Progress Tracking

After completing this task, update `plans/gtm-pricing-strategy/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 1.4 completed

Key decisions:
- IP-based location detection
- Real-time status via Convex subscriptions
- QRIS shows instructions in Indonesian
- Polar keeps simple checkout flow

Files changed:
- apps/www/lib/location.ts (created)
- apps/www/lib/pricing.ts (created)
- apps/www/components/payments/UnifiedCheckout.tsx (created)
- apps/www/components/payments/QrisCheckout.tsx (created)
- apps/www/components/payments/PolarCheckout.tsx (created)
- apps/www/app/(app)/pricing/page.tsx (created)

Blockers/notes:
- None. Ready for testing.
```
