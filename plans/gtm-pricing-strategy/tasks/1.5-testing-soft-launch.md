# Task 1.5: Testing & Soft Launch

## ðŸŽ¯ Goal

Test complete payment flows end-to-end and soft launch to beta users.

## ðŸ“ Context

**Prerequisites:**
- QRIS.id backend implemented
- Polar pricing updated
- Frontend checkout complete

**Testing Scope:**
- Indonesia flow (QRIS)
- International flow (Polar)
- Edge cases (expired, failed, refresh)
- Mobile and desktop

**Soft Launch:**
- Existing 150 users
- Beta testers
- Monitor conversion rates

## PRD

```json
{
  "category": "testing",
  "description": "Test all payment flows and soft launch to beta users",
  "steps": [
    "Test Indonesia QRIS flow end-to-end",
    "Test International Polar flow end-to-end",
    "Test edge cases (expired, failed, duplicate)",
    "Test mobile responsiveness",
    "Soft launch to 150 existing users",
    "Monitor metrics for 1 week",
    "Iterate based on feedback"
  ],
  "passes": false
}
```

## ðŸŽ¬ Success Criteria

- [ ] Indonesia flow tested and working
- [ ] International flow tested and working
- [ ] All edge cases handled correctly
- [ ] Mobile experience verified
- [ ] Soft launch completed (150 users notified)
- [ ] Metrics tracked (conversion rate, errors)
- [ ] No critical bugs in production

## Commands

```bash
# From root directory
pnpm lint
pnpm typecheck
pnpm test
pnpm --filter www dev
pnpm --filter backend dev
```

## ðŸ“ Subtasks

### Subtask 1.5.1: Test Indonesia QRIS Flow

Complete end-to-end testing of Indonesia payment flow.

**Test Scenario 1: Happy Path**

```
1. User visits /pricing (from Indonesia IP)
2. Sees "Rp 89.000/bulan"
3. Clicks "Get Pro"
4. QR code generated and displayed
5. User scans QR with GoPay
6. Payment confirmed in GoPay
7. Backend detects payment (within 30-60s)
8. User sees "Pembayaran berhasil!"
9. Redirected to dashboard with Pro access
```

**Test Steps:**

1. **Setup Test Environment:**
```bash
# Use VPN to simulate Indonesia IP
# Or modify detectUserLocation() to return "ID"
```

2. **Execute Test:**
```bash
pnpm --filter www dev
pnpm --filter backend dev
```

3. **Navigate to Pricing:**
   - Open http://localhost:3000/pricing
   - Verify price shows "Rp 89.000"

4. **Generate QR:**
   - Click "Get Pro"
   - QR code should appear within 3 seconds
   - Note the invoice ID

5. **Simulate Payment:**
   - Use QRIS.id test mode (if available)
   - Or manually mark as paid in Convex dashboard:
```typescript
// Convex dashboard mutation
await ctx.db
  .query("qrisPayments")
  .withIndex("by_invoiceId", q => q.eq("invoiceId", "YOUR_INVOICE_ID"))
  .unique()
  .then(payment => {
    ctx.db.patch(payment._id, {
      status: "paid",
      paidAt: Date.now()
    })
  })
```

6. **Verify Activation:**
   - Status should change to "paid"
   - User should get Pro access
   - Subscription record created

**Expected Result:** âœ… Flow completes successfully

---

**Test Scenario 2: QR Expired**

```
1. User generates QR code
2. Waits 30+ minutes
3. QR should show as expired
4. "Generate QR Baru" button appears
5. Clicking generates new QR
```

**Test:**
- Modify expiresAt to past timestamp
- Verify expired state shows
- Verify new QR generates

**Expected Result:** âœ… Expiry handled correctly

---

**Test Scenario 3: User Refreshes Page**

```
1. User generates QR
2. Refreshes page
3. Same QR should appear (not new one)
4. Status should persist
```

**Test:**
- Generate QR
- Note invoice ID
- Refresh page
- Verify same invoice ID

**Expected Result:** âœ… State persists across refresh

---

**Output**: Indonesia flow tested

---

### Subtask 1.5.2: Test International Polar Flow

Complete end-to-end testing of International payment flow.

**Test Scenario: Happy Path**

```
1. User visits /pricing (from US IP)
2. Sees "$8.99/month"
3. Clicks "Get Pro"
4. Redirected to Polar checkout
5. Enters test card (4242 4242 4242 4242)
6. Payment succeeds
7. Webhook received by backend
8. Subscription activated
9. User redirected to dashboard
```

**Test Steps:**

1. **Setup:**
```bash
# Use VPN to simulate US IP
# Or modify detectUserLocation() to return "INTL"
```

2. **Navigate to Pricing:**
   - Open http://localhost:3000/pricing
   - Verify price shows "$8.99"

3. **Start Checkout:**
   - Click "Get Pro"
   - Should redirect to Polar checkout

4. **Test Card:**
   - Number: 4242 4242 4242 4242
   - Expiry: 12/25
   - CVC: 123
   - ZIP: 12345

5. **Complete Payment:**
   - Submit payment
   - Should redirect to success URL

6. **Verify Webhook:**
   - Check Convex logs for webhook
   - Verify subscription created

**Expected Result:** âœ… Payment succeeds, subscription active

---

**Test Scenario: Payment Failed**

```
1. User enters declined card (4000 0000 0000 0002)
2. Payment fails
3. Error message shown
4. Can retry with different card
```

**Expected Result:** âœ… Error handled gracefully

---

**Output**: International flow tested

---

### Subtask 1.5.3: Test Edge Cases

Test all edge cases and error scenarios.

**Edge Case 1: Duplicate Payment Prevention**

```typescript
// Test: Try to activate same subscription twice
await activateSubscription({ invoiceId: "same-id" });
await activateSubscription({ invoiceId: "same-id" }); // Should be no-op

// Verify: Only one subscription created
const subs = await ctx.db.query("subscriptions").collect();
assert(subs.length === 1);
```

**Edge Case 2: Payment After Expiry (Grace Period)**

```
1. QR expires (30 minutes)
2. User pays 2 minutes after expiry
3. Should still be honored (5-min grace period)
4. Subscription activates
```

**Edge Case 3: User Pays on Different Device**

```
1. User opens QR on laptop
2. Pays via phone (scanning QR)
3. Closes laptop
4. Opens laptop 1 hour later
5. Should show "paid" status
6. Pro access granted
```

**Edge Case 4: Network Failure During Polling**

```
1. QRIS.id API is down
2. Backend should retry
3. Should not crash
4. Should resume when API back
```

**Edge Case 5: Rapid QR Generation**

```
1. User clicks "Get Pro" 5 times rapidly
2. Should only create 1 QR
3. Or cancel old ones
```

**Output**: All edge cases tested

---

### Subtask 1.5.4: Mobile Testing

Verify mobile experience for both flows.

**Test Devices:**
- iPhone (Safari)
- Android (Chrome)
- iPad (Safari)

**Test Checklist:**

**QRIS (Indonesia):**
- [ ] QR code displays clearly
- [ ] Instructions readable
- [ ] Timer visible
- [ ] Can scan QR from phone screen
- [ ] Status updates visible
- [ ] No horizontal scrolling

**Polar (International):**
- [ ] Checkout redirects properly
- [ ] Polar checkout is mobile-responsive
- [ ] Form fields easy to tap
- [ ] Success redirect works

**Output**: Mobile experience verified

---

### Subtask 1.5.5: Soft Launch to Beta Users

Launch to existing 150 users for real-world testing.

**Pre-Launch Checklist:**
- [ ] All tests passing
- [ ] No console errors
- [ ] Analytics tracking enabled
- [ ] Error monitoring active
- [ ] Support channel ready (WhatsApp/Discord)

**Launch Steps:**

1. **Announce to Existing Users:**
```
Subject: Nakafa Pro is here! ðŸš€

Hi [Name],

We're excited to announce Nakafa Pro!

What's included:
âœ… Unlimited AI messages
âœ… All AI models (GPT-4, Claude, Gemini)
âœ… All 2,784 lessons
âœ… Study plans & analytics

Pricing:
ðŸ‡®ðŸ‡© Indonesia: Rp 89.000/month
ðŸŒ International: $8.99/month

Get started: https://nakafa.com/pricing

Questions? Reply to this email or WhatsApp us.

Thanks!
Nakafa Team
```

2. **Monitor Metrics:**
- Daily active users
- Pricing page visits
- Checkout starts
- Successful conversions
- Error rates

3. **Gather Feedback:**
- Send survey after 3 days
- Monitor support requests
- Track common issues

**Success Metrics (Week 1):**
- Target: 10 subscribers
- Conversion rate: > 2%
- Error rate: < 5%

**Output**: Soft launch completed, metrics tracked

---

## ðŸš€ Next Steps

After completing this task:

1. **Analyze Results:** Review week 1 metrics
2. **Iterate:** Fix issues, optimize conversion
3. **Scale:** Increase marketing spend
4. **Next Phase:** Execute Phase 1 GTM (SNBT season)

## ðŸ”— Related Tasks

- Task 1.4: Frontend Checkout (prerequisite)
- Task 1.6: Phase 1 GTM Execution (next)

## âš ï¸ Important Notes

### Testing Checklist

**Must Test Before Launch:**
- [ ] Indonesia flow (QRIS)
- [ ] International flow (Polar)
- [ ] QR expiry handling
- [ ] Page refresh persistence
- [ ] Mobile responsiveness
- [ ] Error states
- [ ] Success redirects
- [ ] Subscription activation

**Nice to Test:**
- [ ] Slow network
- [ ] Offline mode
- [ ] Multiple simultaneous users
- [ ] Different browsers

### Monitoring

**Track These Metrics:**
1. **Conversion Rate:** Visitors â†’ Checkout â†’ Paid
2. **Error Rate:** Failed payments / total attempts
3. **Time to Convert:** First visit â†’ payment
4. **Churn Rate:** Cancellations / total subscribers
5. **Support Tickets:** Issues per 100 users

**Tools:**
- Convex logs for backend errors
- Vercel Analytics for frontend
- Polar dashboard for international payments
- QRIS.id dashboard for Indonesia payments

### Rollback Plan

If critical issues found:
1. Disable checkout buttons
2. Show "Coming soon" message
3. Fix issues
4. Re-test
5. Re-launch

### Progress Tracking

After completing this task, update `plans/gtm-pricing-strategy/progress.txt`:

```txt
[YYYY-MM-DD HH:mm] Task 1.5 completed

Key decisions:
- All payment flows tested end-to-end
- Edge cases handled (expiry, duplicate, refresh)
- Mobile experience verified
- Soft launched to 150 beta users

Test Results:
- Indonesia flow: âœ… Passing
- International flow: âœ… Passing
- Edge cases: âœ… All handled
- Mobile: âœ… Responsive

Metrics (Week 1):
- Subscribers: X
- Conversion rate: X%
- Error rate: X%

Files changed:
- No new files (testing phase)

Blockers/notes:
- [Any issues found]
- Ready for Phase 1 GTM execution
```
