# Task 2.4.2: Run Migrations

## Goal

Run the migrations to copy auth data from component tables to main app tables.

## Prerequisites

- [ ] Task 2.4.1 completed (migrations created)
- [ ] All code migration complete (Tasks 1.1-2.3)
- [ ] Auth schema generated in main app
- [ ] Deployed to target environment

## Steps

### 1. Test Locally First

```bash
# Deploy to local dev
convex dev

# Run migrations locally
convex run migrations:betterAuthDataMigration:runMigrations
```

### 2. Monitor Progress

Check migration status:
```bash
convex run --component migrations lib:getStatus --watch
```

### 3. Verify Data

Check that data was copied:
```bash
# Check users
convex run lib/debug:countTable --args '{"table": "user"}'

# Check API keys
convex run lib/debug:countTable --args '{"table": "apikey"}'
```

### 4. Run in Staging

```bash
# Deploy to staging
convex deploy

# Run migrations in staging
convex run migrations:betterAuthDataMigration:runMigrations

# Verify
convex run lib/debug:countTable --args '{"table": "user"}'
```

### 5. Run in Production

```bash
# Deploy to production
convex deploy --prod

# Run migrations in production
convex run --prod migrations:betterAuthDataMigration:runMigrations

# Monitor
convex run --prod --component migrations lib:getStatus --watch
```

## Troubleshooting

### Migration fails or gets stuck

Cancel and restart:
```bash
convex run --component migrations lib:cancel '{"name": "migrations:betterAuthDataMigration:migrateUsers"}'
```

### Check specific migration status

```bash
convex run --component migrations lib:getStatus
```

## Verification

- [ ] Migrations run successfully in local
- [ ] Data verified in local
- [ ] Migrations run successfully in staging
- [ ] Data verified in staging
- [ ] Migrations run successfully in production
- [ ] Data verified in production

## Next

Task 3.1: Staging Deploy
