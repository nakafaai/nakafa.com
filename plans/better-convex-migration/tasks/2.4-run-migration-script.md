# Task 2.4: Run Data Migration Script (CRITICAL)

## Goal

Run the official migration script from better-convex author to copy component tables to main app.

## Context

This is the **official script** from zbeyens (better-convex author). It:
1. Exports Convex snapshot
2. Converts Better Auth component table IDs to main app table IDs
3. Imports data into main schema

## Prerequisites

- [ ] All code migration complete (Tasks 1.1-2.3)
- [ ] Auth schema generated in main app
- [ ] Deployed to target environment (local/staging/prod)

## Steps

### 1. Export Convex Data

```bash
# For local testing
npx convex export

# For production
npx convex export --prod
```

This creates `snapshot.zip`

### 2. Setup Migration Script

Place these files in `packages/backend/convex/` (or a scripts folder):
- `migrate.ts` (the script from author)
- `migrate-id-conversion.ts` (dependency)
- `migrate-zip.ts` (dependency)

### 3. Run Migration

```bash
cd packages/backend/convex

# Place snapshot.zip in same directory
# Then run:
npx tsx migrate.ts
```

The script will:
- Extract snapshot.zip
- Find Better Auth tables in `_components/betterAuth/`
- Convert table IDs to match main schema
- Create migration.zip
- Run: `npx convex import migration.zip --replace -y`

### 4. Verify Migration

Check that data was copied:
- Users table has data
- API keys preserved
- Organizations/members/invitations copied

## When to Run

**Order is critical:**

1. **Local**: After code migration, before staging
2. **Staging**: After staging deploy
3. **Production**: After production deploy

## Troubleshooting

If table ID mismatch errors:
- Ensure auth schema is generated first
- Ensure schema is deployed to target environment
- Check that table names match between component and main schema

## Next

Task 3.1: Staging Deploy (if doing local)
or
Task 3.2: Production Deploy (if already in prod)
