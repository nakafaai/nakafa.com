# Task 1.4: Create Auth Folder and Generate Schema

## Goal

Create auth folder structure and generate Better Auth schema inside it.

## Steps

### 1. Create Auth Folder Structure

Create `packages/backend/convex/auth/` folder:

```
convex/
  auth/
    schema.ts              # Auth table definitions (generated)
    queries.ts             # Auth-related queries
    mutations.ts           # Auth-related mutations
    utils.ts               # Auth helpers
```

### 2. Ensure auth.ts exports `auth` for CLI

```typescript
// At bottom of packages/backend/convex/auth.ts (already there)
export const auth = betterAuth(createAuthOptions({} as GenericCtx));
```

### 3. Generate Schema in Auth Folder

```bash
cd packages/backend/convex
npx @better-auth/cli generate -y --output auth/schema.ts --config auth.ts
```

This creates `auth/schema.ts` with all Better Auth tables.

### 4. Add Custom Index to Auth Schema

Update `packages/backend/convex/auth/schema.ts`:

```typescript
// Add key index for API key lookups
apikey: defineTable({ ... })
  .index("userId", ["userId"])
  .index("key", ["key"]),  // Add this
```

### 5. Update Root Schema

Update `packages/backend/convex/schema.ts`:

```typescript
import { defineSchema } from "convex/server";
import { tables as authTables } from "./auth/schema";
// ... other imports

export default defineSchema(
  {
    ...authTables,
    ...usersSchema,
    // ... other schemas
  },
  { schemaValidation: true }
);
```

### 6. Create Auth Queries File

Create `packages/backend/convex/auth/queries.ts`:

```typescript
import { query } from "@repo/backend/convex/_generated/server";
import { v } from "convex/values";
import schema from "./schema";
import { doc, nullable } from "convex-helpers/validators";

/**
 * Get Better Auth user by email address.
 */
export const getUserByEmail = query({
  args: { email: v.string() },
  returns: nullable(doc(schema, "user")),
  handler: async (ctx, args) => {
    return await ctx.db
      .query("user")
      .withIndex("email_name", (q) => q.eq("email", args.email))
      .unique();
  },
});

/**
 * Get API keys by user ID.
 */
export const getApiKeysByUserId = query({
  args: { userId: v.id("user") },
  returns: v.array(doc(schema, "apikey")),
  handler: async (ctx, args) => {
    return await ctx.db
      .query("apikey")
      .withIndex("userId", (q) => q.eq("userId", args.userId))
      .collect();
  },
});
```

### 7. Create Auth Utils File

Create `packages/backend/convex/auth/utils.ts`:

```typescript
import { ConvexError } from "convex/values";

/**
 * Validate permissions against required permissions.
 */
export function validatePermissions({
  requiredPerms,
  keyPerms,
}: {
  requiredPerms: string;
  keyPerms: string;
}): { valid: boolean; error?: string } {
  const required = JSON.parse(requiredPerms) as Record<string, string[]>;
  const keyPermissions = JSON.parse(keyPerms) as Record<string, string[]>;

  for (const [resource, actions] of Object.entries(required)) {
    const keyActions = keyPermissions[resource];
    if (!keyActions) {
      return {
        valid: false,
        error: `Missing permissions for resource: ${resource}`,
      };
    }

    for (const action of actions) {
      if (!keyActions.includes(action) && !keyActions.includes("*")) {
        return {
          valid: false,
          error: `Missing permission: ${resource}:${action}`,
        };
      }
    }
  }

  return { valid: true };
}
```

## Verification

- [ ] Auth folder created
- [ ] Schema generated in auth/schema.ts
- [ ] Custom index added to apikey
- [ ] Root schema imports auth tables
- [ ] TypeScript compiles
- [ ] Convex dev starts

## Next

Task 1.5: Move API Key Verification
