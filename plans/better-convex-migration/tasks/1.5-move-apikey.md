# Task 1.5: Move API Key Verification

## Goal

Move verifyApiKey mutation from component to main app.

## Implementation

Create `packages/backend/convex/lib/helpers/apikey.ts`:

```typescript
import { mutation } from "@repo/backend/convex/_generated/server";
import { v } from "convex/values";
import { nullable } from "convex-helpers/validators";

function validatePermissions({ requiredPerms, keyPerms }: { requiredPerms: string; keyPerms: string }) {
  const required = JSON.parse(requiredPerms) as Record<string, string[]>;
  const keyPermissions = JSON.parse(keyPerms) as Record<string, string[]>;

  for (const [resource, actions] of Object.entries(required)) {
    const keyActions = keyPermissions[resource];
    if (!keyActions) return { valid: false, error: `Missing permissions for resource: ${resource}` };
    for (const action of actions) {
      if (!keyActions.includes(action) && !keyActions.includes("*")) {
        return { valid: false, error: `Missing permission: ${resource}:${action}` };
      }
    }
  }
  return { valid: true };
}

export const verifyApiKey = mutation({
  args: {
    key: v.string(),
    permissions: v.optional(v.string()),
  },
  returns: v.object({
    valid: v.boolean(),
    userId: nullable(v.string()),
    error: nullable(v.object({ message: v.string(), code: v.string() })),
  }),
  handler: async (ctx, args) => {
    const apiKey = await ctx.db.query("apikey").withIndex("key", (q) => q.eq("key", args.key)).unique();

    if (!apiKey) return { valid: false, userId: null, error: { message: "Invalid API key", code: "INVALID_KEY" } };

    const now = Date.now();

    if (apiKey.enabled !== true) return { valid: false, userId: null, error: { message: "API key is disabled", code: "KEY_DISABLED" } };
    if (apiKey.expiresAt && apiKey.expiresAt < now) return { valid: false, userId: null, error: { message: "API key has expired", code: "KEY_EXPIRED" } };

    let currentRemaining = apiKey.remaining ?? null;
    if (apiKey.refillInterval && apiKey.refillAmount && apiKey.lastRefillAt) {
      const timeSinceRefill = now - apiKey.lastRefillAt;
      const refillsDue = Math.floor(timeSinceRefill / apiKey.refillInterval);
      if (refillsDue > 0) {
        currentRemaining = (currentRemaining ?? 0) + refillsDue * apiKey.refillAmount;
        await ctx.db.patch("apikey", apiKey._id, {
          remaining: currentRemaining,
          lastRefillAt: apiKey.lastRefillAt + refillsDue * apiKey.refillInterval,
        });
      }
    }

    if (currentRemaining !== null && currentRemaining <= 0) {
      return { valid: false, userId: null, error: { message: "API key has no remaining requests", code: "NO_REMAINING_REQUESTS" } };
    }

    if (apiKey.rateLimitEnabled && apiKey.rateLimitTimeWindow && apiKey.rateLimitMax) {
      const lastRequest = apiKey.lastRequest ?? 0;
      const requestCount = apiKey.requestCount ?? 0;
      if (now - lastRequest > apiKey.rateLimitTimeWindow) {
        await ctx.db.patch("apikey", apiKey._id, { requestCount: 1, lastRequest: now });
      } else if (requestCount >= apiKey.rateLimitMax) {
        return { valid: false, userId: null, error: { message: "Rate limit exceeded", code: "RATE_LIMIT_EXCEEDED" } };
      } else {
        await ctx.db.patch("apikey", apiKey._id, { requestCount: requestCount + 1, lastRequest: now });
      }
    } else {
      await ctx.db.patch("apikey", apiKey._id, { lastRequest: now });
    }

    if (currentRemaining !== null) await ctx.db.patch("apikey", apiKey._id, { remaining: currentRemaining - 1 });

    if (args.permissions && apiKey.permissions) {
      const permResult = validatePermissions({ requiredPerms: args.permissions, keyPerms: apiKey.permissions });
      if (!permResult.valid) return { valid: false, userId: null, error: { message: permResult.error ?? "Insufficient permissions", code: "INSUFFICIENT_PERMISSIONS" } };
    }

    return { valid: true, userId: apiKey.userId, error: null };
  },
});
```

## Update Imports

Find and update files importing verifyApiKey:
```typescript
// Before:
import { verifyApiKey } from "@repo/backend/convex/betterAuth/mutations";

// After:
import { verifyApiKey } from "@repo/backend/convex/lib/helpers/apikey";
```

## Verification

- [ ] Mutation moved
- [ ] Imports updated
- [ ] TypeScript compiles

## Next

Task 1.6: Remove Component Config
