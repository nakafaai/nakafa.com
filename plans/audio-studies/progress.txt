# Audio Studies Implementation Progress

## Overview
Implementation plan for Audio Studies feature - AI-generated podcast audio for educational content.

## Tasks

### Setup Phase (0.x) ✅ COMPLETE
- [x] **0.1-voice-config.md** - Voice configuration (Nina voice with ElevenLabs API docs)
- [x] **0.2-schema.md** - Database schema (contentAudios, userContentAudios)
- [x] **0.3-article-queries.md** - Add getById to articleContents
- [x] **0.4-subject-queries.md** - Add getById to subjectSections

### Core Implementation Phase (1.x)
- [x] **1.1-create-actions.md** - AI actions (script + speech generation)
- [x] **1.2-create-queries.md** - Internal queries only (only what's needed)
- [x] **1.3-create-mutations.md** - Mutations with workflow integration
- [ ] **1.4-create-workflow.md** - Durable workflow orchestration

### Integration Phase (2.x)
- [ ] **2.1-integrate-content-sync.md** - Content update invalidation

## Current Status
- Phase 0: 4/4 tasks completed ✅
- Phase 1: 3/4 tasks completed ⏳
- Phase 2: 0/1 tasks completed

## Completed Setup Phase

### ✅ Task 0.1: Voice configuration
- File: `packages/ai/config/voices.ts`
- Features: Nina voice (free plan limitation)
- Documentation includes all voice settings from official ElevenLabs API
- Helper functions: `getVoiceConfig()`, `isValidVoiceKey()`

### ✅ Task 0.2: Database schema
- File: `packages/backend/convex/audioStudies/schema.ts`
- Tables: contentAudios, userContentAudios
- Proper indexes for efficient queries
- Uses convex-helpers `literals()` for contentType
- Uses `v.optional()` for fields that don't exist until generated
- Uses shared validators from contentValidators
- Updated main schema.ts with import
- Typecheck: ✅ Passing

### ✅ Task 0.3 & 0.4: Content queries
- Files: 
  - `packages/backend/convex/articleContents/queries.ts`
  - `packages/backend/convex/subjectSections/queries.ts`
- Both use convex-helpers validators:
  - `vv.id()` for type-safe table IDs
  - `nullable()` for union with null return types
- Uses shared `localeValidator` from contentValidators
- No explicit handler return types - Convex infers automatically
- Typecheck: ✅ Passing

## Completed Core Phase

### ✅ Task 1.1: AI Actions
- File: `packages/backend/convex/audioStudies/actions.ts`
- Two internal actions:
  - `generateScript` - Uses Gemini to create podcast script with ElevenLabs V3 tags
  - `generateSpeech` - Uses ElevenLabs V3 to generate audio from script
- Prompt file: `packages/ai/prompt/audio-studies.ts`
  - Uses `createPrompt` utility
  - Optimized for ElevenLabs V3 audio tags ([curious], [excited], etc.)
  - Supports multiple languages via `LANGUAGE_GUIDELINES` record
  - Dynamic script length based on content coverage
- Proper error handling with `ConvexError`
- Types reused from schema (`ContentId`, `ContentType`)
- Exported validators from schema for reuse
- Type assertions required for branded ID types (TypeScript limitation)

### ✅ Task 1.2: Queries (Internal Only)
- File: `packages/backend/convex/audioStudies/queries.ts`
- **Only created internal queries actually used by actions:**
  - `getById` - Used by `generateScript` action
  - `getWithScriptById` - Used by `generateSpeech` action
- **NO speculative public queries** (getStatusById, getListeningHistory)
  - Will add public queries when UI is built
- Reuses `voiceSettingsValidator` from shared validators
- Follows convex-helpers patterns

### ✅ Task 1.3: Mutations (Internal Only)
- File: `packages/backend/convex/audioStudies/mutations.ts`
- **Only created mutations actually used by actions:**
  - `updateStatus` - Update generation status (used by both actions)
  - `saveScript` - Save generated script, mark completed
  - `saveAudio` - Save audio metadata, mark completed
  - `markFailed` - Mark generation as failed with error message
- All mutations are `internalMutation` (only callable from Convex)
- Table names explicitly included in `ctx.db.get()` and `ctx.db.patch()`
- Uses `ConvexError` for proper error handling
- Timestamps updated on every mutation
- Error handling helper moved to shared utils:
  - `getErrorMessage()` in `packages/backend/convex/utils/helper.ts`
  - Extracts `data.message` from `ConvexError`, falls back to `error.message`

## Convex-Helpers Patterns Used

### In Schemas:
```typescript
// Use literals() for string unions
import { literals } from "convex-helpers/validators";
contentType: literals("article", "subject")

// Use v.optional() for unset fields (not nullable)
script: v.optional(v.string())
```

### In Functions:
```typescript
// Use vv.id() for type-safe table references
import { vv } from "@repo/backend/convex/lib/validators";
args: { id: vv.id("articleContents") }

// Use nullable() for return types
import { nullable } from "convex-helpers/validators";
returns: nullable(v.object({...}))

// No explicit handler return type - let Convex infer
handler: async (ctx, args) => { ... }
```

## Next Task
**Task 1.4: Create Workflow**
- File: `packages/backend/convex/audioStudies/workflows.ts`
- Orchestrate the generation pipeline:
  1. Create audio record (pending status)
  2. Trigger script generation action
  3. Trigger speech generation action
  4. Handle errors and retries
- Use Convex durable workflows for reliability

## Commands
```bash
pnpm --filter @repo/backend typecheck
```
