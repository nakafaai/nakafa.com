# Task 1.4: Create Audio Studies Workflow

## Goal
Create durable workflow for audio generation pipeline using Convex Workflow component.

## File
`packages/backend/convex/audioStudies/workflows.ts`

## Implementation

```typescript
import { workflow } from "@repo/backend/convex/workflow";
import { internal } from "@repo/backend/convex/_generated/api";
import { v } from "convex/values";
import { vv } from "@repo/backend/convex/lib/validators";

/**
 * Durable workflow for audio generation.
 * This workflow orchestrates the pipeline:
 * 1. Generate script using AI
 * 2. Generate speech using ElevenLabs
 * 
 * Benefits of using workflow:
 * - Survives server restarts
 * - Automatic retries on failure
 * - Can be monitored and cancelled
 * - Guaranteed execution
 */
export const generateAudio = workflow.define({
  args: {
    contentAudioId: vv.id("contentAudios"),
  },
  returns: v.null(),
  handler: async (step, args) => {
    // Step 1: Generate script
    await step.runAction(internal.audioStudies.actions.generateScript, {
      contentAudioId: args.contentAudioId,
    });
    
    // Step 2: Generate speech (only runs after script is saved)
    await step.runAction(internal.audioStudies.actions.generateSpeech, {
      contentAudioId: args.contentAudioId,
    });
    
    return null;
  },
});
```

## Usage

From a mutation, start the workflow:

```typescript
import { workflow } from "@repo/backend/convex/workflow";
import { internal } from "@repo/backend/convex/_generated/api";

// In your mutation handler:
const workflowId = await workflow.start(
  ctx,
  internal.audioStudies.workflows.generateAudio,
  { contentAudioId: id }
);
```

## Benefits

- **Durability**: Workflow survives server crashes and restarts
- **Retries**: Automatic retry on transient failures
- **Observability**: Can query workflow status
- **Cancellation**: Can cancel long-running workflows
- **Exactly-once**: Guaranteed execution semantics

## Commands
```bash
pnpm typecheck
```

## Resources
- https://www.convex.dev/components/workflow
- https://github.com/get-convex/workflow
