# Task 0.3: Generate Voice Preview Samples

## üéØ Goal

Generate and store 5-second audio samples for each predefined voice to enable voice preview in the UI.

## üìç Context

Users should hear a sample of each voice before selecting. Static samples are better than dynamic generation because they're instant, zero-cost after initial generation, and consistent.

## PRD

```json
{
  "category": "integration",
  "description": "Generate 5-second preview samples for all 5 voices and store in Convex storage",
  "steps": [
    "Create script generation action for samples using internalAction",
    "Create speech generation action for samples",
    "Generate samples for all 5 voices",
    "Store sample storage IDs in voice config",
    "Create query to fetch sample URLs"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] Script exists to generate voice samples (internalAction, not client-callable)
- [ ] 5 audio files stored in Convex storage (one per voice)
- [ ] Sample metadata stored in voice config
- [ ] Query endpoint to get sample URLs
- [ ] Samples are 5-10 seconds long

## Commands

```bash
pnpm typecheck
pnpm lint
```

## üìù Subtasks

### Subtask 0.3.1: Create Sample Generation Script

**File to create**: `packages/backend/convex/audioStudies/generateSamples.ts` (one-time script)

**Implementation**:

```typescript
/**
 * One-time script to generate voice preview samples.
 * Run manually: npx convex run audioStudies/generateSamples:generateVoiceSamples
 */

import { internalAction } from "@repo/backend/convex/functions";
import { v } from "convex/values";
import { generateSpeech } from "ai";
import { elevenlabs } from "@repo/ai/config/elevenlabs";
import { PREDEFINED_VOICES, type VoiceKey } from "@repo/ai/config/voices";

const SAMPLE_SCRIPT =
  "Hi, I'm your Nakafa narrator. I'll guide you through your audio study today, making learning engaging and accessible.";

/**
 * Generate voice samples for all predefined voices.
 * This is an internal action - not exposed to clients.
 * Run manually from CLI: npx convex run audioStudies/generateSamples:generateVoiceSamples
 */
export const generateVoiceSamples = internalAction({
  args: {},
  returns: v.record(v.string(), v.string()),
  handler: async (ctx) => {
    const results: Record<VoiceKey, string> = {};

    for (const [key, voice] of Object.entries(PREDEFINED_VOICES)) {
      console.log(`Generating sample for ${key}...`);

      const result = await generateSpeech({
        model: elevenlabs.speech("eleven_multilingual_v2"),
        text: SAMPLE_SCRIPT,
        voice: voice.id,
        providerOptions: {
          elevenlabs: {
            voiceSettings: voice.settings,
          },
        },
      });

      // Store in Convex storage
      const storageId = await ctx.storage.store(result.audio);
      results[key as VoiceKey] = storageId;

      console.log(`Generated sample for ${key}: ${storageId}`);
    }

    console.log("Voice sample storage IDs:");
    console.log(JSON.stringify(results, null, 2));

    return results;
  },
});
```

**Output**: Internal action that generates and stores voice samples.

**Important**: This uses `internalAction` (not `action`) because:
- It's a one-time setup script
- Should not be callable from client
- Only run via CLI or dashboard

### Subtask 0.3.2: Update Voice Config with Sample IDs

**File to modify**: `packages/ai/config/voices.ts`

**Implementation**:

Add to VoiceConfig interface and PREDEFINED_VOICES after generating samples:

```typescript
export interface VoiceConfig {
  id: string;
  name: string;
  description: string;
  settings: {
    stability: number;
    similarityBoost: number;
    style?: number;
  };
  // Add after generating samples
  sampleStorageId?: string; // Convex storage ID for preview
}

// After running generateVoiceSamples, update with actual storage IDs:
export const PREDEFINED_VOICES = {
  nina: {
    id: "21m00Tcm4TlvDq8ikWAM",
    name: "Nina",
    description: "Clear and educational, perfect for learning",
    settings: { ... },
    sampleStorageId: "k5a...", // Add after generation
  },
  // ... other voices
};
```

**Output**: Voice config includes sample storage references.

### Subtask 0.3.3: Create Query for Sample URLs

**File to create**: `packages/backend/convex/audioStudies/queries.ts`

**Implementation**:

```typescript
import { query } from "@repo/backend/convex/functions";
import { v } from "convex/values";
import { PREDEFINED_VOICES, type VoiceKey } from "@repo/ai/config/voices";

/**
 * Get voice preview sample URLs
 * Called by UI to show voice selector with playable samples
 */
export const getVoiceSamples = query({
  args: {},
  returns: v.array(
    v.object({
      key: v.string(),
      name: v.string(),
      description: v.string(),
      sampleUrl: v.optional(v.string()),
    })
  ),
  handler: async (ctx) => {
    const samples = await Promise.all(
      Object.entries(PREDEFINED_VOICES).map(async ([key, voice]) => {
        let sampleUrl: string | undefined;

        if (voice.sampleStorageId) {
          sampleUrl = await ctx.storage.getUrl(voice.sampleStorageId);
        }

        return {
          key,
          name: voice.name,
          description: voice.description,
          sampleUrl,
        };
      })
    );

    return samples;
  },
});
```

**Output**: Query endpoint returns voice options with playable sample URLs.

---

## üöÄ Next Steps

After this task:
- Next: Task 1.1 (Create script generation action)
- Dependencies: Task 0.1 (voice config)

## üîó Related Tasks

- Task 3.2: UI calls getVoiceSamples to show voice selector

## ‚ö†Ô∏è Important Notes

### Running the Generator

This is a one-time setup task. After deploying:

```bash
# Generate samples
npx convex run audioStudies/generateSamples:generateVoiceSamples

# Copy the output storage IDs into voices.ts
# Redeploy to update the config
```

### Why internalAction?

The `generateVoiceSamples` function uses `internalAction` (not `action`) because:
- It's an admin/one-time operation
- Should not be exposed to client applications
- Costs money (ElevenLabs API calls)
- Only run manually by developers

### Sample Script

Keep it consistent across all voices so users can compare voice characteristics, not content differences.

### Storage Costs

5 samples √ó ~100KB each = negligible storage cost. Much cheaper than generating on-demand.
