# Task 6.1: Test Audio Generation Flow

## üéØ Goal

Test the complete audio generation workflow from request to playback.

## üìç Context

Verify the entire pipeline works: request ‚Üí check cache ‚Üí start workflow ‚Üí generate script ‚Üí generate speech ‚Üí store ‚Üí playback.

## PRD

```json
{
  "category": "testing",
  "description": "Test end-to-end audio generation flow",
  "steps": [
    "Test requestAudio with new content (triggers generation)",
    "Test requestAudio with cached content (returns immediately)",
    "Test getAudioStatus polling",
    "Verify audio file is stored correctly",
    "Test getAudioUrl returns playable URL",
    "Test error handling (invalid content, non-Pro user)"
  ],
  "passes": false
}
```

## üé¨ Success Criteria

- [ ] New content triggers workflow and returns "generating" status
- [ ] Cached content returns immediately with audioUrl
- [ ] Polling reflects status progression (pending ‚Üí scripting ‚Üí speech ‚Üí completed)
- [ ] Audio file stored in Convex storage with correct metadata
- [ ] Audio URL is playable (valid signed URL)
- [ ] Non-Pro users get FORBIDDEN error
- [ ] Invalid contentId returns NOT_FOUND error

## Commands

```bash
# Run typecheck
pnpm typecheck

# Run lint
pnpm lint

# Run tests
pnpm test

# Manual testing
npx convex dev
```

## üìù Subtasks

### Subtask 6.1.1: Create Test Script

**File to create**: `packages/backend/convex/audioStudies/__tests__/audioGeneration.test.ts`

**Implementation**:

```typescript
import { describe, it, expect, beforeEach } from "vitest";
import { convexTest } from "convex-test";
import schema from "../../schema";
import { api, internal } from "../_generated/api";

describe("Audio Generation Flow", () => {
  const test = convexTest(schema);

  beforeEach(async () => {
    // Setup: Create test user with Pro subscription
    // Setup: Create test article
  });

  it("should generate audio for new content", async () => {
    // Test requestAudio for new content
    // Verify status is "generating"
    // Verify contentAudios record created with pending status
  });

  it("should return cached audio for existing content", async () => {
    // First request (generates)
    // Second request (should return cached)
    // Verify status is "cached"
    // Verify audioUrl returned
  });

  it("should poll status progression", async () => {
    // Start generation
    // Poll getAudioStatus
    // Verify status transitions correctly
  });

  it("should reject non-Pro users", async () => {
    // Test with user without Pro subscription
    // Verify FORBIDDEN error
  });
});
```

**Output**: Test suite covering main scenarios.

### Subtask 6.1.2: Manual Testing Checklist

**Test Cases**:

```markdown
## Manual Testing Checklist

### Basic Flow
- [ ] Pro user requests audio for article
- [ ] UI shows "Generating audio..." message
- [ ] Polls status every 5 seconds
- [ ] After ~30 seconds, audio is ready
- [ ] Audio plays successfully
- [ ] Second request for same article returns immediately (cached)

### Voice Selection
- [ ] User can select different voices
- [ ] Each voice generates separate audio
- [ ] Voice samples play correctly in selector

### Error Handling
- [ ] Non-Pro user sees upgrade prompt
- [ ] Invalid content shows error
- [ ] Failed generation shows retry option

### Content Updates
- [ ] Update article MDX content
- [ ] Run content sync
- [ ] Request audio again
- [ ] Should regenerate (new contentHash)
```

**Output**: Manual testing checklist.

---

## üöÄ Next Steps

After this task:
- Next: Task 6.2 (Test cache invalidation)
- Dependencies: Tasks 1-5 complete

## üîó Related Tasks

- Task 6.2: Testing invalidation specifically

## ‚ö†Ô∏è Important Notes

### Testing Strategy

Combine unit tests (convex-test) and manual testing:
- Unit tests for logic and mutations
- Manual tests for workflow and ElevenLabs integration
- ElevenLabs calls can't be easily mocked, so workflow tests may need to be manual

### ElevenLabs Costs

Each test generation costs ~$0.01-0.02:
- Limit test generations
- Use short content for tests
- Consider mock for CI/CD (future)
